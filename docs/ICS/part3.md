# System IO

## Unix I/O

Unix I/O æ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸æä¾›çš„ä¸€ç»„ç”¨äºè¾“å…¥è¾“å‡ºçš„ä½çº§ç³»ç»Ÿè°ƒç”¨æ¥å£ã€‚

**æ ¸å¿ƒæ¦‚å¿µ**

- **æ–‡ä»¶å³å­—èŠ‚åºåˆ—**ï¼šLinux æ–‡ä»¶ä»…ä»…æ˜¯ $m$ ä¸ªå­—èŠ‚çš„åºåˆ— ($B_0, B_1, ..., B_m$)ã€‚
- **ä¸‡ç‰©çš†æ–‡ä»¶**ï¼šæ‰€æœ‰çš„ I/O è®¾å¤‡éƒ½è¢«æ¨¡å‹åŒ–ä¸ºæ–‡ä»¶ï¼ŒåŒ…æ‹¬ï¼š
  - ç½‘ç»œã€ç£ç›˜åˆ†åŒº (`/dev/sda2`)
  - ç»ˆç«¯ (`/dev/tty2`)
  - ç”šè‡³å†…æ ¸æ•°æ®ç»“æ„ (`/proc`)
- **ç»Ÿä¸€æ¥å£**ï¼šè¿™ç§ä¼˜é›…çš„æ˜ å°„å…è®¸å†…æ ¸å¯¼å‡ºä¸€ä¸ªç®€å•çš„ Unix I/O æ¥å£æ¥å¤„ç†æ‰€æœ‰è®¾å¤‡ï¼š
  - æ‰“å¼€ (`open`) / å…³é—­ (`close`)
  - è¯» (`read`) / å†™ (`write`)
  - æ”¹å˜å½“å‰æ–‡ä»¶ä½ç½® (`lseek`)

## æ–‡ä»¶ç±»å‹ä¸ç›®å½•å±‚æ¬¡

#### æ–‡ä»¶ç±»å‹

1. **æ™®é€šæ–‡ä»¶ (Regular file)**ï¼šåŒ…å«ä»»æ„æ•°æ®ã€‚
    - **æ–‡æœ¬æ–‡ä»¶**ï¼šåªåŒ…å« ASCII æˆ– Unicode å­—ç¬¦ã€‚
      - Linux/Mac æ¢è¡Œç¬¦ï¼š`\n` (0xa, LF)
      - Windows/ç½‘ç»œåè®®æ¢è¡Œç¬¦ï¼š`\r\n` (0xd 0xa, CR+LF)
    - **äºŒè¿›åˆ¶æ–‡ä»¶**ï¼šé™¤æ–‡æœ¬æ–‡ä»¶å¤–çš„æ‰€æœ‰æ–‡ä»¶ï¼ˆå¦‚ç›®æ ‡æ–‡ä»¶ã€JPEGï¼‰ã€‚
    - _æ³¨æ„_ï¼šå†…æ ¸ä¸åŒºåˆ†æ–‡æœ¬å’ŒäºŒè¿›åˆ¶ï¼Œè¿™æ˜¯åº”ç”¨ç¨‹åºå±‚é¢çš„åŒºåˆ†ã€‚
2. **ç›®å½• (Directory)**ï¼šåŒ…å«ä¸€ç»„é“¾æ¥çš„æ–‡ä»¶ç´¢å¼•ã€‚
3. **å¥—æ¥å­— (Socket)**ï¼šç”¨äºè·¨æœºå™¨è¿›ç¨‹é€šä¿¡ã€‚
4. **å…¶ä»–**ï¼šå‘½åç®¡é“ (FIFOs)ã€ç¬¦å·é“¾æ¥ã€å­—ç¬¦/å—è®¾å¤‡ã€‚

#### ç›®å½•æ“ä½œ

- **ç»“æ„**ï¼šç›®å½•ä¹Ÿæ˜¯æ–‡ä»¶ï¼ŒåŒ…å«é“¾æ¥æ•°ç»„ã€‚
  - `.` (dot)ï¼šé“¾æ¥åˆ°å½“å‰ç›®å½•ã€‚
  - `..` (dot dot)ï¼šé“¾æ¥åˆ°çˆ¶ç›®å½•ã€‚
- **è·¯å¾„å**ï¼š
  - **ç»å¯¹è·¯å¾„**ï¼šä»¥ `/` å¼€å¤´ï¼ˆå¦‚ `/home/droh/hello.c`ï¼‰ã€‚
  - **ç›¸å¯¹è·¯å¾„**ï¼šç›¸å¯¹äºå½“å‰å·¥ä½œç›®å½• (cwd)ã€‚
- **API**ï¼š`opendir`, `readdir`, `closedir`ã€‚å»ºè®®åªä½¿ç”¨è¿™äº›å‡½æ•°è¯»å–ç›®å½•æ¡ç›®ï¼Œä¸è¦ç›´æ¥å†™å…¥ã€‚

## Unix I/O

#### æ‰“å¼€ä¸å…³é—­æ–‡ä»¶

- **`open()`**ï¼šå°†æ–‡ä»¶åè½¬æ¢ä¸ºæ–‡ä»¶æè¿°ç¬¦ (File Descriptor, fd)ã€‚
  - è¿”å›ä¸€ä¸ªå°çš„æ•´æ•° fdï¼Œè‹¥å‡ºé”™è¿”å› -1ã€‚
  - **æ ‡å‡†æ–‡ä»¶æè¿°ç¬¦**ï¼š
    - 0: æ ‡å‡†è¾“å…¥ (stdin)
    - 1: æ ‡å‡†è¾“å‡º (stdout)
    - 2: æ ‡å‡†é”™è¯¯ (stderr)
- **`close()`**ï¼šé€šçŸ¥å†…æ ¸ç»“æŸè®¿é—®ã€‚
  - _é‡è¦_ï¼šå¿…é¡»æ£€æŸ¥è¿”å›å€¼ï¼Œå³ä½¿æ˜¯ `close()` ä¹Ÿå¯èƒ½å‡ºé”™ï¼ˆå°¤å…¶æ˜¯åœ¨å¤šçº¿ç¨‹ç¨‹åºä¸­ï¼‰ã€‚

#### è¯»å†™æ–‡ä»¶

- **`read(fd, buf, sizeof(buf))`**ï¼šä»å½“å‰æ–‡ä»¶ä½ç½®å¤åˆ¶å­—èŠ‚åˆ°å†…å­˜ï¼Œå¹¶æ›´æ–°æ–‡ä»¶ä½ç½®ã€‚
  - è¿”å›è¯»å–çš„å­—èŠ‚æ•° (`ssize_t`)ã€‚
  - è‹¥è¿”å› 0ï¼Œè¡¨ç¤ºé‡åˆ° EOF (End of File)ã€‚
  - è‹¥è¿”å› -1ï¼Œè¡¨ç¤ºå‡ºé”™ã€‚
- **`write(fd, buf, sizeof(buf))`**ï¼šä»å†…å­˜å¤åˆ¶å­—èŠ‚åˆ°æ–‡ä»¶å½“å‰ä½ç½®ï¼Œå¹¶æ›´æ–°ä½ç½®ã€‚

> [!note]
>
> æ›´æ–°æ–‡ä»¶ä½ç½®æŒ‡çš„æ˜¯**å½“å‰æ–‡ä»¶åç§»é‡â€ (Current File Offset)**
>
> å½“è°ƒç”¨ `read` æˆ– `write` æ—¶ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸ï¼ˆKernelï¼‰ä¼šåœ¨ä¸è¯¥æ–‡ä»¶æè¿°ç¬¦ (`fd`) å…³è”çš„**æ‰“å¼€æ–‡ä»¶æè¿°ï¼ˆOpen File Descriptionï¼‰**è¡¨æ ¼ä¸­ç»´æŠ¤ä¸€ä¸ªåç§»é‡ã€‚
>
> - **åˆå§‹çŠ¶æ€ï¼š** æ‰“å¼€æ–‡ä»¶æ—¶ï¼ˆé™¤éä½¿ç”¨äº† `O_APPEND`ï¼‰ï¼Œåç§»é‡é€šå¸¸ä¸º 0ã€‚
> - **è‡ªåŠ¨ç´¯åŠ ï¼š**
>   - å¦‚æœä½ æ‰§è¡Œ `read(fd, buf, 100)` å¹¶æˆåŠŸè¯»å–äº† 100 å­—èŠ‚ï¼Œå†…æ ¸ä¼šè‡ªåŠ¨å°†è¯¥åç§»é‡åŠ  100ã€‚
>   - ä¸‹ä¸€æ¬¡è°ƒç”¨ `read` æˆ– `write` æ—¶ï¼Œæ“ä½œå°†ä»ç¬¬ 101 ä¸ªå­—èŠ‚å¼€å§‹ã€‚
> - **åŸå­æ€§ï¼š** è¿™ä¸ªæ›´æ–°è¿‡ç¨‹æ˜¯ç”±å†…æ ¸ç®¡ç†çš„ï¼Œå¯¹äºè°ƒç”¨è€…æ¥è¯´æ˜¯é€æ˜ä¸”è‡ªåŠ¨çš„ã€‚

#### çŸ­è®¡æ•°å€¼

å³**è¯»å†™çš„å­—èŠ‚æ•°å°äºè¯·æ±‚çš„å­—èŠ‚æ•°** ã€‚

- **å¯èƒ½å‘ç”Ÿçš„æƒ…å†µ**ï¼š
  1. è¯»æ“ä½œé‡åˆ° EOFã€‚
  2. ä»ç»ˆç«¯è¯»å–æ–‡æœ¬è¡Œã€‚
  3. è¯»å†™ç½‘ç»œå¥—æ¥å­— (Network Sockets)ã€‚
- **ç»ä¸ä¼šå‘ç”Ÿçš„æƒ…å†µ**ï¼š
  1. è¯»ç£ç›˜æ–‡ä»¶ï¼ˆé™¤éé‡åˆ° EOFï¼‰ã€‚
  2. å†™ç£ç›˜æ–‡ä»¶ã€‚
- **æœ€ä½³å®è·µ**ï¼šç¼–å†™ä»£ç æ—¶å§‹ç»ˆè¦å¤„ç†çŸ­è®¡æ•°å€¼ï¼Œç‰¹åˆ«æ˜¯åœ¨ç½‘ç»œç¼–ç¨‹ä¸­ã€‚

## æ–‡ä»¶å…ƒæ•°æ®ä¸å…±äº«

#### Metadata

`struct stat` æ˜¯å†…æ ¸å‘ç”¨æˆ·ç¨‹åºä¼ é€’æ–‡ä»¶å±æ€§çš„æ ‡å‡†å®¹å™¨ã€‚è™½ç„¶ä¸åŒæ¶æ„çš„å…·ä½“å®šä¹‰ç•¥æœ‰ä¸åŒï¼Œä½† POSIX æ ‡å‡†å®šä¹‰äº†ä»¥ä¸‹æ ¸å¿ƒå­—æ®µã€‚

| å­—æ®µç±»å‹    | å­—æ®µå           | æè¿°                      | å…³é”®ç”¨é€”                                                |
| :---------- | :--------------- | :------------------------ | :------------------------------------------------------ |
| `dev_t`     | **`st_dev`**     | åŒ…å«è¯¥æ–‡ä»¶çš„è®¾å¤‡ ID       | è¯†åˆ«æ–‡ä»¶å­˜å‚¨åœ¨å“ªä¸ªç‰©ç†/é€»è¾‘è®¾å¤‡ä¸Š                       |
| `ino_t`     | **`st_ino`**     | Inode ç¼–å·                | **æ–‡ä»¶çš„å”¯ä¸€æ ‡è¯†** (åœ¨åŒä¸€è®¾å¤‡å†…)                       |
| `mode_t`    | **`st_mode`**    | **æ–‡ä»¶ç±»å‹ä¸æƒé™**        | è¿™æ˜¯ä¸€ä¸ªä½æ©ç ï¼ˆBitmaskï¼‰ï¼Œéå¸¸é‡è¦                     |
| `nlink_t`   | **`st_nlink`**   | ç¡¬é“¾æ¥è®¡æ•°                | åªæœ‰å½“æ­¤å€¼ä¸º 0 æ—¶ï¼Œæ–‡ä»¶æ•°æ®å—æ‰ä¼šè¢«é‡Šæ”¾                 |
| `uid_t`     | **`st_uid`**     | æ‰€æœ‰è€…ç”¨æˆ· ID             | æƒé™æ£€æŸ¥ä¾æ®                                            |
| `gid_t`     | **`st_gid`**     | æ‰€æœ‰è€…ç»„ ID               | æƒé™æ£€æŸ¥ä¾æ®                                            |
| `off_t`     | **`st_size`**    | æ–‡ä»¶å¤§å° (å­—èŠ‚)           | **ä»…å¯¹æ™®é€šæ–‡ä»¶æœ‰æ•ˆ**ï¼›ç¬¦å·é“¾æ¥åˆ™æ˜¯è·¯å¾„é•¿åº¦              |
| `blksize_t` | **`st_blksize`** | æ–‡ä»¶ç³»ç»Ÿ I/O çš„æœ€ä½³å—å¤§å° | ç”¨äºä¼˜åŒ–è¯»å†™ç¼“å†²åŒºå¤§å°                                  |
| `blkcnt_t`  | **`st_blocks`**  | åˆ†é…çš„ 512B å—æ•°é‡        | **å®é™…ç£ç›˜å ç”¨** (å¯èƒ½å¤§äºæˆ–å°äº `st_size`ï¼Œå¦‚ç¨€ç–æ–‡ä»¶) |
| `time_t`    | **`st_atime`**   | æœ€åè®¿é—®æ—¶é—´ (Access)     | æœ€è¿‘ä¸€æ¬¡ `read` çš„æ—¶é—´                                  |
| `time_t`    | **`st_mtime`**   | æœ€åä¿®æ”¹æ—¶é—´ (Modify)     | æœ€è¿‘ä¸€æ¬¡æ–‡ä»¶**å†…å®¹**è¢«å†™å…¥çš„æ—¶é—´                        |
| `time_t`    | **`st_ctime`**   | æœ€åçŠ¶æ€æ”¹å˜æ—¶é—´ (Change) | æœ€è¿‘ä¸€æ¬¡ **å…ƒæ•°æ®** (å¦‚æƒé™ã€æ‰€æœ‰è€…) æ”¹å˜çš„æ—¶é—´         |

`st_mode` æ˜¯ä¸€ä¸ª 16 ä½çš„ä½å›¾ï¼Œå®ƒæ··åˆå­˜å‚¨äº†**æ–‡ä»¶ç±»å‹**å’Œ**è®¿é—®æƒé™**ã€‚ä¸è¦ç›´æ¥æ¯”è¾ƒå®ƒçš„å€¼ï¼Œè€Œåº”è¯¥ä½¿ç”¨ç³»ç»Ÿæä¾›çš„å®ã€‚

**1. åˆ¤æ–­æ–‡ä»¶ç±»å‹ï¼ˆé«˜ 7 ä½ï¼‰ï¼š**
ä½¿ç”¨å® `S_ISxxx(m)` è¿›è¡Œåˆ¤æ–­ï¼š

- `S_ISREG(st.st_mode)`: æ˜¯å¦ä¸ºæ™®é€šæ–‡ä»¶ (-)
- `S_ISDIR(st.st_mode)`: æ˜¯å¦ä¸ºç›®å½• (d)
- `S_ISLNK(st.st_mode)`: æ˜¯å¦ä¸ºç¬¦å·é“¾æ¥ (l)
- `S_ISSOCK(st.st_mode)`: æ˜¯å¦ä¸ºå¥—æ¥å­— (s)

**2. åˆ¤æ–­æƒé™ï¼ˆä½ 9 ä½ï¼‰ï¼š**
å¯¹åº” `rwx` (è¯»/å†™/æ‰§è¡Œ) å¯¹äº User, Group, Others çš„æƒé™ä½ã€‚ä¾‹å¦‚ `S_IRUSR` (ç”¨æˆ·è¯»), `S_IWGRP` (ç»„å†™) ç­‰ã€‚

> **æ³¨æ„ `mtime` vs `ctime`ï¼š**
>
> - ä¿®æ”¹æ–‡ä»¶å†…å®¹ï¼ˆ`write`ï¼‰ä¼šåŒæ—¶æ›´æ–° `mtime` å’Œ `ctime`ï¼ˆå› ä¸ºæ–‡ä»¶å¤§å°å˜äº†ï¼Œå…ƒæ•°æ®ä¹Ÿå°±å˜äº†ï¼‰ã€‚
> - ä¿®æ”¹æ–‡ä»¶æƒé™ï¼ˆ`chmod`ï¼‰åªä¼šæ›´æ–° `ctime`ï¼Œä¸ä¼šæ›´æ–° `mtime`ã€‚

#### chmod

`chmod` (Change Mode) ç”¨äºä¿®æ”¹ `struct stat` ä¸­çš„ `st_mode` å­—æ®µçš„ä½ 9 ä½ï¼ˆå³æƒé™ä½ï¼‰ã€‚å®ƒå¯ä»¥æ˜¯ Shell å‘½ä»¤ï¼Œä¹Ÿå¯ä»¥æ˜¯ C è¯­è¨€çš„ç³»ç»Ÿè°ƒç”¨ã€‚

åœºæ™¯ Aï¼šå‘½ä»¤è¡Œ (Shell) ä½¿ç”¨ï¼ˆæœ€å¸¸ç”¨ï¼‰

æœ‰ä¸¤ç§æ¨¡å¼ï¼š**ç¬¦å·æ¨¡å¼** (Symbolic) å’Œ **å…«è¿›åˆ¶æ¨¡å¼** (Octal)ã€‚

1\. å…«è¿›åˆ¶æ¨¡å¼ (ç»å¯¹èµ‹å€¼)

å°†æƒé™çœ‹ä½œ 3 ä½äºŒè¿›åˆ¶æ•°ï¼ˆè¯»=4, å†™=2, æ‰§è¡Œ=1ï¼‰ã€‚

- **æ ¼å¼ï¼š** `chmod [XYZ] file`
  - X: Owner, Y: Group, Z: Others
- **ç¤ºä¾‹ï¼š**

  ```bash
  chmod 755 script.sh  # rwxr-xr-x (æ‹¥æœ‰è€…å…¨æƒï¼Œå…¶ä»–äººåªè¯»æ‰§è¡Œ)
  chmod 644 data.txt   # rw-r--r-- (æ ‡å‡†æ•°æ®æ–‡ä»¶æƒé™)
  chmod 600 key.pem    # rw------- (ç§é’¥æ–‡ä»¶ï¼Œä»…æ‹¥æœ‰è€…å¯è¯»å†™)
  ```

2\. ç¬¦å·æ¨¡å¼ (å¢é‡ä¿®æ”¹)

æ›´ç›´è§‚åœ°å¢åŠ æˆ–åˆ é™¤æƒé™ã€‚

- **å¯¹è±¡ï¼š** `u`(User), `g`(Group), `o`(Others), `a`(All)
- **æ“ä½œï¼š** `+`(æ·»åŠ ), `-`(åˆ é™¤), `=` (è®¾ç½®ä¸º)
- **æƒé™ï¼š** `r`, `w`, `x`
- **ç¤ºä¾‹ï¼š**

  ```bash
  chmod +x app         # ç»™æ‰€æœ‰ç”¨æˆ·æ·»åŠ æ‰§è¡Œæƒé™ (ç­‰åŒäº a+x)
  chmod u+w file.txt   # ä»…ç»™æ‹¥æœ‰è€…æ·»åŠ å†™æƒé™
  chmod go-rwx secret  # ç§»é™¤ç»„å’Œå…¶ä»–äººçš„æ‰€æœ‰æƒé™
  ```

åœºæ™¯ Bï¼šC è¯­è¨€ç³»ç»Ÿç¼–ç¨‹ (`chmod` å‡½æ•°)

åœ¨ C è¯­è¨€ä¸­ï¼Œä½¿ç”¨ `chmod` ç³»ç»Ÿè°ƒç”¨ç›´æ¥ä¿®æ”¹æ–‡ä»¶æƒé™ã€‚è¿™é‡Œä¸åšå±•å¼€ã€‚

#### å†…æ ¸å¦‚ä½•è¡¨ç¤ºæ‰“å¼€çš„æ–‡ä»¶ (ä¸‰å¼ è¡¨)

è¿™æ˜¯ç†è§£æ–‡ä»¶å…±äº«å’Œé‡å®šå‘çš„å…³é”®ï¼š

1. **æè¿°ç¬¦è¡¨ (Descriptor table)**ï¼š**æ¯ä¸ªè¿›ç¨‹ç‹¬æœ‰**ã€‚
    - åŒ…å«æŒ‡å‘â€œæ‰“å¼€æ–‡ä»¶è¡¨â€è¡¨é¡¹çš„æŒ‡é’ˆã€‚
2. **æ‰“å¼€æ–‡ä»¶è¡¨ (Open file table)**ï¼š**æ‰€æœ‰è¿›ç¨‹å…±äº«**ã€‚
    - åŒ…å«ï¼šå½“å‰æ–‡ä»¶ä½ç½® (File pos)ã€å¼•ç”¨è®¡æ•° (refcnt)ã€‚
    - è¿™æ„å‘³ç€å¦‚æœ**ä¸¤ä¸ªè¿›ç¨‹å…±äº«åŒä¸€ä¸ªæ‰“å¼€æ–‡ä»¶è¡¨é¡¹ï¼Œå®ƒä»¬ä¹Ÿå…±äº«æ–‡ä»¶è¯»å–ä½ç½®**ã€‚
3. **v-node è¡¨ (v-node table)**ï¼š**æ‰€æœ‰è¿›ç¨‹å…±äº«**ã€‚
    - åŒ…å«ï¼šæ–‡ä»¶å…ƒæ•°æ®ï¼ˆå¦‚ `stat` ç»“æ„ä¸­çš„ä¿¡æ¯ï¼‰ã€‚

```mermaid
graph LR
    %% å®šä¹‰æ ·å¼
    classDef descTable fill:#e3f2fd,stroke:#1565c0,stroke-width:2px;
    classDef fileTable fill:#fff9c4,stroke:#fbc02d,stroke-width:2px;
    classDef vnodeTable fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;

    %% 1. æè¿°ç¬¦è¡¨
    subgraph DT ["æè¿°ç¬¦è¡¨"]
        direction TB
        subgraph ProcessA ["è¿›ç¨‹ A"]
            pa_fd1["fd 1 (stdout)"]
            pa_fd3["fd 3"]
        end

        subgraph ProcessB ["è¿›ç¨‹ B"]
            pb_fd1["fd 1 (stdout)"]
        end
    end

    %% 2. æ‰“å¼€æ–‡ä»¶è¡¨
    subgraph OFT ["æ‰“å¼€æ–‡ä»¶è¡¨"]
        direction TB
        subgraph FileEntry1 ["è¡¨é¡¹ #1"]
            fe1_info["å½“å‰ä½ç½® (Pos): 100 <br> å¼•ç”¨è®¡æ•° (refcnt): 2 <br> æ¨¡å¼: Write"]
        end

        subgraph FileEntry2 ["è¡¨é¡¹ #2"]
            fe2_info["å½“å‰ä½ç½® (Pos): 0 <br> å¼•ç”¨è®¡æ•° (refcnt): 1 <br> æ¨¡å¼: Read"]
        end
    end

    %% 3. v-node è¡¨
    subgraph VNT ["v-nodeè¡¨"]
        subgraph VnodeX ["v-node X (æ–‡ä»¶ foo.txt)"]
            vn_info["æ–‡ä»¶å¤§å°: 2048 <br> æ‰€æœ‰è€…: Root <br> ç‰©ç†ç£ç›˜åœ°å€"]
        end
    end

    %% è¿æ¥å…³ç³»
    %% åœºæ™¯ 1: å…±äº« (ä¾‹å¦‚é€šè¿‡ fork)
    pa_fd1 -->|æŒ‡é’ˆ| FileEntry1
    pb_fd1 -->|æŒ‡é’ˆ| FileEntry1

    %% åœºæ™¯ 2: ç‹¬ç«‹æ‰“å¼€åŒä¸€ä¸ªæ–‡ä»¶
    pa_fd3 -->|æŒ‡é’ˆ| FileEntry2

    %% è¿æ¥åˆ° v-node
    FileEntry1 -->|æŒ‡é’ˆ| VnodeX
    FileEntry2 -->|æŒ‡é’ˆ| VnodeX

    %% åº”ç”¨æ ·å¼
    class ProcessA,ProcessB descTable;
    class FileEntry1,FileEntry2 fileTable;
    class VnodeX vnodeTable;
```

#### æ–‡ä»¶å…±äº«çš„å‡ ç§åœºæ™¯

1. **åŒä¸€ä¸ªè¿›ç¨‹ä¸¤æ¬¡ `open` åŒä¸€ä¸ªæ–‡ä»¶**ï¼š
    - ä¹Ÿå°±æ˜¯ `fd1 = open("f.txt"); fd2 = open("f.txt");`
    - ç»“æœï¼šä¸¤ä¸ªä¸åŒçš„æè¿°ç¬¦ï¼ŒæŒ‡å‘**ä¸¤ä¸ªä¸åŒ**çš„æ‰“å¼€æ–‡ä»¶è¡¨é¡¹ã€‚
    - _ç‰¹ç‚¹_ï¼šå®ƒä»¬æœ‰å„è‡ªç‹¬ç«‹çš„æ–‡ä»¶ä½ç½® (file pos)ï¼Œäº’ä¸å¹²æ‰°ã€‚

```mermaid
graph LR
    %% æ ·å¼å®šä¹‰
    classDef dt fill:#e3f2fd,stroke:#1565c0,stroke-width:2px;
    classDef oft fill:#fff9c4,stroke:#fbc02d,stroke-width:2px;
    classDef vnt fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;

    %% æè¿°ç¬¦è¡¨
    subgraph DT ["æè¿°ç¬¦è¡¨ (è¿›ç¨‹ P1)"]
        direction TB
        fd3["fd 3 = open('A.txt')"]
        fd4["fd 4 = open('A.txt')"]
    end

    %% æ‰“å¼€æ–‡ä»¶è¡¨
    subgraph OFT ["æ‰“å¼€æ–‡ä»¶è¡¨ (OFT)"]
        direction TB
        oe1["è¡¨é¡¹ #1 <br> Pos: 100 <br> ref: 1"]
        oe2["è¡¨é¡¹ #2 <br> Pos: 0 <br> ref: 1"]
    end

    %% v-node è¡¨
    subgraph VNT ["v-node è¡¨"]
        vn["v-node (A.txt)"]
    end

    %% è¿æ¥
    fd3 --> oe1
    fd4 --> oe2
    oe1 --> vn
    oe2 --> vn

    %% åº”ç”¨æ ·å¼
    class DT dt;
    class OFT oft;
    class VNT vnt;
```

1. **`fork()` åçš„çˆ¶å­è¿›ç¨‹**ï¼š
    - å­è¿›ç¨‹ç»§æ‰¿çˆ¶è¿›ç¨‹çš„æè¿°ç¬¦è¡¨ã€‚
    - ç»“æœï¼šçˆ¶å­è¿›ç¨‹çš„ç›¸åŒ fd æŒ‡å‘**åŒä¸€ä¸ª**æ‰“å¼€æ–‡ä»¶è¡¨é¡¹ã€‚
    - _ç‰¹ç‚¹_ï¼šçˆ¶å­è¿›ç¨‹**å…±äº«**æ–‡ä»¶ä½ç½®ã€‚å¼•ç”¨è®¡æ•° (refcnt) ä¼šå¢åŠ ã€‚

```mermaid
graph LR
    %% æ ·å¼å®šä¹‰
    classDef dt fill:#e3f2fd,stroke:#1565c0,stroke-width:2px;
    classDef oft fill:#fff9c4,stroke:#fbc02d,stroke-width:2px;
    classDef vnt fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;

    %% æè¿°ç¬¦è¡¨ (çˆ¶å­)
    subgraph DT_Parent ["çˆ¶è¿›ç¨‹æè¿°ç¬¦"]
        p_fd3["fd 3"]
    end

    subgraph DT_Child ["å­è¿›ç¨‹æè¿°ç¬¦"]
        c_fd3["fd 3"]
    end

    %% æ‰“å¼€æ–‡ä»¶è¡¨
    subgraph OFT ["æ‰“å¼€æ–‡ä»¶è¡¨ (OFT)"]
        oe["è¡¨é¡¹ #Shared <br> Pos: 50 <br> ref: 2 (çˆ¶+å­)"]
    end

    %% v-node è¡¨
    subgraph VNT ["v-node è¡¨"]
        vn["v-node (B.txt)"]
    end

    %% è¿æ¥
    p_fd3 --> oe
    c_fd3 --> oe
    oe --> vn

    %% åº”ç”¨æ ·å¼
    class DT_Parent,DT_Child dt;
    class OFT oft;
    class VNT vnt;
```

1. **I/O é‡å®šå‘ (`dup2`)**ï¼š
    - `dup2(oldfd, newfd)`ï¼šå°†æè¿°ç¬¦è¡¨ä¸­çš„ `oldfd` æ¡ç›®å¤åˆ¶å¹¶è¦†ç›– `newfd` æ¡ç›®ã€‚
    - ä¾‹å¦‚ `dup2(4, 1)` ä¼šè®©æ ‡å‡†è¾“å‡º (fd 1) æŒ‡å‘ fd 4 å¯¹åº”çš„æ–‡ä»¶ï¼ˆå¦‚ç£ç›˜æ–‡ä»¶ï¼‰ã€‚
    - è¿™æ˜¯ Shell å®ç°é‡å®šå‘ï¼ˆå¦‚ `ls > foo.txt`ï¼‰çš„åŸç†ã€‚

```mermaid
graph LR
    %% æ ·å¼å®šä¹‰
    classDef dt fill:#e3f2fd,stroke:#1565c0,stroke-width:2px;
    classDef oft fill:#fff9c4,stroke:#fbc02d,stroke-width:2px;
    classDef vnt fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;

    %% æè¿°ç¬¦è¡¨
    subgraph DT ["æè¿°ç¬¦è¡¨ (è¿›ç¨‹ P3)"]
        direction TB
        fd4["fd 4 (LogFile)"]
        fd1["fd 1 (Stdout)"]
    end

    %% æ‰“å¼€æ–‡ä»¶è¡¨
    subgraph OFT ["æ‰“å¼€æ–‡ä»¶è¡¨ (OFT)"]
        oe_file["è¡¨é¡¹ #File <br> (ç£ç›˜æ–‡ä»¶) <br> ref: 2"]
        oe_term["è¡¨é¡¹ #Term <br> (å±å¹•ç»ˆç«¯) <br> ref: 0 (å¼•ç”¨å½’é›¶)"]
    end

    %% v-node è¡¨
    subgraph VNT ["v-node è¡¨"]
        vn_file["v-node (out.log)"]
        vn_term["v-node (ç»ˆç«¯)"]
    end

    %% è¿æ¥
    fd4 --> oe_file

    %% é‡å®šå‘é€»è¾‘
    fd1 -.->|æ–­å¼€| oe_term
    fd1 -->|é‡å®šå‘| oe_file

    oe_file --> vn_file
    oe_term --> vn_term

    %% åº”ç”¨æ ·å¼
    class DT dt;
    class OFT oft;
    class VNT vnt;
```

---

### Standard I/O

C æ ‡å‡†åº“ (`libc`) æä¾›çš„æ›´é«˜çº§åˆ«çš„ I/O å‡½æ•° (`stdio.h`)ã€‚

- **æµ (Stream)**ï¼šæ ‡å‡† I/O å°†æ‰“å¼€çš„æ–‡ä»¶æ¨¡å‹åŒ–ä¸ºæµã€‚æ˜¯ä¸€ä¸ªæŒ‡å‘ `FILE` ç±»å‹çš„æŒ‡é’ˆï¼Œæ˜¯å¯¹ fd å’Œå†…å­˜ç¼“å†²åŒºçš„æŠ½è±¡ã€‚
- **ç¼“å†² (Buffering)**ï¼š
  - **åŠ¨æœº**ï¼šUnix I/O ç³»ç»Ÿè°ƒç”¨ (`read`/`write`) å¼€é”€å¤§ï¼ˆ>10,000 æ—¶é’Ÿå‘¨æœŸï¼‰ã€‚
  - **æœºåˆ¶**ï¼šä½¿ç”¨ `printf` æˆ– `fputc` æ—¶ï¼Œæ•°æ®å…ˆå†™å…¥ç”¨æˆ·ç©ºé—´çš„ç¼“å†²åŒºã€‚åªæœ‰å½“ç¼“å†²åŒºæ»¡ã€é‡åˆ°æ¢è¡Œç¬¦ (`\n`)ã€è°ƒç”¨ `fflush` æˆ–ç¨‹åºç»“æŸæ—¶ï¼Œæ‰çœŸæ­£è°ƒç”¨ Unix `write` å†™å…¥å†…æ ¸ã€‚
  - **é—®é¢˜**ï¼š`strace` è¿½è¸ªæ—¶ä¼šå‘ç° `write` è°ƒç”¨æ¬¡æ•°è¿œå°‘äº `printf` è°ƒç”¨æ¬¡æ•°ã€‚

| **ç‰¹æ€§**     | **åº•å±‚ I/O (Unbuffered)** | **æ ‡å‡† I/O (Buffered)**                        |
| ------------ | ------------------------- | ---------------------------------------------- |
| **å¥æŸ„ç±»å‹** | `int` (æ–‡ä»¶æè¿°ç¬¦)        | `FILE *` (æ–‡ä»¶æµæŒ‡é’ˆ)                          |
| **æ‰“å¼€**     | `open()`                  | `fopen()`                                      |
| **è¯»/å†™**    | `read()`, `write()`       | `fread()`, `fwrite()`, `fprintf()`, `fscanf()` |
| **å…³é—­**     | `close()`                 | `fclose()` (ä¼šè‡ªåŠ¨åˆ·æ–°ç¼“å†²åŒº)                  |
| **ä¸»è¦ä½ç½®** | `<unistd.h>`              | `<stdio.h>`                                    |
| **å…¸å‹ä»£è¡¨** | `STDIN_FILENO` (0)        | `stdin`                                        |

> [!important]
>
> å’Œæ–‡ä»¶æè¿°ç¬¦çš„åŒºåˆ«åœ¨äºæœ‰æ²¡æœ‰bufferã€‚

```mermaid
graph TD
    %% === æ ·å¼å®šä¹‰ ===
    classDef userSpace fill:#e1f5fe,stroke:#01579b,stroke-width:2px;
    classDef structFile fill:#fff9c4,stroke:#fbc02d,stroke-width:2px,stroke-dasharray: 5 5;
    classDef bufferBlock fill:#ffcc80,stroke:#e65100,stroke-width:1px;
    classDef kernelSpace fill:#ffebee,stroke:#b71c1c,stroke-width:2px;
    classDef sysCall fill:#b0bec5,stroke:#37474f,stroke-width:1px;

    %% ==========================================
    %% 1. ç”¨æˆ·ç©ºé—´ (User Space)
    %% ==========================================
    subgraph US ["ç”¨æˆ·ç©ºé—´ (User Space)"]
        direction TB

        %% åº”ç”¨ç¨‹åº
        App["ä½ çš„ä»£ç  (Application) <br> fprintf(fp, 'A');"]

        %% FILE ç»“æ„ä½“ (Cæ ‡å‡†åº“)
        subgraph FILE_Struct ["FILE ç»“æ„ä½“ (fp)"]
            direction TB

            %% æ ¸å¿ƒç»„ä»¶
            subgraph Buffer ["ç”¨æˆ·çº§ç¼“å†²åŒº (User Buffer)"]
                Content["[ 'A' | 'B' | ...ç©ºé—²... ]"]
            end

            Vars["æŒ‡é’ˆ: ptr (å½“å‰ä½ç½®)<br>è®¡æ•°å™¨: cnt (å‰©ä½™ç©ºé—´)<br>æ ‡å¿—: flags (EOF/ERR)"]

            FD_Holder["åº•å±‚æè¿°ç¬¦: _fileno = 3"]
        end
    end

    %% ==========================================
    %% 2. ç³»ç»Ÿè°ƒç”¨æ¥å£
    %% ==========================================
    SysWrite(("ç³»ç»Ÿè°ƒç”¨<br>write(3, buf, ...)"))

    %% ==========================================
    %% 3. å†…æ ¸ç©ºé—´ (Kernel Space)
    %% ==========================================
    subgraph KS ["å†…æ ¸ç©ºé—´ (Kernel Space)"]
        direction TB

        DT["æè¿°ç¬¦è¡¨"]
        OFT["æ‰“å¼€æ–‡ä»¶è¡¨<br>(Offset)"]
        Disk[("ç£ç›˜ / ç¡¬ä»¶")]
    end

    %% === è¿æ¥å…³ç³»ä¸æ•°æ®æµ ===

    %% 1. å†™å…¥ç¼“å†²
    App -->|å¤åˆ¶æ•°æ®| Content

    %% å˜é‡æ§åˆ¶ç¼“å†²
    Vars -.->|ç®¡ç†| Buffer

    %% 2. åˆ·æ–°ç¼“å†² (Buffer Flush)
    Vars -->|"è§¦å‘åˆ·æ–° (Flush)"| SysWrite

    %% 3. æ•°æ®ä¼ å…¥å†…æ ¸
    FD_Holder -.->|æä¾› fd| SysWrite
    Content -->|æ•°æ®æ¬è¿| SysWrite

    %% 4. å†…æ ¸å¤„ç†
    SysWrite -->|å†™å…¥| OFT
    DT -.-> OFT
    OFT --> Disk

    %% === åº”ç”¨æ ·å¼ ===
    class US userSpace;
    class FILE_Struct structFile;
    class Content bufferBlock;
    class KS kernelSpace;
    class SysWrite sysCall;
```

### Robust I/O

CS:APP è¯¾ç¨‹ä¸“é—¨å¼€å‘çš„ I/O åŒ… (`csapp.c`)ï¼Œç”¨äºè§£å†³ Unix I/O çš„çŸ­è®¡æ•°é—®é¢˜å’Œæ ‡å‡† I/O åœ¨ç½‘ç»œç¼–ç¨‹ä¸­çš„å±€é™æ€§ã€‚

**ä¸¤ç§ç±»å‹**

1. **æ— ç¼“å†² RIO (Unbuffered RIO)**ï¼š
    - `rio_readn`, `rio_writen`ã€‚
    - ç”¨äºäºŒè¿›åˆ¶æ•°æ®ä¼ è¾“ã€‚
    - **ç‰¹æ€§**ï¼šè‡ªåŠ¨å¤„ç†çŸ­è®¡æ•°ï¼ˆå¾ªç¯è°ƒç”¨ `read`/`write` ç›´åˆ°å®Œæˆï¼‰ï¼Œå¤„ç†è¢«ä¿¡å·ä¸­æ–­ (`EINTR`) çš„æƒ…å†µã€‚
    - `rio_writen` ä¿è¯å†™å®Œæ‰€æœ‰å­—èŠ‚ï¼›`rio_readn` ä»…åœ¨ EOF æ—¶è¿”å›çŸ­è®¡æ•°ã€‚
2. **å¸¦ç¼“å†² RIO (Buffered RIO)**ï¼š
    - `rio_readinitb`, `rio_readlineb` (è¯»æ–‡æœ¬è¡Œ), `rio_readnb` (è¯»äºŒè¿›åˆ¶)ã€‚
    - **ç‰¹æ€§**ï¼šçº¿ç¨‹å®‰å…¨ï¼Œå¸¦å†…éƒ¨ç¼“å†²åŒºï¼Œå‡å°‘ç³»ç»Ÿè°ƒç”¨ã€‚
    - å…è®¸åœ¨åŒä¸€ä¸ªæè¿°ç¬¦ä¸Šäº¤å‰è°ƒç”¨ `rio_readlineb` å’Œ `rio_readnb`ã€‚
    - _è­¦å‘Š_ï¼šä¸è¦å°†å¸¦ç¼“å†² RIO å’Œæ— ç¼“å†² RIO æ··ç”¨åœ¨åŒä¸€ä¸ªæè¿°ç¬¦ä¸Šã€‚

### åº”è¯¥ä½¿ç”¨å“ªç§ I/Oï¼Ÿ

| ç‰¹æ€§           | Unix I/O (open/read/write)                 | æ ‡å‡† I/O (fopen/fprintf)            | RIO (rio_readn/readlineb) |
| :------------- | :----------------------------------------- | :---------------------------------- | :------------------------ |
| **æŠ½è±¡å±‚çº§**   | ä½çº§ (ç³»ç»Ÿè°ƒç”¨)                            | é«˜çº§ (C åº“)                         | é«˜çº§ (CS:APP å°è£…)        |
| **ç¼“å†²**       | æ—                                          | æœ‰ (ç”¨æˆ·çº§ç¼“å†²)                     | æœ‰/æ—  å¯é€‰                |
| **çŸ­è®¡æ•°å¤„ç†** | éœ€æ‰‹åŠ¨å¤„ç† (éº»çƒ¦ä¸”æ˜“é”™)                    | è‡ªåŠ¨å¤„ç†                            | è‡ªåŠ¨å¤„ç†                  |
| **å…ƒæ•°æ®è®¿é—®** | æ”¯æŒ (`stat`)                              | ä¸æ”¯æŒ                              | ä¸æ”¯æŒ                    |
| **ä¿¡å·å®‰å…¨æ€§** | Async-signal-safe (å¯åœ¨ä¿¡å·å¤„ç†ç¨‹åºä¸­ä½¿ç”¨) | ä¸å®‰å…¨                              | ä¸å®‰å…¨                    |
| **ç½‘ç»œå¥—æ¥å­—** | é€‚ç”¨                                       | **ä¸æ¨è** (æµé™åˆ¶ä¸å¥—æ¥å­—é™åˆ¶å†²çª) | **æ¨è** (ä¸“é—¨è®¾è®¡)       |

**é€‰ç”¨åŸåˆ™**

1. **é¦–é€‰é«˜çº§ I/O**ï¼šå°½å¯èƒ½ä½¿ç”¨æ ‡å‡† I/Oï¼ˆå¤„ç†ç£ç›˜/ç»ˆç«¯æ–‡ä»¶æ—¶ï¼‰ï¼Œå› ä¸ºæ•ˆç‡é«˜ä¸”ç®€å•ã€‚
2. **ä¿¡å·å¤„ç†ç¨‹åº (Signal Handlers)**ï¼šå¿…é¡»ä½¿ç”¨ **Unix I/O**ï¼Œå› ä¸ºå®ƒæ˜¯å¼‚æ­¥ä¿¡å·å®‰å…¨çš„ã€‚
3. **ç½‘ç»œå¥—æ¥å­— (Network Sockets)**ï¼š
    - ä½¿ç”¨ **RIO** æˆ– **Unix I/O**ã€‚
    - **é¿å…ä½¿ç”¨æ ‡å‡† I/O** å¤„ç†å¥—æ¥å­—ï¼ˆç”±äºè¾“å…¥è¾“å‡ºæµçš„äº¤äº’é—®é¢˜ï¼‰ã€‚
4. **äºŒè¿›åˆ¶æ–‡ä»¶**ï¼š
    - ä¸è¦ä½¿ç”¨é¢å‘æ–‡æœ¬çš„å‡½æ•°ï¼ˆå¦‚ `fgets`, `scanf`, `rio_readlineb`ï¼‰ï¼Œå› ä¸ºå®ƒä»¬ä¼šé”™è¯¯è§£é‡Š `0x00` å­—èŠ‚æˆ–æ¢è¡Œç¬¦ã€‚
    - ä½¿ç”¨ `rio_readn` æˆ– `rio_readnb`ã€‚

# Virtual Memory

![address_translation_all](part3.assets/address_translation_all.png)

> ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è™šæ‹Ÿå†…å­˜ï¼Ÿ
>
> è™šæ‹Ÿå†…å­˜æ˜¯ä¸€å±‚å¾ˆå…³é”®çš„æŠ½è±¡ï¼š
>
> - å®ƒéšè—äº†ç‰©ç†å†…å­˜çš„ç»†èŠ‚ï¼Œä¸ºç¨‹åºæä¾›äº†ä¸€ä¸ªæŠ½è±¡çš„ã€ä¸€è‡´çš„å†…å­˜è§†å›¾ã€‚
> - å®ƒä¿è¯äº†æ¯ä¸ªè¿›ç¨‹åœ°å€ç©ºé—´çš„ç‹¬ç«‹æ€§ï¼Œä½¿å¾—è¿›ç¨‹ä¹‹é—´ä¸ä¼šç›¸äº’å¹²æ‰°ã€‚
> - å¯ä»¥åˆ†é…è¶…è¿‡ç‰©ç†å†…å­˜çš„åœ°å€ç©ºé—´ï¼Œå……åˆ†åˆ©ç”¨ç‰©ç†å†…å­˜ï¼ˆç‰©ç†åœ°å€æ˜¯å”¯ä¸€çš„ï¼Œä¸èƒ½å¤šæ¬¡åˆ†é…ï¼‰

## å¯»å€æ¨¡å¼ä¸åœ°å€ç©ºé—´

- **ç‰©ç†å¯»å€ (Physical Addressing):**
  - **æœºåˆ¶ï¼š** CPUç›´æ¥ç”Ÿæˆç‰©ç†åœ°å€ï¼ˆPAï¼‰è®¿é—®ä¸»å­˜ ã€‚
  - **åº”ç”¨åœºæ™¯ï¼š** ç®€å•çš„åµŒå…¥å¼ç³»ç»Ÿã€å¾®æ§åˆ¶å™¨ï¼ˆå¦‚æ±½è½¦æ§åˆ¶ã€ç”µæ¢¯ã€æ•°å­—ç›¸æ¡†ï¼‰ ã€‚
- **è™šæ‹Ÿå¯»å€ (Virtual Addressing):**
  - **æœºåˆ¶ï¼š** CPUç”Ÿæˆè™šæ‹Ÿåœ°å€ï¼ˆVAï¼‰ï¼Œé€šè¿‡**MMUï¼ˆå†…å­˜ç®¡ç†å•å…ƒï¼‰** ç¿»è¯‘æˆç‰©ç†åœ°å€ï¼ˆPAï¼‰å†è®¿é—®ä¸»å­˜ ã€‚
  - **åº”ç”¨åœºæ™¯ï¼š** ç°ä»£æœåŠ¡å™¨ã€ç¬”è®°æœ¬ç”µè„‘ã€æ™ºèƒ½æ‰‹æœº ã€‚
- **åœ°å€ç©ºé—´çš„æ•°å­¦å®šä¹‰ï¼š**
  - **çº¿æ€§åœ°å€ç©ºé—´ï¼š** è¿ç»­çš„éè´Ÿæ•´æ•°åœ°å€é›†åˆ $\{0, 1, 2, ...\}$ ã€‚
  - **è™šæ‹Ÿåœ°å€ç©ºé—´ ($V$):** å¤§å°ä¸º $N=2^n$ çš„é›†åˆ $\{0, 1, ..., N-1\}$ ã€‚
  - **ç‰©ç†åœ°å€ç©ºé—´ ($P$):** å¤§å°ä¸º $M=2^m$ çš„é›†åˆ $\{0, 1, ..., M-1\}$ ã€‚
  - **æ ¸å¿ƒç†å¿µï¼š** æ¸…æ™°åŒºåˆ†äº†æ•°æ®ï¼ˆå­—èŠ‚ï¼‰å’Œå®ƒä»¬çš„å±æ€§ï¼ˆåœ°å€ï¼‰ï¼Œä½¿å¾—ä¸»å­˜ä¸­çš„æ¯ä¸ªå­—èŠ‚å¯ä»¥**æ‹¥æœ‰ä¸€ä¸ªç‰©ç†åœ°å€å’Œå¤šä¸ªè™šæ‹Ÿåœ°å€** ã€‚

## è™šæ‹Ÿå†…å­˜

- **æ¦‚å¿µæ¨¡å‹ï¼š** è™šæ‹Ÿå†…å­˜è¢«è§†ä¸ºå­˜å‚¨åœ¨ç£ç›˜ä¸Šçš„ $N$ ä¸ªè¿ç»­å­—èŠ‚çš„æ•°ç»„ï¼Œè€Œç‰©ç†å†…å­˜ï¼ˆDRAMï¼‰æ˜¯è¿™ä¸ªç£ç›˜æ•°ç»„çš„**ç¼“å­˜** ã€‚
- ä»»ä½•æ—¶åˆ»ï¼Œè™šæ‹Ÿå†…å­˜çš„é›†åˆåˆ†ä¸ºä¸‰ä¸ª**ä¸ç›¸äº¤**çš„å­é›†ï¼š
  - æœªåˆ†é…çš„ï¼šå®Œå…¨æ²¡åœ¨è™šæ‹Ÿå†…å­˜ä¸­åˆ†é…ï¼ˆç”¨ä¸åˆ°ã€çœä¸‹æ¥ï¼‰
  - å·²åˆ†é…çš„
    - å·²ç¼“å­˜çš„ï¼šå·²ç»åœ¨ç‰©ç†å†…å­˜ä¸­ç¼“å­˜ï¼Œä¸éœ€è¦åˆ°ç¡¬ç›˜å»å–
    - æœªç¼“å­˜çš„ï¼šä¸åœ¨ç‰©ç†å†…å­˜ä¸­ç¼“å­˜ï¼Œéœ€è¦åˆ°ç¡¬ç›˜ä¸­å–

- **é¡µ (Page) çš„ç»“æ„ï¼š**
  - ç£ç›˜ä¸Šçš„æ•°æ®å—ç§°ä¸º**è™šæ‹Ÿé¡µ (VP)**ï¼Œå†…å­˜ä¸­çš„ç¼“å­˜å—ç§°ä¸º**ç‰©ç†é¡µ (PP)**æˆ–é¡µå¸§ ã€‚
  - é¡µå¤§å° $P = 2^p$ å­—èŠ‚ï¼Œé€šå¸¸ä¸º 4KB ã€‚
  - Linux æ”¯æŒ "Huge Pages"ï¼ˆ2MB åˆ° 1GBï¼‰ ã€‚
- **DRAM ç¼“å­˜çš„ç‰¹æ€§ï¼ˆç”±å·¨å¤§çš„æ€§èƒ½å·®å¼‚å†³å®šï¼‰ï¼š**
  - **æ€§èƒ½é¸¿æ²Ÿï¼š** DRAM æ¯” SRAM æ…¢ 10å€ï¼Œä½†ç£ç›˜æ¯” DRAM æ…¢ **10,000å€** ã€‚ä»ç£ç›˜åŠ è½½ä¸€ä¸ªå—éœ€è¦ >1msï¼ˆç™¾ä¸‡ä¸ªæ—¶é’Ÿå‘¨æœŸï¼‰ ã€‚
  - **å…¨ç›¸è” (Fully Associative):** ä»»ä½• VP éƒ½å¯ä»¥æ”¾ç½®åœ¨ä»»ä½• PP ä¸­ï¼Œä»¥æœ€å¤§é™åº¦åˆ©ç”¨å†…å­˜ ã€‚(åªæœ‰ä¸€ä¸ªset)
  - **æ›¿æ¢ç®—æ³•ï¼š** ä½¿ç”¨éå¸¸å¤æ‚ã€ç²¾å¯†çš„æ›¿æ¢ç®—æ³•ï¼ˆç”±æ“ä½œç³»ç»Ÿè½¯ä»¶å®ç°ï¼‰ï¼Œå› ä¸ºç¡¬ä»¶æ— æ³•å¤„ç†è¿™ç§å¤æ‚æ€§ ã€‚
  - **å†™ç­–ç•¥ï¼š** å¿…é¡»ä½¿ç”¨**å†™å› (Write-back)** è€Œéç›´å†™ï¼Œé¿å…é¢‘ç¹å†™ç£ç›˜ ã€‚
- **é¡µè¡¨ (Page Table):**
  - æ˜¯ä¸€ä¸ªå¸¸é©»å†…å­˜ï¼ˆDRAMï¼‰çš„æ•°æ®ç»“æ„ï¼Œæ¯ä¸ªè¿›ç¨‹ç‹¬æœ‰ ã€‚
  - **PTE (Page Table Entry):** åŒ…å«ä¸€ä¸ªæœ‰æ•ˆä½ (Valid bit) å’Œç‰©ç†é¡µå·/ç£ç›˜åœ°å€ã€‚
    - `Valid=1`: VP ç¼“å­˜åœ¨ DRAM ä¸­ï¼Œåœ°å€å­—æ®µæŒ‡å‘ç‰©ç†é¡µå· (PPN) ã€‚
    - `Valid=0, Address!=null`: VP æœªç¼“å­˜ï¼Œåœ°å€å­—æ®µæŒ‡å‘ç£ç›˜ä½ç½® ã€‚
    - `Valid=0, Address=null`: VP æœªåˆ†é… ã€‚

---

## ç¼ºé¡µå¤„ç†

> [!important]
>
> ç¼ºé¡µå¼‚å¸¸æ˜¯**æ•…éšœ**ï¼Œæ˜¯**åŒæ­¥**çš„ï¼Œå¦‚æœèƒ½ä»å¼‚å¸¸å¤„ç†ç¨‹åºä¸­æ¢å¤ï¼Œåˆ™æ¢å¤åˆ°**å½“å‰æŒ‡ä»¤**ã€‚

- **å®šä¹‰ï¼š** å¼•ç”¨äº†ä¸åœ¨ç‰©ç†å†…å­˜ä¸­çš„è™šæ‹Ÿé¡µï¼ˆå³ DRAM ç¼“å­˜æœªå‘½ä¸­ï¼‰ ã€‚
- **è¯¦ç»†å¤„ç†æµç¨‹ï¼š**
  1. **è§¦å‘ï¼š** ä¾‹å¦‚ `movl` æŒ‡ä»¤è®¿é—®åœ°å€ `0x8049d10`ï¼Œè¯¥é¡µåœ¨ç£ç›˜ä¸Š ã€‚
  2. **å¼‚å¸¸ï¼š** MMU æ£€æµ‹åˆ° Valid ä½ä¸º 0ï¼Œè§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼ˆPage Fault Exceptionï¼‰ ã€‚
  3. **é™·å…¥å†…æ ¸ï¼š** æƒé™æå‡è‡³ç›‘ç®¡è€…æ¨¡å¼ (Supervisor Mode)ï¼Œè°ƒç”¨å†…æ ¸çš„ç¼ºé¡µå¤„ç†ç¨‹åº ã€‚
  4. **é©±é€ (Evict):** å¤„ç†ç¨‹åºé€‰æ‹©ä¸€ä¸ªå—å®³è€…é¡µé¢ï¼ˆVictim Pageï¼‰ï¼Œå¦‚æœè¯¥é¡µæ˜¯è„çš„ï¼ˆDirtyï¼‰ï¼Œåˆ™å°†å…¶å†™å›ç£ç›˜ ã€‚
  5. **åŠ è½½ (Page-in):** ä»ç£ç›˜å¤åˆ¶æ–°é¡µé¢åˆ°å†…å­˜ä¸­çš„ç‰©ç†é¡µ ã€‚
  6. **æ›´æ–°ï¼š** æ›´æ–°å†…å­˜ä¸­çš„ PTEï¼ˆè®¾ç½® Valid=1ï¼Œæ›´æ–° PPNï¼‰ ã€‚
  7. **æ¢å¤ï¼š** æ‰§è¡Œ `iret` æŒ‡ä»¤è¿”å›ï¼Œ**é‡æ–°æ‰§è¡Œ** å¯¼è‡´ç¼ºé¡µçš„é‚£æ¡ `movl` æŒ‡ä»¤ ã€‚
- ![image-20251124134002348](part3.assets/image-20251124134002348.png)
- **æŒ‰éœ€è°ƒé¡µ (Demand Paging):** ç›´åˆ°å‘ç”Ÿæœªå‘½ä¸­ï¼ˆMissï¼‰æ—¶æ‰å°†é¡µé¢ä»ç£ç›˜å¤åˆ¶åˆ° DRAM çš„ç­–ç•¥ ã€‚
- **å±€éƒ¨æ€§ä¸é¢ ç°¸ (Locality & Thrashing):**
  - **å·¥ä½œé›† (Working Set):** ç¨‹åºåœ¨ä»»æ„æ—¶åˆ»å€¾å‘äºè®¿é—®çš„ä¸€ç»„æ´»è·ƒè™šæ‹Ÿé¡µ ã€‚
  - **é¢ ç°¸ (Thrashing):** å½“æ‰€æœ‰æ´»è·ƒè¿›ç¨‹çš„å·¥ä½œé›†æ€»å¤§å° > ç‰©ç†å†…å­˜å¤§å°æ—¶ï¼Œé¡µé¢ä¸æ–­è¢«æ¢å…¥æ¢å‡ºï¼Œå¯¼è‡´æ€§èƒ½â€œç†”æ–­â€ ã€‚
    - æ­£å¸¸æƒ…å†µä¸‹ï¼Œå†·ä¸å‘½ä¸­ä¹‹åï¼Œå°±ä¼šæœ‰å¾ˆå¥½çš„æ€§èƒ½ã€‚

---

## ç®¡ç†

- æ ¸å¿ƒæœºåˆ¶ï¼šæ“ä½œç³»ç»Ÿä¸ºç³»ç»Ÿä¸­çš„æ¯ä¸ªè¿›ç¨‹éƒ½ç»´æŠ¤ä¸€ä¸ªç‹¬ç«‹çš„é¡µè¡¨ (Global Single Page Table -> Per-Process Page Table)ã€‚
  è¿™æä¾›äº†ä¸€ä¸ªæ ¸å¿ƒå‡è±¡ï¼šæ¯ä¸ªè¿›ç¨‹éƒ½ç‹¬å æ‰€æœ‰ç‰©ç†å†…å­˜ã€‚
- è¿™ä¸€æœºåˆ¶å¸¦æ¥äº†å››ä¸ªä¸»è¦ç®€åŒ–ï¼š
  1. ç®€åŒ–é“¾æ¥ (Simplifying Linking)
     - æœºåˆ¶ï¼šæ¯ä¸ªè¿›ç¨‹ä½¿ç”¨ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ç»Ÿä¸€çš„å†…å­˜æ ¼å¼ï¼ˆä¾‹å¦‚ï¼šä»£ç æ®µæ€»æ˜¯ä» 0x400000 å¼€å§‹ï¼‰ã€‚
     - ä¼˜åŠ¿ï¼šé“¾æ¥å™¨ (Linker) çš„è®¾è®¡å’Œå®ç°è¢«å¤§å¤§ç®€åŒ–ã€‚å®ƒä¸éœ€è¦è€ƒè™‘ç‰©ç†å†…å­˜çš„å®é™…ä½ç½®ï¼Œåªéœ€è¦ç”ŸæˆåŸºäºæ ‡å‡†è™šæ‹Ÿåœ°å€ (VA) çš„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ã€‚
  2. ç®€åŒ–åŠ è½½ (Simplifying Loading)
     - æœºåˆ¶ï¼šåŠ è½½å™¨ (Loader) ä¸éœ€è¦çœŸæ­£å°†æ•°æ®ä»ç£ç›˜å¤åˆ¶åˆ°å†…å­˜ã€‚å®ƒåªéœ€åˆ†é…è™šæ‹Ÿé¡µï¼Œå¹¶å°†é¡µè¡¨æ¡ç›® (PTE) æŒ‡å‘ç›®æ ‡æ–‡ä»¶ä¸­å¯¹åº”çš„ä½ç½®ã€‚
     - ä¼˜åŠ¿ï¼šè¿™æ˜¯â€œæŒ‰éœ€è°ƒé¡µ (Demand Paging)â€çš„åŸºç¡€ã€‚ç›´åˆ°ä»£ç çœŸæ­£æ‰§è¡Œæˆ–æ•°æ®è¢«è®¿é—®ï¼ˆå³å‘ç”Ÿç¼ºé¡µå¼‚å¸¸ï¼‰æ—¶ï¼Œæ•°æ®æ‰ä¼šè¢«æ‹·è´åˆ°ç‰©ç†å†…å­˜ä¸­ã€‚
  3. ç®€åŒ–å…±äº« (Simplifying Sharing)
     - æœºåˆ¶ï¼šä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸åŒè¿›ç¨‹çš„è™šæ‹Ÿé¡µæ˜ å°„åˆ°ä¸åŒçš„ç‰©ç†é¡µï¼ˆé€šè¿‡ç‹¬ç«‹çš„é¡µè¡¨å®ç°éš”ç¦»ï¼‰ã€‚
     - å…±äº«å®ç°ï¼šæ“ä½œç³»ç»Ÿå¯ä»¥å°†ä¸åŒè¿›ç¨‹ä¸­é€‚å½“çš„è™šæ‹Ÿé¡µæ˜ å°„åˆ°**åŒä¸€ä¸ªç‰©ç†é¡µ (Physical Page)**ã€‚
     - åº”ç”¨ï¼š
       - å…±äº«åº“ (å¦‚ libc.so) çš„ä»£ç æ®µåªéœ€åœ¨ç‰©ç†å†…å­˜ä¸­å­˜åœ¨ä¸€ä»½ï¼Œå³å¯è¢«å¤šä¸ªè¿›ç¨‹å…±äº«ã€‚
         ![image-20251124134927492](part3.assets/image-20251124134927492.png)
  4. ç®€åŒ–å†…å­˜åˆ†é… (Simplifying Memory Allocation)
     - æœºåˆ¶ï¼šå½“è¿›ç¨‹é€šè¿‡ malloc è¯·æ±‚ä¸€æ®µè¿ç»­çš„å †å†…å­˜ï¼ˆå¦‚ k ä¸ªè¿ç»­çš„è™šæ‹Ÿé¡µï¼‰æ—¶ã€‚
     - ä¼˜åŠ¿ï¼šæ“ä½œç³»ç»Ÿå¯ä»¥åœ¨ç‰©ç†å†…å­˜ä¸­éšæœºåˆ†é… k ä¸ª**ä¸è¿ç»­**çš„ç‰©ç†é¡µï¼Œç„¶åé€šè¿‡é¡µè¡¨å°†å®ƒä»¬æ˜ å°„ä¸ºè¿ç»­çš„è™šæ‹Ÿé¡µã€‚ç‰©ç†å†…å­˜ä¸éœ€è¦è¿ç»­ï¼Œè¿™æ¶ˆé™¤äº†å¤–éƒ¨ç¢ç‰‡çš„é—®é¢˜ã€‚
- **å†…å­˜æ˜ å°„å¸ƒå±€ (Linuxç¤ºä¾‹):**
  - `0x400000`: ä»£ç æ®µ (.text) èµ·å§‹ä½ç½® ã€‚
  - **æ ˆ (Stack):** å‘ä¸‹å¢é•¿ï¼Œç”± `%rsp` æŒ‡å‘ï¼Œä½äºç”¨æˆ·ç©ºé—´é¡¶éƒ¨ï¼ˆçº¦ `0x7FFF...`ï¼‰ ã€‚
  - **å † (Heap):** å‘ä¸Šå¢é•¿ï¼Œç”± `brk` æŒ‡é’ˆç®¡ç†ï¼Œé€šè¿‡ `malloc` åˆ›å»º ã€‚
  - **å…±äº«åº“:** ä½äºå †å’Œæ ˆä¹‹é—´çš„å†…å­˜æ˜ å°„åŒºåŸŸ ã€‚

![image-20251124134803116](part3.assets/image-20251124134803116.png)

- **åŠ è½½å™¨ (Loading):** `execve` åœ¨åŠ è½½ç¨‹åºæ—¶ï¼Œå¹¶æœªçœŸæ­£å¤åˆ¶æ•°æ®ï¼Œåªæ˜¯åˆ†é…äº†è™šæ‹Ÿé¡µå¹¶åœ¨é¡µè¡¨ä¸­æ ‡è®°ä¸ºâ€œæ— æ•ˆâ€ã€‚ä»£ç æ•°æ®æ˜¯åœ¨è¿è¡Œæ—¶é€šè¿‡**ç¼ºé¡µæœºåˆ¶**â€œæŒ‰éœ€â€å¤åˆ¶çš„ ã€‚

---

## ä¿æŠ¤

- **æœºåˆ¶ï¼š** åœ¨ PTE ä¸­æ‰©å±•æƒé™ä½ï¼ŒMMU ç¡¬ä»¶åœ¨æ¯æ¬¡è®¿é—®æ—¶è‡ªåŠ¨æ£€æŸ¥ ã€‚
- **å¸¸è§æƒé™ä½ï¼š**
  - `SUP`: æ˜¯å¦éœ€è¦å†…æ ¸ï¼ˆSupervisorï¼‰æƒé™ ã€‚
  - `READ` / `WRITE`: è¯»å†™æƒé™ ã€‚
  - `EXEC`: æ‰§è¡Œæƒé™ï¼ˆé˜²æ­¢ç¼“å†²åŒºæº¢å‡ºæ”»å‡»æ‰§è¡Œæ•°æ®æ®µä»£ç ï¼‰ ã€‚
- **ç¤ºä¾‹ï¼š**
  - è¿›ç¨‹ i çš„ VP 0: `SUP=No`, `READ=Yes`, `WRITE=No` (åªè¯»æ•°æ®)ã€‚
  - è¿›ç¨‹ i çš„ VP 1: `SUP=No`, `READ=Yes`, `WRITE=Yes` (è¯»å†™æ•°æ®)ã€‚
- Linux Shellä¸€èˆ¬æŠ¥å‘Šä¸ºSegmentation Fault

---

## åœ°å€ç¿»è¯‘ç¡¬ä»¶æœºåˆ¶

- $M\rightarrow P \or \{\phi\}$

- **å‚æ•°ç¬¦å·ï¼š**
  - $N=2^n$ (è™šæ‹Ÿåœ°å€ç©ºé—´), $M=2^m$ (ç‰©ç†åœ°å€ç©ºé—´), $P=2^p$ (é¡µå¤§å°)ã€‚

- **åœ°å€åˆ†è§£ï¼š**
  - **VA (è™šæ‹Ÿåœ°å€):** è¢«åˆ†ä¸º **VPN (è™šæ‹Ÿé¡µå·)** (Virtual page number)å’Œ **VPO (è™šæ‹Ÿé¡µåç§»)**(Virtual page offset)ã€‚
  - **PA (ç‰©ç†åœ°å€):** è¢«åˆ†ä¸º **PPN (ç‰©ç†é¡µå·)** å’Œ **PPO (ç‰©ç†é¡µåç§»)**ã€‚
  - **å…³é”®ç‰¹æ€§ï¼š** $VPO = PPO$ã€‚å› ä¸ºé¡µå†…åç§»é‡åœ¨ç¿»è¯‘è¿‡ç¨‹ä¸­æ˜¯ä¸å˜çš„ ã€‚

- **ç¡¬ä»¶ç»„ä»¶ï¼š**
  - **PTBR (Page Table Base Register):** æŒ‡å‘å½“å‰è¿›ç¨‹é¡µè¡¨çš„ç‰©ç†åŸºåœ°å€ ã€‚

  ![image-20251124140904355](part3.assets/image-20251124140904355.png)

**å‘½ä¸­ (Page Hit)**

1. å¤„ç†å™¨ç”Ÿæˆä¸€ä¸ªè™šæ‹Ÿåœ°å€ (**VA**)ï¼Œå¹¶æŠŠå®ƒä¼ é€ç»™ **MMU**ã€‚
2. MMU åˆ©ç”¨PTBRå’Œè™šæ‹Ÿåœ°å€ä¸­çš„VPNè®¡ç®—å‡ºè¯¥è™šæ‹Ÿé¡µå¯¹åº”çš„PTEAã€‚

- MMU å‘é«˜é€Ÿç¼“å­˜/ä¸»å­˜å‘é€è¿™ä¸ª **PTEA**ï¼Œè¯·æ±‚è¯»å–é¡µè¡¨é¡¹ã€‚

1. é«˜é€Ÿç¼“å­˜/ä¸»å­˜å“åº”è¯¥è¯·æ±‚ï¼Œå‘ MMU è¿”å› PTEã€‚

2. MMU è¯»å– PTEï¼Œæ£€æŸ¥ æœ‰æ•ˆä½ ä¸º 1ã€‚ MMU ä» PTE ä¸­æå–PPNï¼Œå°†å…¶ä¸åŸå§‹çš„VPOæ‹¼æ¥ï¼Œæ„é€ å‡ºæœ€ç»ˆçš„PAã€‚

3. MMU å°†æ„é€ å¥½çš„ **PA** å‘é€ç»™é«˜é€Ÿç¼“å­˜/ä¸»å­˜ã€‚

4. é«˜é€Ÿç¼“å­˜/ä¸»å­˜è¯»å– **PA** å¤„çš„å†…å®¹ï¼Œå°†æ‰€è¯·æ±‚çš„ **æ•°æ®å­—** è¿”å›ç»™å¤„ç†å™¨ã€‚

> **å›å¿†ï¼š** é¡µè¡¨æ˜¯å¸¸é©»åœ¨ç‰©ç†å†…å­˜ä¸­çš„ï¼Œæ‰€ä»¥è¯·æ±‚é¡µè¡¨ä¸€å®šä¼šè§¦å‘ä¸€æ¬¡è®¿å­˜ï¼Œä¸”ï¼ˆæ­¤æ—¶ï¼‰å¿…ç„¶å‘½ä¸­ã€‚

![image-20251124141223243](part3.assets/image-20251124141223243.png)

**ç¼ºé¡µ (Page Fault)**

1. å¤„ç†å™¨ç”Ÿæˆè™šæ‹Ÿåœ°å€ (VA) å¹¶å°†å…¶å‘é€ç»™ MMUã€‚

2. MMU åˆ©ç”¨é¡µè¡¨åŸºå€å¯„å­˜å™¨ (PTBR) å’Œè™šæ‹Ÿé¡µå· (VPN) è®¡ç®—å‡ºPTEAã€‚
   - _å…¬å¼ï¼šPTEA = PTBR + (VPN \* PTEå¤§å°)_

   - MMU å‘é«˜é€Ÿç¼“å­˜/ä¸»å­˜å‘é€è¿™ä¸ª PTEAï¼Œè¯·æ±‚è¯»å–å¯¹åº”çš„é¡µè¡¨é¡¹ã€‚

3. é«˜é€Ÿç¼“å­˜/ä¸»å­˜å‘ MMU è¿”å›è¯·æ±‚çš„ **PTE**ã€‚
4. MMU æ£€æŸ¥ PTEï¼Œå‘ç° **æœ‰æ•ˆä½ä¸º 0**ï¼Œå› æ­¤è§¦å‘ç¼ºé¡µå¼‚å¸¸ (Page Fault Exception)ï¼Œå°†æ§åˆ¶æƒä» CPU ç§»äº¤ç»™å†…æ ¸çš„ç¼ºé¡µå¤„ç†ç¨‹åºã€‚
5. ç¼ºé¡µå¤„ç†ç¨‹åºåœ¨ç‰©ç†å†…å­˜ä¸­é€‰æ‹©ä¸€ä¸ª **ç‰ºç‰²é¡µ (Victim Page)**ã€‚å¦‚æœè¯¥é¡µæ˜¯â€œè„â€çš„ (Dirtyï¼Œå³è¢«ä¿®æ”¹è¿‡)ï¼Œåˆ™å…ˆå°†å…¶å†™å›ç£ç›˜ã€‚
6. ç¼ºé¡µå¤„ç†ç¨‹åºä»ç£ç›˜å°†æ–°é¡µé¢è°ƒå…¥ç‰©ç†å†…å­˜ï¼Œå¹¶æ›´æ–°å†…å­˜ä¸­çš„ PTE (è®¾ç½® Valid=1ï¼Œå¡«å…¥æ–°çš„ PPN)ã€‚
7. ç¼ºé¡µå¤„ç†ç¨‹åºè¿”å›åˆ°åŸæ¥çš„è¿›ç¨‹ï¼Œé‡å¯å¯¼è‡´ç¼ºé¡µçš„é‚£æ¡æŒ‡ä»¤ (æ­¤æ—¶å†æ¬¡æ‰§è¡Œæ­¥éª¤ 1ï¼Œå°†ä¼šå‘½ä¸­)ã€‚

> **å›å¿†ï¼š** é¡µè¡¨æ˜¯å¸¸é©»åœ¨ç‰©ç†å†…å­˜ä¸­çš„ï¼Œæ‰€ä»¥è¯·æ±‚é¡µè¡¨ä¸€å®šä¼šè§¦å‘ä¸€æ¬¡è®¿å­˜ï¼Œä¸”ï¼ˆæ­¤æ—¶ï¼‰å¿…ç„¶å‘½ä¸­ã€‚**ä½†æ˜¯ï¼Œé¡µè¡¨åœ¨ä¸ä»£è¡¨é¡µåœ¨ã€‚**

![image-20251124141236632](part3.assets/image-20251124141236632.png)

## æœ¯è¯­è¡¨

| **ç¬¦å·** | **å…¨ç§° (Full Name)**     | **ä¸­æ–‡å«ä¹‰**       | **è¯¦ç»†è§£é‡Šä¸åŠŸèƒ½**                                                                                                 |
| -------- | :----------------------- | ------------------ | ------------------------------------------------------------------------------------------------------------------ |
| **PTBR** | Page Table Base Register | **é¡µè¡¨åŸºå€å¯„å­˜å™¨** | æŒ‡å‘å½“å‰è¿›ç¨‹é¡µè¡¨åœ¨ç‰©ç†å†…å­˜ä¸­çš„èµ·å§‹ä½ç½®ã€‚CPU ä½¿ç”¨å®ƒæ¥å®šä½é¡µè¡¨ã€‚                                                     |
| **PTEA** | Page Table Entry Address | **é¡µè¡¨é¡¹åœ°å€**     | é€™æ˜¯æŒ‡å‘ç‰¹å®š PTE çš„==ç‰©ç†åœ°å€==ã€‚MMU é€šè¿‡ç»“åˆ PTBR å’Œè™šæ‹Ÿé¡µå· (VPN) è®¡ç®—å‡º PTEAï¼Œä»è€Œåœ¨å†…å­˜ä¸­æ‰¾åˆ°å¯¹åº”çš„é¡µè¡¨é¡¹ã€‚    |
| **PTE**  | Page Table Entry         | **é¡µè¡¨é¡¹**         | é¡µè¡¨ä¸­çš„ä¸€ä¸ªæ¡ç›®ï¼ˆæ•°ç»„å…ƒç´ ï¼‰ã€‚å®ƒåŒ…å«ç‰©ç†é¡µå· (PPN) å’Œæœ‰æ•ˆä½ (Valid bit) ç­‰æ§åˆ¶ä¿¡æ¯ã€‚                               |
| **PA**   | Physical Address         | **ç‰©ç†åœ°å€**       | æœ€ç»ˆå‘é€ç»™ä¸»å­˜ï¼ˆDRAMï¼‰çš„åœ°å€ã€‚å®ƒç”±ç‰©ç†é¡µå· (PPN) å’Œç‰©ç†é¡µåç§» (PPO) æ‹¼æ¥è€Œæˆã€‚                                     |
| **PPN**  | Physical Page Number     | **ç‰©ç†é¡µå·**       | ç‰©ç†åœ°å€çš„é«˜ä½éƒ¨åˆ†ã€‚å®ƒå­˜å‚¨åœ¨ PTE ä¸­ï¼ˆå¦‚æœ Valid=1ï¼‰ï¼Œè¡¨ç¤ºè™šæ‹Ÿé¡µè¢«æ˜ å°„åˆ°äº†ç‰©ç†å†…å­˜çš„å“ªä¸€é¡µã€‚                        |
| **VPO**  | Virtual Page Offset      | **è™šæ‹Ÿé¡µåç§»**     | è™šæ‹Ÿåœ°å€çš„ä½ä½éƒ¨åˆ†ã€‚å®ƒè¡¨ç¤ºæ•°æ®åœ¨é¡µé¢å†…çš„åç§»é‡ã€‚åœ¨åœ°å€ç¿»è¯‘è¿‡ç¨‹ä¸­ï¼ŒVPO ç›´æ¥å˜ä¸ºç‰©ç†é¡µåç§» (PPO)ï¼Œå³ **VPO = PPO**ã€‚ |
| **PPO**  | Physical Page Offset     | **ç‰©ç†é¡µåç§»**     | ç‰©ç†åœ°å€çš„ä½ä½éƒ¨åˆ†ã€‚å®ƒä¸ VPO å®Œå…¨ç›¸åŒï¼Œæ— éœ€ç¿»è¯‘ï¼Œç›´æ¥ä»è™šæ‹Ÿåœ°å€å¤åˆ¶è€Œæ¥ã€‚                                          |

#### å®ƒä»¬åœ¨åœ°å€ç¿»è¯‘æµç¨‹ä¸­çš„å…³ç³»

1. **VA (è™šæ‹Ÿåœ°å€)** è¢«æ‹†åˆ†ä¸º **VPN (è™šæ‹Ÿé¡µå·)** å’Œ **VPO**ã€‚
2. **PTBR** æŒ‡å‘é¡µè¡¨å¼€å¤´ï¼Œç»“åˆ VPN è®¡ç®—å‡º **PTEA**ã€‚
3. MMU è®¿é—®å†…å­˜åœ°å€ PTEAï¼Œè¯»å– **PTE**ã€‚
4. å¦‚æœ PTE æœ‰æ•ˆï¼ŒMMU ä»ä¸­æå– **PPN**ã€‚
5. **PPN** ä¸åŸå§‹çš„ **VPO** (å³ PPO) æ‹¼æ¥ï¼Œå½¢æˆæœ€ç»ˆçš„ **PA**ã€‚

```mermaid
graph TD
    %% å®šä¹‰æ ·å¼
    classDef register fill:#ff9999,stroke:#333,stroke-width:2px;
    classDef memory fill:#99ccff,stroke:#333,stroke-width:2px;
    classDef address fill:#ccffcc,stroke:#333,stroke-width:2px;
    classDef process fill:#ffffcc,stroke:#333,stroke-dasharray: 5 5;

    subgraph Virtual_Address ["è™šæ‹Ÿåœ°å€ (VA) åˆ†è§£"]
        direction LR
        VPN["VPN (è™šæ‹Ÿé¡µå·)"]:::address
        VPO["VPO (è™šæ‹Ÿé¡µåç§»)"]:::address
    end

    subgraph Translation_Process ["åœ°å€ç¿»è¯‘è¿‡ç¨‹ (MMU)"]
        PTBR[("PTBR<br>(é¡µè¡¨åŸºå€å¯„å­˜å™¨)")]:::register

        Calc_PTEA{"è®¡ç®—é¡µè¡¨é¡¹åœ°å€<br>PTEA = PTBR + (VPN * PTEå¤§å°)"}:::process

        Memory_Access[("è®¿é—®å†…å­˜ä¸­çš„é¡µè¡¨")]:::memory

        PTE_Content["PTE (é¡µè¡¨é¡¹å†…å®¹)<br>[æœ‰æ•ˆä½ | æƒé™ | PPN]"]:::memory
    end

    subgraph Physical_Address ["ç‰©ç†åœ°å€ (PA) åˆæˆ"]
        direction LR
        PPN["PPN (ç‰©ç†é¡µå·)"]:::address
        PPO["PPO (ç‰©ç†é¡µåç§»)"]:::address
        Final_PA["æœ€ç»ˆç‰©ç†åœ°å€ (PA)"]:::address
    end

    %% å…³ç³»è¿çº¿
    PTBR -->|"æä¾›åŸºå€"| Calc_PTEA
    VPN -->|"ä½œä¸ºç´¢å¼•"| Calc_PTEA

    Calc_PTEA -->|"æŒ‡å‘å†…å­˜åœ°å€ (PTEA)"| Memory_Access
    Memory_Access -->|"è¯»å–å†…å®¹"| PTE_Content

    PTE_Content -->|"æå– (å¦‚æœ Valid=1)"| PPN
    VPO -->|"ç›´æ¥å¤åˆ¶ (æ— éœ€ç¿»è¯‘)<br>VPO = PPO"| PPO

    PPN --> Final_PA
    PPO --> Final_PA


```

---

## TLB

> Translation Lookaside Buffer

> [!important]
>
> | **è®¡ç®—æ­¥éª¤**              | **TLB (é¡µè¡¨ç¼“å­˜)**                                            | **Cache (æ•°æ®ç¼“å­˜)**                                                                      |
> | ------------------------- | ------------------------------------------------------------- | ----------------------------------------------------------------------------------------- |
> | **è¾“å…¥å‚æ•°**              | 1. TLBæ€»é¡¹æ•° ($N_{entries}$) 2. ç›¸è”åº¦ ($E$) 3. **VPNæ€»ä½æ•°** | 1. ç¼“å­˜æ€»å®¹é‡ ($C_{bytes}$) 2. å—å¤§å° ($B_{bytes}$) 3. ç›¸è”åº¦ ($E$) 4. **ç‰©ç†åœ°å€æ€»ä½æ•°** |
> | **ç¬¬ä¸€æ­¥ï¼šç®— Offset**     | **æ— ** (TLBä¸å¤„ç†Offsetï¼Œç›´æ¥æ—è·¯)                            | **$\text{Offset} = \log_2(B)$** (ç”±å—å¤§å°å†³å®š)                                            |
> | **ç¬¬äºŒæ­¥ï¼šç®—ç»„æ•° (Sets)** | $$S = \frac{N_{entries}}{E}$$ (æ€»æ¡ç›® / è·¯æ•°)                 | $$S = \frac{C_{bytes}}{B \times E}$$ (æ€»å®¹é‡ / ä¸€è¡Œçš„å¤§å°)                                |
> | **ç¬¬ä¸‰æ­¥ï¼šç®— Index**      | $$\text{Index} = \log_2(S)$$                                  | $$\text{Index} = \log_2(S)$$                                                              |
> | **ç¬¬å››æ­¥ï¼šç®— Tag**        | $$\text{Tag} = \text{VPN} - \text{Index}$$                    | $$\text{Tag} = \text{PA} - \text{Index} - \text{Offset}$$                                 |

- **åŠ¨æœºï¼š** æ¯æ¬¡æ™®é€šçš„åœ°å€ç¿»è¯‘éƒ½éœ€è¦ä¸€æ¬¡é¢å¤–çš„å†…å­˜è®¿é—®ï¼ˆè¯»å– PTEï¼‰ï¼Œå¯¼è‡´æŒ‡ä»¤æ‰§è¡Œå˜æ…¢ ã€‚
- **å®šä¹‰ï¼š** MMU å†…çš„ä¸€ä¸ªå°å‹ã€å…¨ç›¸è”æˆ–ç»„ç›¸è”çš„ç¡¬ä»¶ç¼“å­˜ï¼Œä¸“é—¨ç”¨äºå­˜å‚¨ ==VPN åˆ° PPN çš„æ˜ å°„== ã€‚
  - åŠ é€Ÿä»VPNåˆ°PPNçš„æ˜ å°„é€Ÿåº¦ã€‚
- **TLB å¯»å€ï¼š**
  - å°† VPN è¿›ä¸€æ­¥æ‹†åˆ†ä¸º **TLB Tag (TLBT)** å’Œ **TLB Index (TLBI)** ã€‚
  - $T = 2^t$ ç»„ï¼ŒTLBIç”¨äºé€‰æ‹©ç»„ï¼ŒTLBTç”¨äºåŒ¹é…ç»„å†…çš„è¡Œ ã€‚
- **æ€§èƒ½å½±å“ï¼š**
  - **TLB Hit:** æ¶ˆé™¤äº†ä¸€æ¬¡å†…å­˜è®¿é—®ï¼Œç›´æ¥å¾—åˆ° PPN ã€‚
  - **TLB Miss:** éœ€è¦è®¿é—®å†…å­˜è·å– PTEï¼Œç„¶åæ›´æ–° TLBã€‚æ‰€å¹¸ç”±äºå±€éƒ¨æ€§ï¼ŒMiss å¾ˆå°‘è§ ã€‚

```mermaid
graph TD
    %% ================= æ ·å¼å®šä¹‰ =================
    classDef addrBit fill:#d5e8d4,stroke:#82b366,stroke-width:2px;
    classDef fastPath fill:#fff2cc,stroke:#d6b656,stroke-width:2px;
    classDef slowPath fill:#f8cecc,stroke:#b85450,stroke-width:2px,stroke-dasharray: 5 5;
    classDef memory fill:#dae8fc,stroke:#6c8ebf,stroke-width:2px;
    classDef finalResult fill:#e1d5e7,stroke:#9673a6,stroke-width:3px;

    %% ================= 1. è™šæ‹Ÿåœ°å€è¾“å…¥ =================
    subgraph Virtual_Address ["è™šæ‹Ÿåœ°å€ (VA) åˆ†è§£"]
        direction TB
        subgraph VPN_Group ["VPN (è™šæ‹Ÿé¡µå·)"]
            TLBT("TLBT<br>TLB æ ‡è®°"):::addrBit
            TLBI("TLBI<br>TLB ç´¢å¼•"):::addrBit
        end
        VPO("VPO<br>è™šæ‹Ÿé¡µåç§»"):::addrBit
    end

    %% ================= 2. MMU ç¡¬ä»¶å¤„ç† (TLB) =================
    subgraph MMU_Hardware ["MMU åœ°å€ç¿»è¯‘"]
        direction TB

        %% TLB é€»è¾‘
        subgraph TLB_Logic ["TLB (å¿«è¡¨)"]
            Lookup["åˆ©ç”¨ TLBI<br>é€‰æ‹©ç»„ Set"]:::fastPath
            TagCheck{"TLBT<br>åŒ¹é… Tag?"}:::fastPath
            HitOrMiss{"Valid=1<br>& å‘½ä¸­?"}:::fastPath
        end

        %% ç»“æœæš‚å­˜
        Extracted_PPN("æå– PPN"):::fastPath
    end

    %% ================= 3. å†…å­˜å¤„ç† (Miss è·¯å¾„) =================
    subgraph Physical_Memory ["ç‰©ç†å†…å­˜ (é¡µè¡¨)"]
        direction TB
        PTBR["PTBR<br>é¡µè¡¨åŸºå€"]:::memory
        PageTable["é¡µè¡¨æŸ¥è¯¢<br>PTE Access"]:::memory
        Mem_PPN("ä»å†…å­˜<br>è¯»å– PPN"):::memory
    end

    %% ================= 4. ç‰©ç†åœ°å€è¾“å‡º =================
    subgraph Physical_Address ["ç‰©ç†åœ°å€ (PA) åˆæˆ"]
        direction TB
        Final_PPN("PPN<br>ç‰©ç†é¡µå·"):::finalResult
        PPO("PPO<br>ç‰©ç†é¡µåç§»"):::finalResult
        PA_Out["æœ€ç»ˆç‰©ç†åœ°å€<br>PA"]:::finalResult
    end

    %% ================= è¿çº¿é€»è¾‘ =================

    %% --- 1. TLB å¿«é€Ÿè·¯å¾„ (ä¸»çº¿) ---
    TLBI --> Lookup
    TLBT --> TagCheck
    Lookup --> TagCheck
    TagCheck --> HitOrMiss

    HitOrMiss == "Yes (Hit)" ==> Extracted_PPN
    Extracted_PPN ==> Final_PPN

    %% --- 2. å†…å­˜æ…¢é€Ÿè·¯å¾„ (Miss) ---
    HitOrMiss -. "No (Miss)" .-> PTBR
    VPN_Group -.-> PageTable
    PTBR -.-> PageTable
    PageTable -.-> Mem_PPN
    Mem_PPN -. "æ›´æ–° TLB" .-> Extracted_PPN

    %% --- 3. åç§»é‡ç›´é€š (VPO -> PPO) ---
    VPO -------------------------> PPO

    %% --- 4. ç»“æœåˆæˆ ---
    Final_PPN --> PA_Out
    PPO --> PA_Out

    %% æ³¨é‡Šè¿æ¥
    VPO -.- |"VPO = PPO"| PPO
```

> [!note]
>
> # ğŸ“ ç¬”è®°è¡¥å……ï¼šå¤§é¡µ (Huge Pages / Superpages)
>
> ## 1. æ ¸å¿ƒé€»è¾‘ï¼šä»¥ç©ºé—´æ¢æ—¶é—´
>
> å¤§é¡µçš„æœ¬è´¨æ˜¯é€šè¿‡**ç‰ºç‰²å†…å­˜ç®¡ç†çš„ç²’åº¦**ï¼ˆå®¹æ˜“é€ æˆå†…éƒ¨ç¢ç‰‡ï¼‰ï¼Œæ¥æ¢å–**æé«˜çš„ TLB å‘½ä¸­ç‡**å’Œ**æ›´çŸ­çš„é¡µè¡¨æŸ¥è¯¢è·¯å¾„**ã€‚
>
> - **ä¸€å¥è¯åŸç†**ï¼šé€šè¿‡å‡å°‘é¡µè¡¨æŸ¥æ‰¾çš„å±‚çº§ï¼Œå°†åŸæœ¬ç”¨äºæŸ¥è¡¨çš„ç´¢å¼•ä½ï¼ˆIndexï¼‰â€œåˆ’å½’â€ç»™é¡µå†…åç§»ï¼ˆOffsetï¼‰ï¼Œä»è€ŒæŒ‡æ•°çº§æ‰©å¤§é¡µçš„å¤§å°ã€‚
>
> ---
>
> ## 2. ä¸ºä»€ä¹ˆéœ€è¦å¤§é¡µï¼Ÿ(TLB Reach é—®é¢˜)
>
> TLB æ˜¯æå…¶æ˜‚è´µçš„ç¡¬ä»¶èµ„æºï¼Œæ¡ç›®æ•°å¾ˆå°‘ï¼ˆé€šå¸¸ 64~128 é¡¹ï¼‰ã€‚
>
> - å¯¹äºæ ‡å‡†é¡µ (4KB)ï¼š
>
>   TLB è¦†ç›–æ€»å†…å­˜ = $64 \times 4\text{KB} = \mathbf{256\text{KB}}$ã€‚
>
>   (å¯¹äºå‡ ä¸ª GB çš„ç°ä»£ç¨‹åºï¼Œè¿™ç®€ç›´æ˜¯æ¯æ°´è½¦è–ªï¼Œå¯¼è‡´ TLB Miss é¢‘å‘)
>
> - å¯¹äºå¤§é¡µ (2MB)ï¼š
>
>   TLB è¦†ç›–æ€»å†…å­˜ = $64 \times 2\text{MB} = \mathbf{128\text{MB}}$ã€‚
>
>   (è¦†ç›–èŒƒå›´æ‰©å¤§ 512 å€ï¼Œè¦†ç›–äº†å¤§éƒ¨åˆ†ç¨‹åºçš„æ´»è·ƒæ•°æ®é›†)
>
> ---
>
> ## 3. å®ç°æœºåˆ¶ï¼šå±‚çº§çŸ­è·¯ (Short-circuiting)
>
> å¤§é¡µä¸éœ€è¦æ–°çš„é¡µè¡¨ç»“æ„ï¼Œå®ƒåˆ©ç”¨äº†**â€œæå‰ç»ˆæ­¢â€**çš„æœºåˆ¶ã€‚
>
> åœ¨é¡µè¡¨é¡¹ï¼ˆPTEï¼‰ä¸­é€šå¸¸æœ‰ä¸€ä¸ªæ ‡å¿—ä½ï¼ˆå¦‚ x86 çš„ PS ä½ï¼‰ï¼Œå‘Šè¯‰ MMUï¼šâ€œåˆ°è¿™å°±åœä¸‹ï¼Œåˆ«æŸ¥ä¸‹ä¸€çº§äº†ï¼Œè¿™å°±æ˜¯ç‰©ç†é¡µã€‚â€
>
> ### â€œ512å€å®šå¾‹â€ (é’ˆå¯¹ 64ä½ç³»ç»Ÿ/9ä½ç´¢å¼•)
>
> æ¯**å°‘æŸ¥ä¸€çº§**é¡µè¡¨ï¼Œé¡µå†…åç§»ï¼ˆOffsetï¼‰å°±å¢åŠ  9 ä½ï¼Œé¡µå¤§å°æ‰©å¤§ $2^9 = 512$ å€ã€‚
>
> | **é¡µç±»å‹**         | **æŸ¥æ‰¾å±‚çº§**       | **Offset ä½æ•°** | **è®¡ç®—é€»è¾‘ (Offsetæ‰©å®¹)**          | **é¡µå¤§å°** |
> | ------------------ | ------------------ | --------------- | ---------------------------------- | ---------- |
> | **æ ‡å‡†é¡µ**         | **3çº§** (L1â†’L2â†’L3) | **12ä½**        | åŸå§‹ Offset                        | **4KB**    |
> | **å¤§é¡µ (Huge)**    | **2çº§** (L1â†’L2)    | **21ä½**        | $12 + 9 \text{ (L3 Index)}$        | **2MB**    |
> | **å·¨å‹é¡µ (Giant)** | **1çº§** (L1)       | **30ä½**        | $12 + 9 + 9 \text{ (L2+L3 Index)}$ | **1GB**    |
>
> ---
>
> ## 4. åœ°å€ç»“æ„å˜åŒ–å›¾è§£ (ä»¥ SV39/x86 ä¸ºä¾‹)
>
> ### åœºæ™¯ Aï¼šæ ‡å‡† 4KB é¡µ (Offset = 12ä½)
>
> éœ€è¦æŸ¥ 3 æ¬¡è¡¨æ‰èƒ½æ‰¾åˆ°ç‰©ç†åœ°å€ã€‚
>
> ```Plaintext
> [ VPN 2 (9) ] [ VPN 1 (9) ] [ VPN 0 (9) ] | [ Offset (12) ]
>       â†“             â†“             â†“               â†“
>     æŸ¥ L1         æŸ¥ L2         æŸ¥ L3           é¡µå†…å¯»å€
> ```
>
> ### åœºæ™¯ Bï¼šå¤§é¡µ 2MB (Offset = 21ä½)
>
> åªæŸ¥ 2 æ¬¡è¡¨ï¼Œ**L3 çš„ç´¢å¼•ä½è¢« Offset åå¹¶äº†**ã€‚
>
> ```Plaintext
> [ VPN 2 (9) ] [ VPN 1 (9) ] | [      Offset (21ä½)      ]
>       â†“             â†“       | (åŒ…å«åŸ VPN 0 + åŸ Offset)
>     æŸ¥ L1      æŸ¥ L2 (ç»ˆæ­¢)
> ```
>
> ---
>
> ## 5. ä¼˜ç¼ºç‚¹æƒè¡¡ (Trade-off)
>
> ### âœ… ä¼˜åŠ¿
>
> 1. **å‡å°‘ TLB Miss**ï¼šè¿™æ˜¯æœ€ä¸»è¦çš„ç›®çš„ã€‚ä¸€æ¬¡ TLB å‘½ä¸­å°±èƒ½è¦†ç›– 2MB è¿ç»­å†…å­˜ã€‚
> 2. **å‡å°‘é¡µè¡¨æ¼«æ¸¸ (Page Walk) å¼€é”€**ï¼šæŸ¥æ‰¾ç‰©ç†åœ°å€æ—¶ï¼Œå°‘è®¿é—®ä¸€æ¬¡å†…å­˜ï¼ˆå°‘æŸ¥ä¸€çº§è¡¨ï¼‰ã€‚
> 3. **èŠ‚çœé¡µè¡¨å†…å­˜**ï¼šä¸€ä¸ªå¤§é¡µçš„ PTE åªè¦ 8 å­—èŠ‚ï¼Œè€Œè¦æ˜ å°„åŒæ ·çš„ 2MB ç©ºé—´ï¼Œæ ‡å‡†é¡µéœ€è¦ 512 ä¸ª PTEï¼ˆ4KB å¤§å°çš„é¡µè¡¨é¡µï¼‰ã€‚
>
> ### âŒ åŠ£åŠ¿
>
> 1. **å†…éƒ¨ç¢ç‰‡ (Internal Fragmentation)**ï¼šå¦‚æœä½ åªå­˜ 1KB æ•°æ®ï¼Œå´ç”³è¯·äº† 2MB çš„é¡µï¼Œå‰©ä¸‹çš„ 1.99MB å…¨éƒ¨æµªè´¹ã€‚
> 2. **åˆ†é…éš¾åº¦å¤§**ï¼šæ“ä½œç³»ç»Ÿå¾ˆéš¾åœ¨è¿è¡Œå¾ˆä¹…åæ‰¾åˆ°è¿ç»­çš„ 2MB æˆ– 1GB ç‰©ç†å†…å­˜ï¼ˆç‰©ç†å†…å­˜ç¢ç‰‡åŒ–ï¼‰ã€‚
> 3. **Swap å›°éš¾**ï¼šäº¤æ¢å¤§é¡µåˆ°ç£ç›˜éå¸¸ç¬¨é‡ã€‚
>
> ---
>
> ## 6. é€‚ç”¨åœºæ™¯
>
> - **é€‚åˆ**ï¼šæ•°æ®åº“ (MySQL, Oracle SGA), è™šæ‹Ÿæœº (KVM), AI è®­ç»ƒ (TensorFlow)ã€‚
> - **ä¸é€‚åˆ**ï¼šå¤§é‡é›¶ç¢çš„å°æ–‡ä»¶å¤„ç†ã€å†…å­˜æå…¶ç´§å¼ çš„åµŒå…¥å¼è®¾å¤‡ã€‚

---

## å¤šçº§é¡µè¡¨

- **åŠ¨æœºï¼ˆç©ºé—´é—®é¢˜ï¼‰ï¼š**
  - åœ¨å•çº§é¡µè¡¨ç³»ç»Ÿä¸­ï¼Œé¡µè¡¨å¿…é¡»æ˜¯è¿ç»­çš„å†…å­˜ç©ºé—´ã€‚å¯¹äºç°ä»£çš„ 64 ä½ç³»ç»Ÿï¼ˆç”šè‡³ 32 ä½ç³»ç»Ÿï¼‰ï¼Œè¿™ä¼šå¯¼è‡´å·¨å¤§çš„å†…å­˜æµªè´¹ï¼š
    - **å†…å­˜å ç”¨è¿‡å¤§ï¼š** å‡è®¾ä¸€ä¸ª 48 ä½åœ°å€ç©ºé—´ï¼Œé¡µå¤§å°ä¸º 4KB ($2^{12}$)ï¼ŒPTE ä¸º 8 å­—èŠ‚ã€‚å¦‚æœä¸åˆ†çº§ï¼Œéœ€è¦ $2^{48} / 2^{12} \times 8 = 2^{39}$ å­—èŠ‚ï¼Œå³ **512 GB** çš„è¿ç»­å†…å­˜æ¥å­˜æ”¾ä¸€ä¸ªè¿›ç¨‹çš„é¡µè¡¨ã€‚è¿™æ˜¯ä¸ç°å®çš„ã€‚
    - **åœ°å€ç©ºé—´ç¨€ç–æ€§ (Sparsity):** ç»å¤§å¤šæ•°è¿›ç¨‹åªä½¿ç”¨äº†è™šæ‹Ÿåœ°å€ç©ºé—´çš„ä¸€å°éƒ¨åˆ†ï¼ˆä»£ç ã€æ•°æ®ã€æ ˆï¼‰ã€‚å¦‚æœæ˜¯å•çº§é¡µè¡¨ï¼Œå³ä½¿ä¸­é—´å‡  GB çš„ç©ºé—´æ²¡è¢«ä½¿ç”¨ï¼Œé¡µè¡¨ä¸­ä¹Ÿå¿…é¡»ç•™å‡ºå¯¹åº”çš„æ¡ç›®ï¼ˆè™½ç„¶æ ‡è®°ä¸ºæ— æ•ˆï¼‰ï¼Œè¿™éå¸¸æµªè´¹ã€‚
- å¤šçº§é¡µè¡¨çš„åŸç† (Mechanism)
  - å¤šçº§é¡µè¡¨é‡‡ç”¨**å±‚æ¬¡åŒ–**çš„ç»“æ„æ¥å‹ç¼©é¡µè¡¨å¤§å°ã€‚é€šå¸¸é‡‡ç”¨ 2 çº§ã€3 çº§æˆ– 4 çº§ç»“æ„ï¼ˆLinux x86-64 ä½¿ç”¨ 4 çº§æˆ– 5 çº§ï¼‰ã€‚
  - **å±‚çº§ç»“æ„ï¼š**
    - **ä¸€çº§é¡µè¡¨ (Level 1 Page Table):** æ€»æ˜¯å¸¸é©»å†…å­˜ã€‚å®ƒçš„æ¯ä¸ªæ¡ç›® (PTE) æŒ‡å‘ä¸€ä¸ª**äºŒçº§é¡µè¡¨**çš„ç‰©ç†åŸºå€ ã€‚
    - **äºŒçº§é¡µè¡¨ (Level 2 Page Table):** å®ƒçš„æ¯ä¸ª PTE æŒ‡å‘ä¸€ä¸ª**ä¸‰çº§é¡µè¡¨**ï¼Œæˆ–è€…ç›´æ¥æŒ‡å‘æœ€ç»ˆçš„**ç‰©ç†é¡µ**ï¼ˆå–å†³äºå±‚çº§æ•°ï¼‰ã€‚

  > [!note]
  >
  > #### å…³é”®æœ¯è¯­ï¼šé¡µç›®å½•é¡¹ (PDE - Page Directory Entry)
  >
  > åœ¨å¤šçº§é¡µè¡¨æ¶æ„ä¸­ï¼Œä¸ºäº†åŒºåˆ†ä¸åŒå±‚çº§çš„é¡µè¡¨é¡¹ï¼Œé€šå¸¸å¼•å…¥ PDE çš„æ¦‚å¿µã€‚
  >
  > - **å®šä¹‰**ï¼šä½äºé«˜å±‚çº§é¡µè¡¨ï¼ˆå¦‚é¡µç›®å½•ï¼‰ä¸­çš„æ¡ç›®ã€‚
  > - **æŒ‡å‘å¯¹è±¡**ï¼šPDE å­˜å‚¨çš„æ˜¯**ä¸‹ä¸€çº§é¡µè¡¨**çš„ç‰©ç†åŸºåœ°å€ (Page Table Base Address)ï¼Œè€Œä¸æ˜¯æœ€ç»ˆæ•°æ®çš„ç‰©ç†é¡µå·ã€‚
  > - **å¯¹æ¯” PTE**ï¼š
  >   - **PDE (é¡µç›®å½•é¡¹)** $\rightarrow$ æŒ‡å‘ **é¡µè¡¨ (Metadata)**ã€‚
  >   - **PTE (é¡µè¡¨é¡¹)** $\rightarrow$ ä½äº==æœ€åä¸€çº§==ï¼ŒæŒ‡å‘ **ç‰©ç†é¡µ (Data)**ã€‚
  >
  > - **ç»“æ„**ï¼šä¸ PTE éå¸¸ç›¸ä¼¼ï¼ŒåŒ…å«ç‰©ç†åœ°å€å­—æ®µå’Œå±æ€§ä½ (Valid, R/W, User/Supervisor)ã€‚
  > - **åœ¨ç¨€ç–å†…å­˜ä¸­çš„ä½œç”¨**ï¼š
  >   - **PDE Valid=1**ï¼šè¡¨ç¤ºä¸‹ä¸€çº§é¡µè¡¨å­˜åœ¨ï¼ŒCPU ç»§ç»­æŸ¥æ‰¾ã€‚
  >   - **PDE Valid=0**ï¼šè¡¨ç¤ºå¯¹åº”çš„æ•´ä¸ª 4MB (æˆ–æ›´å¤§) è™šæ‹Ÿåœ°å€èŒƒå›´æœªè¢«ä½¿ç”¨ã€‚æ­¤æ—¶**ä¸éœ€è¦**åˆ›å»ºå¯¹åº”çš„äºŒçº§é¡µè¡¨ï¼Œä»è€Œå®ç°å†…å­˜èŠ‚çœï¼ˆçº§è”çš„ç©ºæŒ‡é’ˆï¼‰ã€‚
  >
  > - æ˜ å°„å…³ç³» (x86 32-bit ç¤ºä¾‹)ï¼š
  >
  >   $$CR3 \xrightarrow{åŸºå€} \text{é¡µç›®å½•} \xrightarrow[\text{ç´¢å¼•}]{\text{VAé«˜10ä½}} \mathbf{PDE} \xrightarrow{åŸºå€} \text{äºŒçº§é¡µè¡¨} \xrightarrow[\text{ç´¢å¼•}]{\text{VAä¸­10ä½}} PTE \xrightarrow{PPN} \text{ç‰©ç†é¡µ}$$
  - **æŒ‰éœ€åˆ†é… (èŠ‚çº¦å†…å­˜çš„å…³é”®):**
    - å¦‚æœä¸€çº§é¡µè¡¨ä¸­çš„æŸä¸ª PTE ä¸ºç©ºï¼ˆNull/Invalidï¼‰ï¼Œæ„å‘³ç€è¯¥èŒƒå›´å†…çš„æ•´ä¸ªè™šæ‹Ÿåœ°å€æ®µéƒ½æœªè¢«åˆ†é…ã€‚
      - æ­¤æ—¶ç«‹åˆ»ç»ˆæ­¢ã€‚
    - å› æ­¤ï¼Œ**ä¸éœ€è¦åˆ›å»ºå¯¹åº”çš„äºŒçº§é¡µè¡¨**ã€‚
    - ç”±äºè™šæ‹Ÿåœ°å€ç©ºé—´é€šå¸¸éå¸¸ç¨€ç–ï¼Œç»å¤§å¤šæ•°ä¸€çº§ PTE éƒ½æ˜¯ç©ºçš„ï¼Œè¿™ä½¿å¾—ä¸ä»…ä¸éœ€è¦è¿ç»­çš„å¤§å†…å­˜ï¼Œè€Œä¸”å®é™…å ç”¨çš„å†…å­˜æ€»é‡æ€¥å‰§å‡å°‘ ã€‚

- åœ°å€ç¿»è¯‘è¿‡ç¨‹ (k-level Translation)

  > ä»¥ **2çº§é¡µè¡¨** ä¸ºä¾‹ï¼Œè™šæ‹Ÿåœ°å€ (VA) è¢«åˆ’åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š**VPN 1**ã€**VPN 2** å’Œ **VPO** ã€‚
  1. **å®šä½ä¸€çº§é¡µè¡¨ï¼š** CPU è¯»å– **PTBR** (é¡µè¡¨åŸºå€å¯„å­˜å™¨)ï¼Œæ‰¾åˆ°ä¸€çº§é¡µè¡¨çš„èµ·å§‹ä½ç½®ã€‚
  2. **ä¸€çº§ç´¢å¼•ï¼š** ä½¿ç”¨ **VPN 1** ä½œä¸ºç´¢å¼•ï¼Œåœ¨ä¸€çº§é¡µè¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„ PTEã€‚
     - è¯¥ PTE åŒ…å«**äºŒçº§é¡µè¡¨**çš„åŸºåœ°å€ï¼ˆPPNï¼‰ã€‚
  3. **äºŒçº§ç´¢å¼•ï¼š** ä½¿ç”¨ **VPN 2** ä½œä¸ºç´¢å¼•ï¼Œåœ¨äºŒçº§é¡µè¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„ PTEã€‚
     - è¯¥ PTE åŒ…å«æœ€ç»ˆæ•°æ®æ‰€åœ¨çš„**ç‰©ç†é¡µå· (PPN)**ã€‚
  4. **ç‰©ç†åœ°å€åˆæˆï¼š** å°†æ­¥éª¤ 3 å¾—åˆ°çš„ **PPN** ä¸åŸå§‹çš„ **VPO** (é¡µå†…åç§») æ‹¼æ¥ï¼Œå¾—åˆ°æœ€ç»ˆç‰©ç†åœ°å€ (PA)ã€‚

> [!note]
>
> å¤šçº§é¡µè¡¨æœºåˆ¶å°±åƒä¸€æ£µæ ‘ï¼š**å¦‚æœæ ‘å¹²ï¼ˆä¸€çº§é¡µè¡¨ï¼‰çš„æŸä¸ªåˆ†æ”¯æ²¡æœ‰å‘èŠ½ï¼ˆPTEä¸ºç©ºï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªåˆ†æ”¯ä¸Šæ‰€æœ‰çš„æ ‘æï¼ˆäºŒçº§é¡µè¡¨ï¼‰å’Œæ ‘å¶ï¼ˆç‰©ç†é¡µï¼‰éƒ½ä¸ä¼šç”Ÿé•¿ï¼ˆä¸ä¼šè¢«åˆ†é…ï¼‰ã€‚**
>
> è¿™æ˜¯ä¸ºäº†è§£å†³è™šæ‹Ÿåœ°å€çš„ç¨€ç–æ€§é—®é¢˜ï¼š è™šæ‹Ÿåœ°å€ç©ºé—´éå¸¸å¤§ï¼Œä½†å¤§å¤šæ•°ç¨‹åºå®é™…åªç”¨äº†æå°‘ä¸€éƒ¨åˆ†ã€‚è¿™å¯¼è‡´åœ°å€ç©ºé—´ä¸­æœ‰å·¨å¤§çš„â€œç©ºæ´â€æˆ–â€œé—´éš™â€ã€‚
>
> å¤šçº§é¡µè¡¨åˆ©ç”¨è¿™ç§ç¨€ç–æ€§ï¼Œåªä¸ºâ€œæœ‰ç”¨â€çš„åŒºåŸŸåˆ†é…å†…å­˜ã€‚
>
> å¤šçº§é¡µè¡¨é€šè¿‡**çº§è”çš„ç©ºæŒ‡é’ˆ**ï¼Œå°†å·¨å¤§çš„çº¿æ€§ç©ºæ´å‹ç¼©ä¸ºâ€œä¸å­˜åœ¨â€ã€‚
>
> - **å•çº§é¡µè¡¨ï¼š** å¿…é¡»æŠŠâ€œç©ºåœ°â€ä¹Ÿå›´èµ·æ¥ï¼Œè™½ç„¶é‡Œé¢ä¸ç›–æˆ¿å­ï¼Œä½†åœ°çš®ï¼ˆå†…å­˜ï¼‰ä½ å¾—å…ˆå ç€ã€‚
> - **å¤šçº§é¡µè¡¨ï¼š** åªæœ‰ä½ æƒ³ç›–æˆ¿å­ï¼ˆåˆ†é…å†…å­˜ï¼‰çš„æ—¶å€™ï¼Œæˆ‘æ‰ç»™ä½ ä¸€å¼ åœ°å›¾ï¼ˆä¸‹ä¸€çº§é¡µè¡¨ï¼‰ï¼›å¦‚æœä¸æƒ³ç›–ï¼Œé‚£é‡Œå°±æ˜¯ä¸€ç‰‡è™šæ— ï¼Œä¸å ä»»ä½•èµ„æºã€‚

> example: äºŒçº§é¡µè¡¨ç¿»è¯‘æµç¨‹

```mermaid
graph TD
    %% æ ·å¼å®šä¹‰
    classDef vaPart fill:#d5e8d4,stroke:#82b366,stroke-width:2px;
    classDef tableAction fill:#dae8fc,stroke:#6c8ebf,stroke-width:2px;
    classDef result fill:#fff2cc,stroke:#d6b656,stroke-width:2px;
    classDef final fill:#e1d5e7,stroke:#9673a6,stroke-width:3px;

    subgraph Virtual_Address ["è™šæ‹Ÿåœ°å€ (VA) è¢«åˆ‡åˆ†"]
        direction LR
        VPN1("VPN 1<br>(ç”¨äºL1)"):::vaPart
        VPN2("VPN 2<br>(ç”¨äºL2)"):::vaPart
        VPO("VPO<br>(åç§»é‡)"):::vaPart
    end

    %% ç¬¬ä¸€è·³
    subgraph Step1 [ç¬¬ä¸€è·³ï¼šæŸ¥ä¸€çº§é¡µè¡¨]
        PTBR[("PTBRå¯„å­˜å™¨<br>(L1 åŸºå€)")]:::result
        L1_Lookup[("æŸ¥æ‰¾ L1 è¡¨")]:::tableAction
        Get_L2_Base("è·å¾—: äºŒçº§é¡µè¡¨åŸºå€"):::result
    end

    %% ç¬¬äºŒè·³
    subgraph Step2 [ç¬¬äºŒè·³ï¼šæŸ¥äºŒçº§é¡µè¡¨]
        L2_Lookup[("æŸ¥æ‰¾ L2 è¡¨")]:::tableAction
        Get_PPN("è·å¾—: ç‰©ç†é¡µå· (PPN)"):::result
    end

    %% æœ€ç»ˆç»“æœ
    subgraph Step3 [ç»“æœåˆæˆ]
        Final_PA("æœ€ç»ˆç‰©ç†åœ°å€ (PA)"):::final
    end

    %% è¿çº¿
    PTBR --> L1_Lookup
    VPN1 -->|"ç´¢å¼•"| L1_Lookup
    L1_Lookup --> Get_L2_Base

    Get_L2_Base -->|"æŒ‡å‘L2å¼€å¤´"| L2_Lookup
    VPN2 -->|"ç´¢å¼•"| L2_Lookup
    L2_Lookup --> Get_PPN

    Get_PPN --> Final_PA
    VPO -->|"ç›´æ¥æ‹¼æ¥"| Final_PA
```

> [!important]
>
> æ¯ä¸€çº§é¡µè¡¨å°±æ˜¯ä¸€ä¸ª $1:2^9$ çš„æ”¾å¤§å™¨ã€‚
>
> ä¸€ä¸ªé¡µè¡¨çš„å¤§å°é€šå¸¸æ˜¯ 4KB ($2^{12}$ å­—èŠ‚)ã€‚æ¯ä¸ªé¡µè¡¨é¡¹ (PTE) æ˜¯ 8 å­—èŠ‚ ($2^3$)ã€‚ å› æ­¤ï¼Œä¸€ä¸ªé¡µè¡¨å¯ä»¥åŒ…å« $2^{12} / 2^3 = 2^9 = 512$ ä¸ªæ¡ç›®ã€‚ æ‰€ä»¥ï¼Œéœ€è¦ 9 ä½ç´¢å¼•æ¥å®šä½è¿™ 512 ä¸ªæ¡ç›®ä¸­çš„æŸä¸€ä¸ªã€‚
>
> æœ€åº•å±‚é¡µè¡¨æ’å®šä¸º4kbï¼Œå¯¹åº”çš„ç‰©ç†å†…å­˜æ˜¯4kbã€‚
>
> æ¯ä¸€çº§é¡µè¡¨çš„å¤§å°ä¸º4kbï¼Œå¯ä»¥å­˜æ”¾512ä¸ªæ¡ç›®ï¼ˆPTEï¼‰ã€‚

> [!note]
>
> ### æ ¸å¿ƒé€»è¾‘æµ
>
> $$\text{VAæ€»ä½æ•°} \xrightarrow{\text{å‡å»}} \text{é¡µå†…åç§»} \xrightarrow{\text{å¾—åˆ°}} \text{VPNæ€»ä½æ•°} \xrightarrow{\text{é™¤ä»¥}} \text{æ¯çº§ç´¢å¼•ä½æ•°} \xrightarrow{\text{å¾—åˆ°}} \textbf{é¡µè¡¨çº§æ•°}$$
>
> ---
>
> ### è¯¦ç»†è®¡ç®—æ­¥éª¤
>
> #### ç¬¬ä¸€æ­¥ï¼šæ±‚â€œé¡µå†…åç§»ä½æ•°â€ (Offset)
>
> é€»è¾‘ï¼šé¡µå¤§å°å†³å®šäº†æˆ‘ä»¬éœ€è¦å¤šå°‘ä¸ª bit æ¥åœ¨é¡µå†…å¯»å€ã€‚
>
> å…¬å¼ï¼š$\log_2(\text{é¡µå¤§å°})$
>
> - _ä¾‹å­_ï¼š$4\text{KB} = 2^{12}$ï¼Œæ‰€ä»¥ Offset $= 12$ ä½ã€‚
>
> #### ç¬¬äºŒæ­¥ï¼šæ±‚â€œVPN æ€»ä½æ•°â€
>
> é€»è¾‘ï¼šè™šæ‹Ÿåœ°å€ä¸­ï¼Œé™¤äº†é¡µå†…åç§»ï¼Œå‰©ä¸‹çš„å…¨æ˜¯ç”¨æ¥æŸ¥è¡¨çš„ã€‚
>
> å…¬å¼ï¼š$\text{VAä½æ•°} - \text{Offset}$
>
> - _ä¾‹å­_ï¼š$39 - 12 = 27$ ä½ã€‚
>
> #### ç¬¬ä¸‰æ­¥ï¼šæ±‚â€œæ¯çº§é¡µè¡¨ç´¢å¼•ä½æ•°â€ (Index Width)
>
> é€»è¾‘ï¼šä¸€ä¸ªç‰©ç†é¡µï¼ˆä½œä¸ºé¡µè¡¨ï¼‰èƒ½å­˜å¤šå°‘ä¸ª PTEï¼Ÿè¿™å°±å†³å®šäº†ä¸€çº§èƒ½ç´¢å¼•å¤šå¤§èŒƒå›´ã€‚
>
> å…¬å¼ï¼š$\log_2(\text{é¡µå¤§å°} / \text{PTEå¤§å°})$
>
> - _ä¾‹å­_ï¼š$4\text{KB} / 8\text{B} = 512 = 2^9$ï¼Œæ‰€ä»¥æ¯çº§ç´¢å¼• $= 9$ ä½ã€‚
>
> #### ç¬¬å››æ­¥ï¼šæ±‚â€œé¡µè¡¨çº§æ•°â€ (Levels)
>
> é€»è¾‘ï¼šçœ‹ VPN æ€»ä½æ•°éœ€è¦åˆ‡å‡ åˆ€æ‰èƒ½è¢«â€œæ¯çº§ç´¢å¼•ä½æ•°â€æ¶ˆåŒ–å®Œã€‚
>
> å…¬å¼ï¼š$\text{VPNæ€»ä½æ•°} / \text{æ¯çº§ç´¢å¼•ä½æ•°}$
>
> - _ä¾‹å­_ï¼š$27 / 9 = 3$ çº§ã€‚

## ç®€å•å†…å­˜ç³»ç»Ÿç¤ºä¾‹

ä¸ºäº†æ·±å…¥ç†è§£åœ°å€ç¿»è¯‘çš„æµç¨‹ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå…·ä½“çš„ç®€åŒ–å†…å­˜ç³»ç»Ÿç¤ºä¾‹ã€‚

#### 1\. ç³»ç»Ÿå‚æ•°

- **è™šæ‹Ÿåœ°å€ (VA):** 14 ä½
- **ç‰©ç†åœ°å€ (PA):** 12 ä½
- **é¡µå¤§å° (Page Size):** 64 å­—èŠ‚ ($2^6$)

![image-20251127142753937](part3.assets/image-20251127142753937.png)

**åœ°å€åˆ’åˆ†ï¼š**

- **è™šæ‹Ÿåœ°å€åˆ†è§£ (14 bits):**
  - **VPO (Virtual Page Offset):** ä½ 6 ä½ (ä¸é¡µå¤§å°ä¸€è‡´)ã€‚
  - **VPN (Virtual Page Number):** é«˜ 8 ä½ (14 - 6)ã€‚
- **ç‰©ç†åœ°å€åˆ†è§£ (12 bits):**
  - **PPO (Physical Page Offset):** ä½ 6 ä½ (ä¸ VPO ç›¸åŒ)ã€‚
  - **PPN (Physical Page Number):** é«˜ 6 ä½ (12 - 6)ã€‚

#### 2\. ç¡¬ä»¶ç»“æ„

**TLB (Translation Lookaside Buffer):**

- **é…ç½®:** 16 ä¸ªæ¡ç›®ï¼Œ4 è·¯ç»„ç›¸è” (4-way associative)ã€‚
- **ç»„æ•° (Sets):** $16 / 4 = 4$ ç»„ã€‚
- **ç´¢å¼•:**
  - **TLBI (Index):** 2 ä½ (é€‰æ‹© 4 ä¸ªç»„ä¹‹ä¸€)ã€‚
  - **TLBT (Tag):** 6 ä½ (VPN çš„å‰©ä½™é«˜ä½: 8 - 2)ã€‚

![image-20251127142813428](part3.assets/image-20251127142813428.png)

**Cache (L1):**

- **é…ç½®:** 16 è¡Œ (Lines)ï¼Œå—å¤§å° 4 å­—èŠ‚ï¼Œç›´æ¥æ˜ å°„ (Direct mapped)ã€‚
- **ç»„æ•° (Sets):** 16 ç»„ (å› ä¸ºæ˜¯ç›´æ¥æ˜ å°„ï¼Œè¡Œæ•°å³ç»„æ•°)ã€‚
- **ç´¢å¼•:**
  - **CO (Block Offset):** 2 ä½ ($2^2=4$ å­—èŠ‚)ã€‚
  - **CI (Index):** 4 ä½ ($2^4=16$ ç»„)ã€‚
  - **CT (Tag):** 6 ä½ (PAå‰©ä½™ä½: 12 - 4 - 2)ã€‚

![image-20251127143030964](part3.assets/image-20251127143030964.png)

#### 3\. åœ°å€ç¿»è¯‘å®ä¾‹

##### æ¡ˆä¾‹ A: TLB å‘½ä¸­ï¼ŒCache å‘½ä¸­

![image-20251127143151599](part3.assets/image-20251127143151599.png)

![image-20251127143203129](part3.assets/image-20251127143203129.png)

##### æ¡ˆä¾‹ B: TLB æœªå‘½ä¸­ï¼ŒCache æœªå‘½ä¸­

![image-20251127143245222](part3.assets/image-20251127143245222.png)

![image-20251127143310800](part3.assets/image-20251127143310800.png)

## Intel Core i7/Linuxå†…å­˜ç³»ç»Ÿ

#### 1\. ç¡¬ä»¶ç»“æ„ (Core i7)

Intel Core i7 é‡‡ç”¨äº†å¤æ‚çš„å±‚æ¬¡åŒ–å†…å­˜æ¶æ„ï¼š

- **å¤„ç†å™¨åŒ… (Package):** åŒ…å« 4 ä¸ªæ ¸å¿ƒã€‚
- **ç¼“å­˜å±‚æ¬¡:**
  - **L1:** æ¯ä¸ªæ ¸å¿ƒç‹¬äº«ï¼Œåˆ†ä¸ºæŒ‡ä»¤ç¼“å­˜ (i-cache) å’Œæ•°æ®ç¼“å­˜ (d-cache)ï¼Œé€šå¸¸ 32KBï¼Œ8è·¯ç»„ç›¸è”ã€‚
  - **L2:** æ¯ä¸ªæ ¸å¿ƒç‹¬äº«ï¼Œ256KBï¼Œ8è·¯ç»„ç›¸è”ã€‚
  - **L3:** æ‰€æœ‰æ ¸å¿ƒå…±äº«ï¼Œ8MBï¼Œ16è·¯ç»„ç›¸è”ã€‚
- **MMU (å†…å­˜ç®¡ç†å•å…ƒ):**
  - **L1 TLB:** åˆ†ç¦»çš„ i-TLB (128æ¡ç›®) å’Œ d-TLB (64æ¡ç›®)ã€‚
  - **L2 TLB:** ç»Ÿä¸€ TLB (512æ¡ç›®)ã€‚

![image-20251127143512505](part3.assets/image-20251127143512505.png)

#### 2\. 4çº§é¡µè¡¨ç»“æ„

Core i7 ä½¿ç”¨ 4 çº§é¡µè¡¨å±‚æ¬¡ç»“æ„æ¥æ”¯æŒ 48 ä½çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚

![image-20251127143812213](part3.assets/image-20251127143812213.png)

- **CR3 å¯„å­˜å™¨:** æŒ‡å‘ä¸€çº§é¡µè¡¨ (L1 Page Table, æˆ– PGD) çš„ç‰©ç†åŸºå€ã€‚

> [!important]
>
> æ³¨æ„æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„ç‰©ç†åŸºå€ï¼Œåˆ‡æ¢è¿›ç¨‹ä¼šæ”¹å˜CR3çš„å€¼ã€‚
>
> CR3 é‡Œå­˜çš„ä¸€å®šæ˜¯**ç‰©ç†åœ°å€ (Physical Address)**ã€‚
>
> **è¿›ç¨‹åˆ‡æ¢çš„æ€§èƒ½æˆæœ¬ï¼š** å½“ OS åˆ‡æ¢è¿›ç¨‹ï¼ˆä¸Šä¸‹æ–‡åˆ‡æ¢ï¼‰æ—¶ï¼Œå¿…é¡»æ›´æ–° CR3 å¯„å­˜å™¨ã€‚è¿™ä¼šå¯¼è‡´ CPU **éšå¼å†²åˆ·ï¼ˆæ¸…ç©ºï¼‰TLB**ï¼ˆé™¤éä½¿ç”¨ PCID ç‰¹æ€§ï¼‰ã€‚
>
> **åæœ**ï¼šåˆ‡æ¢åçš„çŸ­æ—¶é—´å†…ï¼Œæ–°è¿›ç¨‹ä¼šé¢ä¸´å¤§é‡çš„ **TLB Miss**ï¼Œå¯¼è‡´æ€§èƒ½æš‚æ—¶ä¸‹é™ï¼ˆä¸å¾—ä¸å»å†…å­˜æ¼«æ¸¸ï¼‰ï¼Œç›´åˆ° TLB é‡æ–°è¢«å¡«æ»¡ï¼ˆWarm upï¼‰ã€‚

- **å±‚çº§:**
  1. **PGD (Page Global Directory):** ç´¢å¼• VPN1 (9ä½)ã€‚
  2. **PUD (Page Upper Directory):** ç´¢å¼• VPN2 (9ä½)ã€‚
  3. **PMD (Page Middle Directory):** ç´¢å¼• VPN3 (9ä½)ã€‚
  4. **PT (Page Table):** ç´¢å¼• VPN4 (9ä½)ã€‚

![image-20251127144003807](part3.assets/image-20251127144003807.png)

- **PTE å…³é”®ä½ (Page Table Entry Bits):**
  - **P (Present):** é¡µæ˜¯å¦åœ¨å†…å­˜ä¸­ã€‚
  - **R/W (Read/Write):** è¯»å†™æƒé™ (0=åªè¯»)ã€‚
  - **U/S (User/Supervisor):** ç”¨æˆ·/å†…æ ¸æ¨¡å¼æƒé™ (0=ä»…å†…æ ¸)ã€‚
  - **WT (Write-Through):** å†™é€æˆ–å†™å›ç­–ç•¥ã€‚
  - **A (Accessed):** å¼•ç”¨ä½ (ç”¨äºæ›¿æ¢ç®—æ³•)ã€‚
  - **D (Dirty):** è„ä½ (ä»…åœ¨ L4 PTE ä¸­ï¼Œè¡¨ç¤ºé¡µé¢è¢«ä¿®æ”¹è¿‡)ã€‚
  - **XD (Execute Disable):** ç¦æ­¢æ‰§è¡Œä½ (é˜²æ­¢ç¼“å†²åŒºæº¢å‡ºæ”»å‡»)ã€‚

![image-20251127143901816](part3.assets/image-20251127143901816.png)

#### 3\. L1 Cache çš„è®¿é—®ä¼˜åŒ–

- **é—®é¢˜:** åœ°å€ç¿»è¯‘ (VA -\> PA) å’Œ L1 Cache è®¿é—® (ä½¿ç”¨ PA) æ˜¯ä¸²è¡Œçš„ï¼Œå¯èƒ½å¾ˆæ…¢ã€‚
- **æŠ€å·§:** **è™šæ‹Ÿç´¢å¼•ï¼Œç‰©ç†æ ‡è®° (Virtually Indexed, Physically Tagged, VIPT)**ã€‚
- **åŸç†:**
  - è™šæ‹Ÿåœ°å€çš„ VPO (é¡µå†…åç§») å’Œç‰©ç†åœ°å€çš„ PPO æ˜¯å®Œå…¨ç›¸åŒçš„ã€‚
  - L1 Cache çš„ç´¢å¼•ä½ (CI) é€šå¸¸å®Œå…¨åŒ…å«åœ¨ VPO çš„èŒƒå›´å†…ã€‚
  - å› æ­¤ï¼ŒCPU å¯ä»¥**å¹¶è¡Œ**åœ°è¿›è¡Œ TLB æŸ¥æ‰¾ (è·å– PPN) å’Œ L1 Cache ç´¢å¼• (ä½¿ç”¨ VPO ä¸­çš„ä½ä½œä¸º CI)ã€‚
  - å½“ TLB è¿”å› PPN (å³ CT) æ—¶ï¼ŒCache åˆšå¥½è¯»å‡º Tagï¼Œä¸¤è€…è¿›è¡Œæ¯”è¾ƒç¡®è®¤æ˜¯å¦å‘½ä¸­ã€‚

![image-20251127144107266](part3.assets/image-20251127144107266.png)

> ### è™šæ‹Ÿåœ°å€å¯»å€çš„ Cache (Virtual Cache)
>
> - **æ¦‚å¿µ:** Cache çš„ç´¢å¼•å’Œæ ‡è®°éƒ½ä½¿ç”¨è™šæ‹Ÿåœ°å€ (VIVT)ã€‚
> - **ä¼˜ç‚¹:** é€Ÿåº¦æœ€å¿«ï¼Œå®Œå…¨ä¸éœ€è¦ç­‰å¾… TLBã€‚
> - **ç¼ºç‚¹/é—®é¢˜:**
>   1. **åŒåå¼‚ç‰© (Homonyms):** ä¸åŒè¿›ç¨‹çš„ç›¸åŒè™šæ‹Ÿåœ°å€æ˜ å°„åˆ°ä¸åŒç‰©ç†åœ°å€ã€‚åˆ‡æ¢è¿›ç¨‹æ—¶éœ€æ¸…ç©º Cacheã€‚
>   2. **å¼‚ååŒç‰© (Synonyms/Aliasing):** å¤šä¸ªè™šæ‹Ÿåœ°å€æ˜ å°„åˆ°åŒä¸€ç‰©ç†åœ°å€ï¼ˆå¦‚å…±äº«å†…å­˜ï¼‰ã€‚ä¼šå¯¼è‡´ Cache ä¸­å­˜åœ¨å¤šä»½æ•°æ®å‰¯æœ¬ï¼Œå¼•å‘ä¸€è‡´æ€§é—®é¢˜ã€‚
> - **å®ä¾‹:** æ—©æœŸçš„ MIPS R4000 æˆ– StrongARM å¤„ç†å™¨æ›¾ä½¿ç”¨ VIVTï¼Œä½†ç°ä»£å¤„ç†å™¨å¤šé‡‡ç”¨ VIPTã€‚

## Linuxè™šæ‹Ÿå†…å­˜ç³»ç»Ÿ

![image-20251203194853599](part3.assets/image-20251203194853599.png)

#### 1\. è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸ

Linux å°†è™šæ‹Ÿå†…å­˜ç»„ç»‡ä¸ºä¸€ç³»åˆ—çš„â€œåŒºåŸŸ (Areas)â€æˆ–â€œæ®µ (Segments)â€ã€‚

- **`task_struct`:** å†…æ ¸ä¸­è¡¨ç¤ºè¿›ç¨‹çš„æ•°æ®ç»“æ„ã€‚
- **`mm_struct`:** æè¿°è™šæ‹Ÿå†…å­˜çŠ¶æ€ã€‚
  - `pgd`: æŒ‡å‘ä¸€çº§é¡µè¡¨åŸºå€ã€‚
  - `mmap`: æŒ‡å‘ `vm_area_struct` é“¾è¡¨çš„æŒ‡é’ˆã€‚
- **`vm_area_struct`:** æè¿°ä¸€ä¸ªè¿ç»­çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸ (å¦‚ä»£ç æ®µã€æ•°æ®æ®µã€å…±äº«åº“ã€æ ˆ)ã€‚
  - `vm_start`, `vm_end`: åŒºåŸŸçš„èµ·å§‹å’Œç»“æŸåœ°å€ã€‚
  - `vm_prot`: è¯»/å†™/æ‰§è¡Œæƒé™ã€‚
  - `vm_flags`: å…±äº«/ç§æœ‰ç­‰æ ‡å¿—ã€‚

![image-20251127144225010](part3.assets/image-20251127144225010.png)

#### 2\. Linux ç¼ºé¡µå¼‚å¸¸å¤„ç†æµç¨‹

å½“å‘ç”Ÿç¼ºé¡µå¼‚å¸¸æ—¶ï¼Œå†…æ ¸å¤„ç†ç¨‹åºæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. **åœ°å€åˆæ³•æ€§æ£€æŸ¥:**
    - è®¿é—®çš„è™šæ‹Ÿåœ°å€æ˜¯å¦åœ¨æŸä¸ª `vm_area_struct` å®šä¹‰çš„åŒºåŸŸå†…ï¼Ÿ
    - å¦‚æœä¸åœ¨ -\> **Segmentation Fault** (æ®µé”™è¯¯)ã€‚
2. **æƒé™æ£€æŸ¥:**
    - è¿›ç¨‹æ˜¯å¦æœ‰æƒé™è¿›è¡Œè¯¥æ“ä½œ (å¦‚å†™åªè¯»é¡µé¢)ï¼Ÿ
    - å¦‚æœæ— æƒé™ -\> **Protection Exception** (ä¿æŠ¤å¼‚å¸¸ï¼Œä¹ŸæŠ¥å‘Šä¸º Segmentation Fault)ã€‚
3. **åˆæ³•ç¼ºé¡µå¤„ç†:**
    - å¦‚æœé€šè¿‡ä»¥ä¸Šæ£€æŸ¥ï¼Œè¯´æ˜æ˜¯åˆæ³•çš„ç¼ºé¡µã€‚
    - é€‰æ‹©ç‰ºç‰²é¡µ (Victim)ï¼Œæ¢å‡º (å¦‚æœè„)ï¼Œæ¢å…¥æ–°é¡µï¼Œæ›´æ–°é¡µè¡¨ã€‚

![image-20251127144336622](part3.assets/image-20251127144336622.png)

## å†…å­˜æ˜ å°„

#### å†…å­˜æ˜ å°„çš„æ¦‚å¿µ

å†…å­˜æ˜ å°„ (Memory Mapping) æ˜¯å°†è™šæ‹Ÿå†…å­˜åŒºåŸŸä¸ç£ç›˜ä¸Šçš„å¯¹è±¡å…³è”èµ·æ¥çš„è¿‡ç¨‹ã€‚

- **æ˜ å°„å¯¹è±¡ç±»å‹:**
  - **æ™®é€šæ–‡ä»¶ (Regular File):** æ–‡ä»¶çš„ä¸€æ®µè¿ç»­å­—èŠ‚ (å¦‚å¯æ‰§è¡Œæ–‡ä»¶)ã€‚
  - **åŒ¿åæ–‡ä»¶ (Anonymous File):** ç”±å†…æ ¸åˆ›å»ºçš„å…¨ 0 åŒºåŸŸ (å¦‚å †ã€æ ˆ)ã€‚é¦–æ¬¡è®¿é—®æ—¶åˆ†é…ç‰©ç†é¡µå¹¶æ¸…é›¶ (Demand-zero page)ã€‚

#### å…±äº«å¯¹è±¡ä¸ç§æœ‰å¯¹è±¡

- **å…±äº«å¯¹è±¡ (Shared Objects):**
  - ä½¿ç”¨ `MAP_SHARED` æ ‡å¿—ã€‚
  - å¤šä¸ªè¿›ç¨‹æ˜ å°„åŒä¸€ä¸ªå¯¹è±¡ï¼Œå…±äº«ç›¸åŒçš„ç‰©ç†é¡µé¢ã€‚
  - ä¸€ä¸ªè¿›ç¨‹çš„ä¿®æ”¹å¯¹å…¶ä»–è¿›ç¨‹**å¯è§**ã€‚
- **ç§æœ‰å†™æ—¶å¤åˆ¶å¯¹è±¡ (Private Copy-on-write Objects):**
  - ä½¿ç”¨ `MAP_PRIVATE` æ ‡å¿—ã€‚
  - **COW (Copy-On-Write) æœºåˆ¶:**
    - ä¸¤ä¸ªè¿›ç¨‹æœ€åˆå…±äº«ç›¸åŒçš„ç‰©ç†é¡µé¢ï¼Œä½†åœ¨é¡µè¡¨ä¸­æ ‡è®°ä¸º**åªè¯»**ã€‚
    - å½“ä»»ä¸€è¿›ç¨‹å°è¯•**å†™**è¯¥é¡µé¢æ—¶ï¼Œè§¦å‘ä¿æŠ¤æ•…éšœã€‚
    - å†…æ ¸åœ¨ç‰©ç†å†…å­˜ä¸­åˆ›å»ºè¯¥é¡µé¢çš„**æ–°å‰¯æœ¬**ï¼Œæ›´æ–°é¡µè¡¨æŒ‡å‘æ–°å‰¯æœ¬ï¼Œå¹¶æ¢å¤å†™æƒé™ã€‚
  - **ä¼˜åŠ¿:** å°½å¯èƒ½æ¨è¿Ÿæ‹·è´ï¼ŒèŠ‚çœå†…å­˜ã€‚

#### `fork` å’Œ `execve`

- **`fork()`:**
  - ä¸å¤åˆ¶ç‰©ç†å†…å­˜ã€‚
  - å¤åˆ¶çˆ¶è¿›ç¨‹çš„ `mm_struct`, `vm_area_struct` å’Œé¡µè¡¨ã€‚
  - å°†ä¸¤ä¸ªè¿›ç¨‹çš„æ‰€æœ‰é¡µé¢éƒ½æ ‡è®°ä¸º **åªè¯» (Read-only)**ã€‚
  - å°†ä¸¤ä¸ªè¿›ç¨‹çš„æ‰€æœ‰åŒºåŸŸéƒ½æ ‡è®°ä¸º **ç§æœ‰å†™æ—¶å¤åˆ¶ (Private COW)**ã€‚
- **`execve()`:**
  - åˆ é™¤å½“å‰è¿›ç¨‹çš„æ‰€æœ‰æ—§ç”¨æˆ·åŒºåŸŸã€‚
  - æ˜ å°„æ–°çš„ç§æœ‰åŒºåŸŸ (ä»£ç ã€æ•°æ®)ã€‚
  - æ˜ å°„æ–°çš„åŒ¿ååŒºåŸŸ (bssã€æ ˆ)ã€‚
  - è®¾ç½® PC æŒ‡å‘å…¥å£ç‚¹ã€‚

#### ç”¨æˆ·çº§å†…å­˜æ˜ å°„ (`mmap`)

åº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨ `mmap` ç³»ç»Ÿè°ƒç”¨æ‰‹åŠ¨åˆ›å»ºæ˜ å°„ã€‚

```c
void *mmap(void *start, size_t length, int prot, int flags, int fd, off_t offset);
```

- **å‚æ•°:**
  - `prot`: `PROT_READ`, `PROT_WRITE`, `PROT_EXEC`.
  - `flags`: `MAP_ANON`, `MAP_PRIVATE`, `MAP_SHARED`.
- **ç”¨é€”:**
  - è¯»å–å¤§æ–‡ä»¶ (é¿å…è¯»å…¥ç”¨æˆ·ç¼“å†²åŒº)ã€‚
  - å®ç°é«˜æ€§èƒ½çš„å…±äº«æ•°æ®ç»“æ„ã€‚
  - åœ¨ Attack Lab ä¸­åˆ†é…å¯æ‰§è¡Œçš„å†…å­˜åŒºåŸŸã€‚

# Dynamic Memory Allocation

## 1. åŸºç¡€æ¦‚å¿µ (Basic Concepts)

### 1.1 åŠ¨æ€å†…å­˜åˆ†é…å™¨çš„ä½œç”¨

ç¨‹åºå‘˜åœ¨è¿è¡Œæ—¶ä½¿ç”¨åŠ¨æ€å†…å­˜åˆ†é…å™¨ï¼ˆå¦‚ `malloc`ï¼‰è·å–è™šæ‹Ÿå†…å­˜ã€‚åˆ†é…å™¨ç®¡ç†è¿›ç¨‹è™šæ‹Ÿå†…å­˜ä¸­çš„**å † (Heap)** åŒºåŸŸã€‚

- **åˆ†é…å™¨ç±»å‹**ï¼š
  - **æ˜¾å¼åˆ†é…å™¨ (Explicit Allocator)**ï¼šåº”ç”¨æ˜¾å¼åœ°åˆ†é…å’Œé‡Šæ”¾ç©ºé—´ï¼ˆå¦‚ C è¯­è¨€çš„ `malloc` å’Œ `free`ï¼‰ã€‚
  - **éšå¼åˆ†é…å™¨ (Implicit Allocator)**ï¼šåº”ç”¨åªè´Ÿè´£åˆ†é…ï¼Œç”±åˆ†é…å™¨ï¼ˆåƒåœ¾å›æ”¶å™¨ï¼‰è´Ÿè´£é‡Šæ”¾ï¼ˆå¦‚ Java çš„ `new` å’Œ Garbage Collectionï¼‰ã€‚

### 1.2 å †çš„ç»“æ„

- å †æ˜¯å‘é«˜åœ°å€å¢é•¿çš„åŒºåŸŸï¼Œé€šå¸¸ä½äºæœªåˆå§‹åŒ–æ•°æ®æ®µï¼ˆ.bssï¼‰ä¹‹ä¸Šï¼Œç”¨æˆ·æ ˆä¹‹ä¸‹ã€‚
- å†…æ ¸ç»´æŠ¤ä¸€ä¸ªå˜é‡ `brk` (break)ï¼ŒæŒ‡å‘å †çš„é¡¶éƒ¨ã€‚
- åˆ†é…å™¨å°†å †è§†ä¸ºä¸€ç»„ä¸åŒå¤§å°çš„**å— (blocks)**ï¼Œæ¯ä¸ªå—è¦ä¹ˆæ˜¯**å·²åˆ†é…çš„ (allocated)**ï¼Œè¦ä¹ˆæ˜¯**ç©ºé—²çš„ (free)**ã€‚

### 1.3 `malloc` æ¥å£ (Cè¯­è¨€)

> [!warning]
>
> æŒ‰ç…§**å­—èŠ‚**==byte==çš„ç²’åº¦å­˜å‚¨

- `void *malloc(size_t size)`:
  - æˆåŠŸï¼šè¿”å›æŒ‡å‘è‡³å°‘ `size` å­—èŠ‚çš„å†…å­˜å—æŒ‡é’ˆï¼Œé€šå¸¸æŒ‰ **16å­—èŠ‚å¯¹é½** (x86-64)ã€‚
  - ==æ³¨æ„ä½¿ç”¨å‰éœ€è¦åˆå§‹åŒ–==
  - å¤±è´¥ï¼šè¿”å› NULL å¹¶è®¾ç½® `errno`ã€‚
- `void free(void *p)`: å°† `p` æŒ‡å‘çš„å—è¿”å›ç»™ç©ºé—²æ± ã€‚`p` å¿…é¡»æ˜¯ä¹‹å‰ `malloc/calloc/realloc` çš„è¿”å›å€¼ã€‚
- `sbrk()`: åˆ†é…å™¨å†…éƒ¨ç”¨äºæ‰©å±•æˆ–æ”¶ç¼©å †çš„ç³»ç»Ÿè°ƒç”¨ã€‚

> [!note]
>
> `calloc`:`malloc`è·å¾—å—ä¹‹ååˆå§‹åŒ–ä¸º0
>
> `readlloc`ï¼šæ›´æ”¹ä¹‹å‰å·²ç»åˆ†é…çš„å—çš„å¤§å°

---

## 2. æ€§èƒ½ç›®æ ‡ä¸ç¢ç‰‡ (Performance & Fragmentation)

### 2.1 æ€§èƒ½æŒ‡æ ‡

åˆ†é…å™¨éœ€è¦åœ¨ä¸¤ä¸ªç›¸äº’å†²çªçš„ç›®æ ‡ä¹‹é—´å¯»æ‰¾å¹³è¡¡ï¼š

1. **ååç‡ (Throughput)**ï¼šå•ä½æ—¶é—´å†…å®Œæˆçš„è¯·æ±‚ï¼ˆmalloc/freeï¼‰æ•°é‡ã€‚
2. **å†…å­˜åˆ©ç”¨ç‡ (Memory Utilization)**ï¼šå³°å€¼åˆ©ç”¨ç‡ = (æ‰€æœ‰å·²åˆ†é…å—çš„æœ‰æ•ˆè½½è·æ€»å’Œ) / (å½“å‰å †çš„å¤§å°)ã€‚

### 2.2 ç¢ç‰‡ (Fragmentation)

ç¢ç‰‡æ˜¯å¯¼è‡´å†…å­˜åˆ©ç”¨ç‡ä½ä¸‹çš„ä¸»è¦åŸå› ã€‚

- **å†…éƒ¨ç¢ç‰‡ (Internal Fragmentation)**ï¼š
  - å®šä¹‰ï¼šå·²åˆ†é…å—çš„å¤§å° > æœ‰æ•ˆè½½è· (Payload) çš„å¤§å°ã€‚
  - åŸå› ï¼šå¯¹é½è¦æ±‚ï¼ˆPaddingï¼‰ã€ç»´æŠ¤å †æ‰€éœ€çš„æ•°æ®ç»“æ„ï¼ˆHeader/Footerï¼‰ã€åˆ†é…ç­–ç•¥å†³ç­–ã€‚
  - ç‰¹ç‚¹ï¼šä»…å–å†³äºä¹‹å‰çš„è¯·æ±‚æ¨¡å¼ï¼Œæ˜“äºæµ‹é‡ã€‚

```mermaid
block-beta
    block:Container
        columns 4
        %% å—çš„ç»„æˆéƒ¨åˆ†
        Header["Header<br/>(å¼€é”€)"]
        Payload["Payload<br/>(ç”¨æˆ·æ•°æ®)"]
        Padding["Padding<br/>(å†…éƒ¨ç¢ç‰‡)"]
        Footer["Footer<br/>(å¼€é”€)"]
    end

    %% æ ·å¼è®¾ç½®
    style Header fill:#ffcccc,stroke:#333
    style Payload fill:#ccffcc,stroke:#333
    style Padding fill:#888888,stroke:#333,color:#fff
    style Footer fill:#ffcccc,stroke:#333
```

- **å¤–éƒ¨ç¢ç‰‡ (External Fragmentation)**ï¼š
  - å®šä¹‰ï¼šå †ä¸­æ€»ç©ºé—²å†…å­˜è¶³å¤Ÿæ»¡è¶³è¯·æ±‚ï¼Œä½†æ²¡æœ‰å•ä¸ªè¿ç»­çš„ç©ºé—²å—è¶³å¤Ÿå¤§ã€‚
  - ç‰¹ç‚¹ï¼šå–å†³äºæœªæ¥çš„è¯·æ±‚æ¨¡å¼ï¼Œéš¾ä»¥æµ‹é‡ã€‚

```mermaid
graph TD
    %% æ ·å¼å®šä¹‰
    classDef allocated fill:#cccccc,stroke:#333,stroke-width:1px;
    classDef free fill:#ccffcc,stroke:#090,stroke-width:2px;
    classDef request fill:#ffcccc,stroke:#d00,stroke-width:2px,stroke-dasharray: 5 5;
    classDef note fill:#fff,stroke:#fff;

    subgraph Heap
        direction LR
        B1[å·²åˆ†é…å—]:::allocated
        F1[ç©ºé—²å— A: 200]:::free
        B2[å·²åˆ†é…å—]:::allocated
        F2[ç©ºé—²å— B: 200]:::free

        %% å¸ƒå±€è¿æ¥
        B1 ~~~ F1 ~~~ B2 ~~~ F2
    end

    Req(æ–°è¯·æ±‚: 300):::request

    %% é€»è¾‘è¿æ¥
    Req --"200 < 300 (æ”¾ä¸ä¸‹)"--> F1
    Req --"200 < 300 (æ”¾ä¸ä¸‹)"--> F2
```

---

## 3. å®ç°ç­–ç•¥ä¸€ï¼šéšå¼ç©ºé—²é“¾è¡¨ (Implicit Free Lists)

### 3.1 å—çš„æ ¼å¼ (Block Format)

ä¸ºäº†è·Ÿè¸ªå†…å­˜ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“å—çš„å¤§å°å’ŒçŠ¶æ€ï¼ˆåˆ†é…/ç©ºé—²ï¼‰ã€‚

- **Header (å¤´éƒ¨)**ï¼šé€šå¸¸ä¸º1ä¸ªå­—ï¼ˆ4æˆ–8å­—èŠ‚ï¼‰ã€‚
  - å­˜å‚¨å†…å®¹ï¼šå—å¤§å° (Block Size) + åˆ†é…ä½ (Allocated Bit, `a`)ã€‚
  - **æŠ€å·§**ï¼šç”±äºå—å¤§å°å¿…é¡»æ˜¯åŒå­—å¯¹é½ï¼ˆæ¯”å¦‚8æˆ–16çš„å€æ•°ï¼‰ï¼Œä½ä½åœ°å€ä½æ€»æ˜¯0ã€‚åˆ©ç”¨æœ€ä½ä½ï¼ˆLSBï¼‰å­˜å‚¨åˆ†é…çŠ¶æ€ï¼ˆ1=å·²åˆ†é…ï¼Œ0=ç©ºé—²ï¼‰ã€‚
  - è¯»å–å¤§å°ï¼š`Header & ~0x7` (å‡è®¾8å­—èŠ‚å¯¹é½)ã€‚
  - è¯»å–çŠ¶æ€ï¼š`Header & 0x1`ã€‚
- **Payload (è½½è·)**ï¼šç¨‹åºå®é™…ä½¿ç”¨çš„æ•°æ®ã€‚
- **Padding (å¡«å……)**ï¼šç”¨äºæ»¡è¶³å¯¹é½è¦æ±‚ã€‚

```mermaid
graph TD
    %% æ ·å¼å®šä¹‰
    classDef header fill:#ffcccc,stroke:#333,stroke-width:2px;
    classDef payload fill:#ccffcc,stroke:#333,stroke-width:2px;
    classDef padding fill:#eeeeee,stroke:#333,stroke-width:2px;
    classDef unused fill:#ffffff,stroke:#333,stroke-width:2px,stroke-dasharray: 5 5;

    subgraph Allocated ["Allocated Block"]
        direction TB
        H1["Header (å¤´éƒ¨): å—å¤§å° | a=1"]:::header
        P1["Payload (æœ‰æ•ˆè½½è·): ç”¨æˆ·æ•°æ®"]:::payload
        Pad1["Padding (å¡«å……): å¯¹é½ç”¨"]:::padding
    end

    subgraph Free ["Free Block"]
        direction TB
        H2["Header (å¤´éƒ¨): å—å¤§å° | a=0"]:::header
        U2["Unused (æœªä½¿ç”¨ç©ºé—´)"]:::unused
    end

    %% å¸ƒå±€è¾…åŠ©
    H1 ~~~ P1 ~~~ Pad1
    H2 ~~~ U2
```

### 3.2 éšå¼é“¾è¡¨çš„ç»“æ„

- æ‰€è°“â€œéšå¼â€ï¼Œæ˜¯æŒ‡ç©ºé—²å—æ²¡æœ‰ä¸“é—¨çš„æŒ‡é’ˆé“¾æ¥ï¼Œè€Œæ˜¯é€šè¿‡éå†æ•´ä¸ªå †ï¼ˆåˆ©ç”¨Headerä¸­çš„å¤§å°ä¿¡æ¯è·³è½¬åˆ°ä¸‹ä¸€ä¸ªå—ï¼‰æ¥å¯»æ‰¾ç©ºé—²å—ã€‚
- ç‰¹æ®Šæ ‡è®°ï¼šå †çš„å¼€å§‹å’Œç»“æŸé€šå¸¸æœ‰ç‰¹æ®Šçš„åºè¨€å— (Prologue) å’Œç»“å°¾å— (Epilogue) ä»¥ç®€åŒ–è¾¹ç•Œå¤„ç†ã€‚

### 3.3 æ”¾ç½®ç­–ç•¥ (Placement Policy)

å½“è¯·æ±‚ `k` å­—èŠ‚æ—¶ï¼Œå¦‚ä½•é€‰æ‹©ç©ºé—²å—ï¼Ÿ

1. **é¦–æ¬¡é€‚é… (First Fit)**ï¼šä»å¤´å¼€å§‹æœç´¢ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªæ»¡è¶³å¤§å°çš„å—ã€‚
    - ä¼˜ç‚¹ï¼šè¶‹å‘äºåœ¨é“¾è¡¨å°¾éƒ¨ä¿ç•™å¤§å—ã€‚
    - ç¼ºç‚¹ï¼šé“¾è¡¨å¤´éƒ¨ä¼šäº§ç”Ÿå¤§é‡å°ç¢ç‰‡ï¼Œæœç´¢æ—¶é—´éšæœªé‡Šæ”¾å—æ•°é‡çº¿æ€§å¢åŠ ã€‚
2. **ä¸‹ä¸€æ¬¡é€‚é… (Next Fit)**ï¼šä»ä¸Šä¸€æ¬¡æœç´¢ç»“æŸçš„åœ°æ–¹å¼€å§‹æœç´¢ã€‚
    - ä¼˜ç‚¹ï¼šé€šå¸¸æ¯”é¦–æ¬¡é€‚é…å¿«ï¼ˆé¿å…é‡å¤æ‰«æå¤´éƒ¨ï¼‰ã€‚
    - ç¼ºç‚¹ï¼šå†…å­˜ç¢ç‰‡é€šå¸¸æ¯”é¦–æ¬¡é€‚é…æ›´ä¸¥é‡ã€‚
3. **æœ€ä½³é€‚é… (Best Fit)**ï¼šæœç´¢æ•´ä¸ªé“¾è¡¨ï¼Œé€‰æ‹©å¤§å°æœ€æ¥è¿‘çš„ç©ºé—²å—ã€‚
    - ä¼˜ç‚¹ï¼šå†…å­˜åˆ©ç”¨ç‡é€šå¸¸æœ€é«˜ã€‚
    - ç¼ºç‚¹ï¼šé€Ÿåº¦æœ€æ…¢ï¼ˆéœ€è¦éå†æ‰€æœ‰å—ï¼‰ã€‚

### 3.4 åˆ†å‰² (Splitting)

å¦‚æœæ‰¾åˆ°çš„ç©ºé—²å—è¿œå¤§äºè¯·æ±‚å¤§å°ï¼Œä¸ºäº†å‡å°‘å†…éƒ¨ç¢ç‰‡ï¼Œé€šå¸¸ä¼šå°†å—åˆ†å‰²ï¼š

- ç¬¬ä¸€éƒ¨åˆ†å˜ä¸ºå·²åˆ†é…å—ã€‚
- å‰©ä½™éƒ¨åˆ†å˜æˆä¸€ä¸ªæ–°çš„ç©ºé—²å—ã€‚

> [!important]
>
> åˆ†é…æ—¶å®Œæˆ

### 3.5 åˆå¹¶ (Coalescing)

å½“é‡Šæ”¾å—æ—¶ï¼Œä¸ºäº†å‡å°‘å¤–éƒ¨ç¢ç‰‡ï¼Œå¿…é¡»å°†ç›¸é‚»çš„ç©ºé—²å—åˆå¹¶ã€‚

- **å‘ååˆå¹¶ (Next Block)**ï¼šå¾ˆå®¹æ˜“ï¼Œé€šè¿‡å½“å‰å—å¤§å°å¯ä»¥ç›´æ¥æ‰¾åˆ°ä¸‹ä¸€ä¸ªå—çš„Headerï¼Œæ£€æŸ¥å…¶åˆ†é…ä½ã€‚
- **å‘å‰åˆå¹¶ (Previous Block)**ï¼šå¦‚æœä¸åšç‰¹æ®Šå¤„ç†ï¼Œæ— æ³•å¿«é€Ÿæ‰¾åˆ°å‰ä¸€ä¸ªå—çš„Headerï¼ˆå› ä¸ºä¸çŸ¥é“å‰ä¸€ä¸ªå—çš„å¤§å°ï¼‰ã€‚

> [!important]
>
> é‡Šæ”¾æ—¶å®Œæˆ

> [!note]
>
> å¦‚ä½•è§£å†³å‘å‰åˆå¹¶ç¼“æ…¢çš„é—®é¢˜ï¼Ÿ

### 3.6 è¾¹ç•Œæ ‡è®° (Boundary Tags) - å…³é”®æŠ€æœ¯

ä¸ºäº†å®ç°å¸¸æ•°æ—¶é—´ `O(1)` çš„å‘å‰åˆå¹¶ï¼š

- **Footer (è„šéƒ¨/è¾¹ç•Œæ ‡è®°)**ï¼šåœ¨æ¯ä¸ªå—çš„**æœ«å°¾**å¤åˆ¶ä¸€ä»½Headerã€‚
- **æœºåˆ¶**ï¼šå½“å‰å—æŒ‡é’ˆ `p` å‡å»ä¸€ä¸ªå­—çš„å¤§å°ï¼Œå°±èƒ½è¯»åˆ°å‰ä¸€ä¸ªå—çš„ Footerï¼Œä»è€ŒçŸ¥é“å‰ä¸€ä¸ªå—çš„å¤§å°å’ŒçŠ¶æ€ã€‚
- **å››ç§åˆå¹¶æƒ…å†µ**ï¼š
  1. å‰åéƒ½å·²åˆ†é…ï¼šæ— åˆå¹¶ã€‚
  2. å‰å·²åˆ†é…ï¼Œåç©ºé—²ï¼šä¸åå—åˆå¹¶ã€‚
  3. å‰ç©ºé—²ï¼Œåå·²åˆ†é…ï¼šä¸å‰å—åˆå¹¶ã€‚
  4. å‰åéƒ½ç©ºé—²ï¼šä¸‰å—åˆå¹¶æˆä¸€ä¸ªå¤§å—ã€‚

### 3.7 è¾¹ç•Œæ ‡è®°çš„ä¼˜åŒ–

Footer å ç”¨äº†ç©ºé—´ï¼Œå¯¼è‡´å†…éƒ¨ç¢ç‰‡ã€‚

- **ä¼˜åŒ–ç­–ç•¥**ï¼šåªæœ‰**ç©ºé—²å—**æ‰éœ€è¦Footerã€‚
- **å®ç°**ï¼šå·²åˆ†é…å—ä¸å­˜å‚¨Footerã€‚åˆ©ç”¨å½“å‰å—Headerä¸­çš„ä½ä½ï¼ˆå¦‚ç¬¬2ä½ä½ï¼‰æ¥è®°å½•**å‰ä¸€ä¸ªå—**æ˜¯å¦å·²åˆ†é…ã€‚
  - å¦‚æœå‰ä¸€ä¸ªå—æ˜¯ç©ºé—²çš„ï¼Œå¯ä»¥é€šè¿‡å½“å‰æŒ‡é’ˆå‰ç§»è¯»å–å‰ä¸€ä¸ªå—çš„Footerï¼ˆç©ºé—²å—è‚¯å®šæœ‰Footerï¼‰ã€‚
  - å¦‚æœå‰ä¸€ä¸ªå—æ˜¯å·²åˆ†é…çš„ï¼Œä¸éœ€è¦åˆå¹¶ï¼Œä¹Ÿå°±ä¸éœ€è¦çŸ¥é“å‰ä¸€ä¸ªå—çš„å¤§å°ã€‚

### 3.8 æ€»ç»“

- **å®ç°**ï¼šéå¸¸ç®€å•ã€‚
- **åˆ†é…å¼€é”€ (Allocate cost)**ï¼š
  - æœ€åæƒ…å†µä¸‹æ˜¯**çº¿æ€§æ—¶é—´** (Linear time)ã€‚
  - (è¿™æ„å‘³ç€éšç€å †ä¸­å—æ•°é‡çš„å¢åŠ ï¼Œåˆ†é…é€Ÿåº¦ä¼šå˜æ…¢ï¼Œå› ä¸ºå¿…é¡»éå†å—)ã€‚
- **é‡Šæ”¾å¼€é”€ (Free cost)**ï¼š
  - æœ€åæƒ…å†µä¸‹æ˜¯**å¸¸æ•°æ—¶é—´** (Constant time)ã€‚
  - å³ä½¿åŒ…å«äº†**åˆå¹¶ (Coalescing)** æ“ä½œä¹Ÿæ˜¯å¦‚æ­¤ (å¾—ç›Šäºè¾¹ç•Œæ ‡è®°æŠ€æœ¯)ã€‚
- **å†…å­˜å¼€é”€ (Memory Overhead)**ï¼š
  - å–å†³äº**æ”¾ç½®ç­–ç•¥ (Placement policy)**ã€‚
  - ä¾‹å¦‚ï¼šé¦–æ¬¡é€‚é… (First-fit)ã€ä¸‹ä¸€æ¬¡é€‚é… (Next-fit) æˆ–æœ€ä½³é€‚é… (Best-fit)ã€‚
- **å®é™…åº”ç”¨æƒ…å†µ**ï¼š
  - ç”±äºåˆ†é…æ“ä½œæ˜¯çº¿æ€§æ—¶é—´çš„ (æ•ˆç‡è¾ƒä½)ï¼Œå› æ­¤åœ¨å®è·µä¸­é€šå¸¸**ä¸ç”¨äº**é€šç”¨çš„ `malloc`/`free` å®ç°ã€‚
  - ä½†åœ¨è®¸å¤š**ç‰¹æ®Šç”¨é€”**çš„åº”ç”¨ç¨‹åºä¸­ä»è¢«ä½¿ç”¨ (ä¾‹å¦‚å †å¤§å°å›ºå®šä¸”è¾ƒå°ï¼Œæˆ–å¯¹å®ç°å¤æ‚åº¦è¦æ±‚æä½çš„åœºæ™¯)ã€‚
- **é€šç”¨ä»·å€¼**ï¼š
  - å°½ç®¡å¦‚æ­¤ï¼Œ**åˆ†å‰² (Splitting)** å’Œ **è¾¹ç•Œæ ‡è®°åˆå¹¶ (Boundary tag coalescing)** çš„æ¦‚å¿µå¯¹äº**æ‰€æœ‰ç±»å‹**çš„åˆ†é…å™¨ (åŒ…æ‹¬æ˜¾å¼é“¾è¡¨å’Œåˆ†ç¦»é“¾è¡¨) éƒ½æ˜¯é€šç”¨çš„åŸºç¡€æŠ€æœ¯ã€‚

---

## 4. å®ç°ç­–ç•¥äºŒï¼šæ˜¾å¼ç©ºé—²é“¾è¡¨ (Explicit Free Lists)

### 4.1 ç»“æ„

- **æ ¸å¿ƒæ€æƒ³**ï¼šä»…åœ¨**ç©ºé—²å—**ä¸­ç»´æŠ¤æŒ‡é’ˆã€‚
- ç”±äºç©ºé—²å—æ²¡æœ‰æœ‰æ•ˆè½½è·ï¼Œæˆ‘ä»¬å¯ä»¥é‡ç”¨ Payload åŒºåŸŸå­˜å‚¨ `Next` å’Œ `Prev` æŒ‡é’ˆã€‚
- è¿™å°±æ„å»ºäº†ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼ŒåªåŒ…å«ç©ºé—²å—ã€‚
- **ç‰©ç† vs é€»è¾‘**ï¼š
  - ç‰©ç†ä¸Šï¼šå—åœ¨å†…å­˜ä¸­æ˜¯è¿ç»­çš„ï¼ˆéšå¼å…³ç³»ï¼‰ã€‚
  - é€»è¾‘ä¸Šï¼šé€šè¿‡æŒ‡é’ˆé“¾æ¥ï¼ˆæ˜¾å¼å…³ç³»ï¼‰ï¼Œé€»è¾‘ç›¸é‚»çš„å—åœ¨ç‰©ç†ä¸Šå¯èƒ½ç›¸è·ç”šè¿œã€‚

### 4.2 æ€§èƒ½å¯¹æ¯”

- **åˆ†é… (Allocation)**ï¼šæ—¶é—´å¤æ‚åº¦ä¸**ç©ºé—²å—çš„æ•°é‡**æˆçº¿æ€§å…³ç³»ï¼ˆéšå¼é“¾è¡¨æ˜¯ä¸å—çš„æ€»æ•°æˆçº¿æ€§å…³ç³»ï¼‰ã€‚å½“å †å¾ˆæ»¡æ—¶ï¼Œæ˜¾å¼é“¾è¡¨å¿«å¾—å¤šã€‚
- **é‡Šæ”¾ (Freeing)**ï¼šæ¶‰åŠåˆ°é“¾è¡¨æ’å…¥æ“ä½œï¼ˆä¿®æ”¹æŒ‡é’ˆï¼‰å’Œå¯èƒ½çš„åˆå¹¶ã€‚

### 4.3 æ’å…¥ç­–ç•¥ (Insertion Policy)

é‡Šæ”¾ä¸€ä¸ªå—åï¼Œå°†å…¶æ”¾åœ¨ç©ºé—²é“¾è¡¨çš„å“ªé‡Œï¼Ÿ

1. **LIFO (åè¿›å…ˆå‡º)**ï¼šå°†æ–°é‡Šæ”¾çš„å—æ”¾åœ¨é“¾è¡¨å¤´ã€‚
    - ä¼˜ç‚¹ï¼šç®€å•ï¼Œå¸¸æ•°æ—¶é—´ `O(1)`ã€‚
    - ç¼ºç‚¹ï¼šç ”ç©¶è¡¨æ˜ç¢ç‰‡åŒ–å¯èƒ½æ›´ä¸¥é‡ã€‚
2. **åœ°å€é¡ºåº (Address-ordered)**ï¼šä¿æŒé“¾è¡¨ä¸­çš„å—æŒ‰ç‰©ç†åœ°å€æ’åºã€‚
    - ä¼˜ç‚¹ï¼šç¢ç‰‡åŒ–ç¨‹åº¦è¾ƒä½ï¼ˆç±»ä¼¼æœ€ä½³é€‚é…ï¼‰ã€‚
    - ç¼ºç‚¹ï¼šé‡Šæ”¾æ—¶éœ€è¦æœç´¢åˆé€‚çš„ä½ç½®ï¼Œé€Ÿåº¦è¾ƒæ…¢ã€‚

---

## 5. å®ç°ç­–ç•¥ä¸‰ï¼šåˆ†ç¦»ç©ºé—²é“¾è¡¨ (Segregated Free Lists)

### 5.1 åŸºæœ¬æ€æƒ³

å°†æ‰€æœ‰ç©ºé—²å—æŒ‰å¤§å°åˆ†ç±»ï¼Œæ¯ä¸€ç±»ç»´æŠ¤ä¸€ä¸ªç‹¬ç«‹çš„ç©ºé—²é“¾è¡¨ã€‚
ä¾‹å¦‚ï¼š

- é“¾è¡¨1ï¼šå—å¤§å° 16-32
- é“¾è¡¨2ï¼šå—å¤§å° 32-64
- ...
- é“¾è¡¨Nï¼šå—å¤§å° > 4096

### 5.2 åˆ†ç¦»é€‚é… (Segregated Fits) åˆ†é…ç®—æ³•

1. ç¡®å®šè¯·æ±‚å¤§å°æ‰€å±çš„ç±»ï¼ˆé“¾è¡¨ï¼‰ã€‚
2. åœ¨è¯¥é“¾è¡¨ä¸­è¿›è¡Œâ€œé¦–æ¬¡é€‚é…â€æœç´¢ã€‚
3. å¦‚æœæ‰¾åˆ°ï¼šåˆ†å‰²å—ï¼Œå°†å‰©ä½™éƒ¨åˆ†æ’å…¥é€‚å½“å¤§å°çš„é“¾è¡¨ä¸­ã€‚
4. å¦‚æœæ²¡æ‰¾åˆ°ï¼šæŸ¥æ‰¾ä¸‹ä¸€ä¸ªæ›´å¤§çš„å¤§å°ç±»ï¼Œé‡å¤æ­¥éª¤ã€‚
5. å¦‚æœæ‰€æœ‰é“¾è¡¨éƒ½æ‰¾ä¸åˆ°ï¼šå‘ç³»ç»Ÿç”³è¯·æ›´å¤šå †å†…å­˜ï¼ˆ`sbrk`ï¼‰ï¼Œåˆ†å‰²å¹¶æ”¾å…¥é“¾è¡¨ã€‚

### 5.3 ä¼˜åŠ¿

- **é«˜ååç‡**ï¼šå¯¹2çš„å¹‚æ¬¡å¤§å°ç±»çš„æœç´¢æ˜¯å¯¹æ•°æ—¶é—´å¤æ‚åº¦ã€‚
- **é«˜å†…å­˜åˆ©ç”¨ç‡**ï¼šåˆ†ç¦»é“¾è¡¨çš„é¦–æ¬¡é€‚é…è¿‘ä¼¼äºå¯¹æ•´ä¸ªå †çš„æœ€ä½³é€‚é…ã€‚
- è¿™æ˜¯ç°ä»£é«˜æ€§èƒ½åˆ†é…å™¨ï¼ˆå¦‚ glibc mallocï¼‰å¸¸ç”¨çš„æŠ€æœ¯ã€‚

---

## 6. å†…å­˜ç›¸å…³çš„é™·é˜±ä¸é£é™© (Perils and Pitfalls)

Cè¯­è¨€ä¸­çš„å†…å­˜ç®¡ç†é”™è¯¯éå¸¸æ™®éä¸”å±é™©ï¼š

1. **è§£å¼•ç”¨é”™è¯¯æŒ‡é’ˆ**ï¼šå¦‚ `scanf("%d", val)` åº”è¯¥æ˜¯ `&val`ã€‚
2. **è¯»å–æœªåˆå§‹åŒ–å†…å­˜**ï¼š`malloc` ä¸ä¼šæ¸…é›¶å†…å­˜ï¼ˆåº”ä½¿ç”¨ `calloc` æˆ– `memset`ï¼‰ã€‚
3. **è¦†ç›–å†…å­˜ (Overwriting)**ï¼š
    - åˆ†é…äº†é”™è¯¯å¤§å°ï¼ˆå¦‚ `malloc(strlen(s))` å¿˜è®°äº† `+1` å­˜ `\0`ï¼‰ã€‚
    - è¶Šç•Œå†™å…¥ï¼ˆOff-by-one errorï¼‰ã€‚
    - æ··æ·†æŒ‡é’ˆè¿ç®—ï¼ˆ`p += sizeof(int)` åœ¨æŒ‡é’ˆç®—æœ¯ä¸­å¯èƒ½æ„å‘³ç€åŠ äº† `4 * sizeof(int)`ï¼‰ã€‚
4. **å¼•ç”¨ä¸å­˜åœ¨çš„å˜é‡**ï¼šè¿”å›æŒ‡å‘æ ˆå±€éƒ¨å˜é‡çš„æŒ‡é’ˆã€‚
5. **å¤šæ¬¡é‡Šæ”¾ (Double Free)**ï¼šå¯¼è‡´ç©ºé—²é“¾è¡¨å¾ªç¯æˆ–å…ƒæ•°æ®æŸåã€‚
6. **å¼•ç”¨å·²é‡Šæ”¾å— (Use After Free)**ï¼šéå¸¸å±é™©ï¼Œå¯èƒ½å¯¼è‡´åœ¨æ­¤å¤„æ–°åˆ†é…çš„æ•°æ®è¢«ç¯¡æ”¹ã€‚
7. **å†…å­˜æ³„æ¼ (Memory Leak)**ï¼šåˆ†é…åå¿˜è®°é‡Šæ”¾ï¼Œå¯¼è‡´é•¿æœŸè¿è¡Œçš„ç¨‹åºè€—å°½å†…å­˜ã€‚

---

## 7. åƒåœ¾å›æ”¶ (Garbage Collection)

### 7.1 åŸºæœ¬åŸç†

- **å›¾æ¨¡å‹**ï¼šå°†å†…å­˜è§†ä¸ºæœ‰å‘å›¾ã€‚èŠ‚ç‚¹æ˜¯å—ï¼Œè¾¹æ˜¯æŒ‡é’ˆã€‚
- **æ ¹èŠ‚ç‚¹ (Roots)**ï¼šå¯„å­˜å™¨ã€æ ˆä½ç½®ã€å…¨å±€å˜é‡ã€‚
- **å¯è¾¾æ€§ (Reachability)**ï¼šä»æ ¹èŠ‚ç‚¹å‡ºå‘ï¼Œé€šè¿‡æŒ‡é’ˆè·¯å¾„å¯åˆ°è¾¾çš„èŠ‚ç‚¹ä¸ºå­˜æ´»èŠ‚ç‚¹ï¼Œä¸å¯è¾¾èŠ‚ç‚¹ä¸ºåƒåœ¾ã€‚

### 7.2 Mark and Sweep (æ ‡è®°-æ¸…é™¤) ç®—æ³•

1. **æ ‡è®°é˜¶æ®µ (Mark)**ï¼šä»æ ¹å¼€å§‹è¿›è¡Œæ·±åº¦ä¼˜å…ˆéå†ï¼Œä¸ºæ¯ä¸ªå¯è¾¾å—è®¾ç½®â€œå·²æ ‡è®°â€ä½ã€‚
2. **æ¸…é™¤é˜¶æ®µ (Sweep)**ï¼šæ‰«ææ•´ä¸ªå †ã€‚
    - å¦‚æœå—å·²æ ‡è®° -> æ¸…é™¤æ ‡è®°ä½ï¼ˆä¸ºä¸‹æ¬¡GCåšå‡†å¤‡ï¼‰ã€‚
    - å¦‚æœå—æœªæ ‡è®°ä¸”å·²åˆ†é… -> å®ƒæ˜¯åƒåœ¾ï¼Œé‡Šæ”¾å®ƒã€‚

### 7.3 Cè¯­è¨€ä¸­çš„ä¿å®ˆGC (Conservative GC)

- Cè¯­è¨€ä¸ä»…æ”¯æŒæŒ‡é’ˆï¼Œè¿˜æ”¯æŒæŒ‡é’ˆè¿ç®—ï¼Œä¸”æ²¡æœ‰ç±»å‹ä¿¡æ¯æ¥åŒºåˆ† `int` å’Œ `pointer`ã€‚
- **ä¿å®ˆç­–ç•¥**ï¼šå¦‚æœä¸€ä¸ªæ•°æ®çœ‹èµ·æ¥åƒæŒ‡é’ˆï¼ˆå³å…¶å€¼ä»£è¡¨å †ä¸­çš„ä¸€ä¸ªæœ‰æ•ˆåœ°å€ï¼‰ï¼ŒGCå°±å‡è®¾å®ƒæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå¹¶æ ‡è®°å…¶æŒ‡å‘çš„å—ã€‚
- åæœï¼šå¯èƒ½ä¼šå°†ä¸€äº›å®é™…ä¸Šæ˜¯æ•´æ•°çš„åƒåœ¾è¯¯è®¤ä¸ºæ˜¯æœ‰ç”¨çš„ï¼ˆå¯¼è‡´æ— æ³•å›æ”¶ï¼‰ï¼Œä½†ç»ä¸ä¼šå›æ”¶ä»åœ¨ä½¿ç”¨çš„æ•°æ®ï¼ˆå®‰å…¨ï¼‰ã€‚

---

## é™„å½•ï¼šCè¯­è¨€æŒ‡é’ˆå£°æ˜è‡ªæµ‹ (C Pointer Declarations)

- `int *p`: æŒ‡å‘intçš„æŒ‡é’ˆã€‚
- `int *p[13]`: å«æœ‰13ä¸ªæŒ‡å‘intçš„æŒ‡é’ˆçš„æ•°ç»„ã€‚
- `int *(p[13])`: åŒä¸Šã€‚
- `int **p`: æŒ‡å‘intæŒ‡é’ˆçš„æŒ‡é’ˆã€‚
- `int (*p)[13]`: æŒ‡å‘å«æœ‰13ä¸ªintçš„æ•°ç»„çš„æŒ‡é’ˆã€‚
- `int *f()`: è¿”å›intæŒ‡é’ˆçš„å‡½æ•°ã€‚
- `int (*f)()`: æŒ‡å‘è¿”å›intçš„å‡½æ•°çš„æŒ‡é’ˆã€‚
- `int (*(*x[3])())[5]`: `x` æ˜¯ä¸€ä¸ªåŒ…å«3ä¸ªå…ƒç´ çš„æ•°ç»„ -> å…ƒç´ æ˜¯æŒ‡é’ˆ -> æŒ‡å‘å‡½æ•° -> å‡½æ•°è¿”å›æŒ‡é’ˆ -> æŒ‡å‘åŒ…å«5ä¸ªintçš„æ•°ç»„ã€‚

# Network Programming

## ä¸€ã€äº’è”ç½‘ä¸è®¡ç®—æœºç½‘ç»œåŸºç¡€

### 1. äº’è”ç½‘æ¦‚è§ˆ

#### 1.1 ä»€ä¹ˆæ˜¯äº’è”ç½‘ï¼Ÿ

**ä¸¤ä¸ªè§†è§’ï¼š**

1. **å…·ä½“æ„æˆè§†è§’ï¼ˆâ€œNuts and bolts viewâ€ï¼‰**
   - **èŠ‚ç‚¹/ç«¯ç³»ç»Ÿ (Hosts / End Systems)**ï¼š
     PCã€æœåŠ¡å™¨ã€æ‰‹æœºã€IoT è®¾å¤‡ç­‰ï¼Œè¿è¡Œç½‘ç»œåº”ç”¨ï¼ˆWebã€Emailã€æ¸¸æˆã€æµåª’ä½“ç­‰ï¼‰ã€‚
   - **é€šä¿¡é“¾è·¯ (Communication links)**ï¼š
     å…‰çº¤ã€é“œç¼†ã€æ— çº¿ç”µã€å«æ˜Ÿç­‰ï¼›æ ¸å¿ƒå‚æ•°æ˜¯**å¸¦å®½ / ä¼ è¾“é€Ÿç‡ (Bandwidth / Rate)**ã€‚
   - **åˆ†ç»„äº¤æ¢æœº (Packet switches)**ï¼š
     è½¬å‘æ•°æ®åŒ…ï¼ˆpacketï¼‰çš„è®¾å¤‡ï¼ŒåŒ…æ‹¬ï¼š
     - è·¯ç”±å™¨ (Routers)
     - é“¾è·¯å±‚äº¤æ¢æœº (Switches)
   - **ç½‘ç»œ (Networks)**ï¼š
     ç”± ISPï¼ˆäº’è”ç½‘æœåŠ¡æä¾›å•†ï¼‰ç®¡ç†çš„è®¾å¤‡ã€è·¯ç”±å™¨å’Œé“¾è·¯çš„é›†åˆï¼Œå¦‚å®¶åº­ç½‘ç»œã€ä¼ä¸šç½‘ç»œã€ç§»åŠ¨ç½‘ç»œç­‰ã€‚
2. **æœåŠ¡è§†è§’ (Service view)**
   - äº’è”ç½‘æ˜¯ä¸º**åˆ†å¸ƒå¼åº”ç”¨**æä¾›é€šä¿¡æœåŠ¡çš„**åŸºç¡€è®¾æ–½**ã€‚
   - ä¸ºåº”ç”¨æä¾›ä¸€ç»„**ç¼–ç¨‹æ¥å£ï¼ˆAPIï¼‰**ï¼Œå°±åƒâ€œé‚®æ”¿æœåŠ¡çš„æŠ•é€’çª—å£â€ï¼šåº”ç”¨åªéœ€è¦è°ƒç”¨è¿™äº›æ¥å£å‘é€/æ¥æ”¶æ•°æ®ï¼Œä¸å¿…å…³å¿ƒåº•å±‚ç»†èŠ‚ã€‚

#### 1.2 åè®® (Protocol)

- **å®šä¹‰**ï¼šåè®®è§„å®šäº†ç½‘ç»œå®ä½“ä¹‹é—´ï¼š
  - æ¶ˆæ¯çš„**æ ¼å¼ (format)**
  - æ¶ˆæ¯äº¤æ¢çš„**é¡ºåº (order)**
  - åœ¨å‘é€/æ¥æ”¶æ¶ˆæ¯æˆ–å‘ç”ŸæŸäº›äº‹ä»¶æ—¶æ‰€é‡‡å–çš„**åŠ¨ä½œ (actions)**

- äººç±»åè®®çš„ç±»æ¯”ï¼š
  - ä¾‹å¦‚æ‰“æ‹›å‘¼ï¼šAï¼šä½ å¥½ â†’ Bï¼šä½ å¥½
  - ç½‘ç»œåè®®ä¸­ç±»ä¼¼ï¼šTCP çš„è¿æ¥è¯·æ±‚ã€HTTP GET è¯·æ±‚ç­‰ã€‚

- äº’è”ç½‘åè®®æ ‡å‡†ç”± **IETF (Internet Engineering Task Force)** åˆ¶å®šï¼Œä»¥ **RFC (Request for Comments)** å½¢å¼å‘å¸ƒã€‚

---

### 2. ç½‘ç»œè¾¹ç¼˜ä¸æ¥å…¥

#### 2.1 ç½‘ç»œè¾¹ç¼˜ (Network Edge)

- æŒ‡è¿æ¥åˆ°äº’è”ç½‘çš„ **ä¸»æœº**ï¼ˆå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ï¼‰ã€‚
- è¿™äº›ä¸»æœºé€šè¿‡å„ç§ **æ¥å…¥ç½‘ç»œ (Access Networks)** æ¥å…¥äº’è”ç½‘ã€‚

#### 2.2 æ¥å…¥ç½‘ç»œ (Access Networks)

1. **å®¶åº­æ¥å…¥ (Residential access)**
   - **DSLï¼ˆæ•°å­—ç”¨æˆ·çº¿ï¼‰**
     - åˆ©ç”¨ç°æœ‰çš„ç”µè¯çº¿ä¼ è¾“æ•°æ®ã€‚
     - **é¢‘åˆ†å¤ç”¨ (FDM)**ï¼šæ•°æ®å’Œè¯­éŸ³ä½¿ç”¨ä¸åŒé¢‘ç‡ï¼Œäº’ä¸å¹²æ‰°ã€‚
     - ç”¨æˆ·ç‹¬äº«ç”µè¯çº¿å¸¦å®½ã€‚

   - **Cableï¼ˆç”µç¼†ç½‘ç»œ / HFCï¼‰**
     - ä½¿ç”¨æœ‰çº¿ç”µè§†ç½‘ç»œï¼ˆHFCï¼šæ··åˆå…‰çº¤åŒè½´ç”µç¼†ï¼‰ã€‚
     - ç”µè§†ä¿¡å·ä¸æ•°æ®åœ¨å…±äº«ä»‹è´¨ä¸Šä»¥ä¸åŒé¢‘ç‡ä¼ è¾“ã€‚
     - å¸¦å®½æ˜¯**å…±äº«çš„**ï¼Œé‚»å±…ä¸€èµ·ç–¯ç‹‚ä¸‹è½½ä¼šäº’ç›¸å½±å“ã€‚

   - **FTTHï¼ˆå…‰çº¤åˆ°æˆ·ï¼‰**
     - ç›´æ¥å°†å…‰çº¤æ‹‰åˆ°å®¶åº­ï¼Œå¸¦å®½é«˜å¾—å¤šã€‚

2. **ä¼ä¸šæ¥å…¥ (Enterprise networks)**
   - ç”¨äºå…¬å¸æˆ–å¤§å­¦æ ¡å›­ç½‘ç»œã€‚
   - ä¸»æµæŠ€æœ¯æ˜¯ **ä»¥å¤ªç½‘ (Ethernet)**ï¼ˆ100 Mbps, 1 Gbps, 10 Gbps ç­‰ï¼‰ã€‚
   - ä¸€èˆ¬æ˜¯**æœ‰çº¿ä»¥å¤ªç½‘ + æ— çº¿ WiFi** çš„æ··åˆæ¥å…¥ã€‚

3. **æ— çº¿æ¥å…¥ (Wireless access)**
   - **WLANï¼ˆæ— çº¿å±€åŸŸç½‘ï¼‰**ï¼šå¦‚ WiFiï¼ˆ802.11ï¼‰ï¼Œè¦†ç›–èŒƒå›´ä¸€èˆ¬æ˜¯å»ºç­‘ç‰©çº§åˆ«ã€‚
   - **å¹¿åŸŸèœ‚çªç½‘ç»œ**ï¼šå¦‚ 4G / 5Gï¼Œç”±è¿è¥å•†æä¾›ï¼Œè¦†ç›–èŒƒå›´ä»å‡ å…¬é‡Œåˆ°å‡ åå…¬é‡Œã€‚

#### 2.3 ç‰©ç†ä»‹è´¨ (Physical Media)

1. **å¯¼å¼•å‹åª’ä½“ (Guided media)**ï¼šä¿¡å·åœ¨**å›ºä½“ä»‹è´¨**ä¸­ä¼ æ’­
   - **åŒç»çº¿ (Twisted Pair)**ï¼šä¸¤æ ¹ç»ç¼˜é“œçº¿ç»åˆï¼Œä¾‹å¦‚ Cat5/Cat6ï¼Œæ˜¯ä»¥å¤ªç½‘å¸¸ç”¨ä»‹è´¨ã€‚
   - **åŒè½´ç”µç¼† (Coaxial Cable)**ï¼šåŒå‘ä¼ è¾“ã€æŠ—å¹²æ‰°èƒ½åŠ›å¼ºã€æ”¯æŒå®½å¸¦ã€‚
   - **å…‰çº¤ (Fiber Optic)**ï¼š
     - ä½¿ç”¨ç»ç’ƒçº¤ç»´ä¼ è¾“**å…‰è„‰å†²**ã€‚
     - é€Ÿç‡å¯è¾¾ 10sâ€“100s Gbpsï¼Œè¯¯ç ç‡ä½ï¼ŒæŠ—ç”µç£å¹²æ‰°ã€‚

2. **éå¯¼å¼•å‹åª’ä½“ (Unguided media)**ï¼šä¿¡å·åœ¨**è‡ªç”±ç©ºé—´**ä¸­ä¼ æ’­
   - **æ— çº¿ç”µ (Radio)**ï¼š
     - WiFiã€è“ç‰™ã€4G/5Gã€å«æ˜Ÿé€šä¿¡ã€åœ°é¢å¾®æ³¢ç­‰ã€‚
     - æ˜“å—åå°„ã€é®æŒ¡ã€å¹²æ‰°ç­‰å½±å“ã€‚

---

### 3. ç½‘ç»œæ ¸å¿ƒ (Network Core)

ç½‘ç»œæ ¸å¿ƒç”±å¤§é‡äº’è”çš„è·¯ç”±å™¨ç»„æˆä¸€ä¸ªç½‘çŠ¶ç»“æ„ï¼Œè´Ÿè´£åœ¨ç«¯ç³»ç»Ÿä¹‹é—´è½¬å‘åˆ†ç»„ã€‚

#### 3.1 åˆ†ç»„äº¤æ¢ä¸ç”µè·¯äº¤æ¢

1. **åˆ†ç»„äº¤æ¢ (Packet Switching)**
   - ä¸»æœºå°†åº”ç”¨å±‚æ¶ˆæ¯æ‹†æˆä¸€ä¸ªä¸ª**åˆ†ç»„ (Packet)**ã€‚
   - **å­˜å‚¨-è½¬å‘ (Store-and-forward)**ï¼š
     - è·¯ç”±å™¨å¿…é¡»**æ¥æ”¶å®Œæ•´ä¸ªåˆ†ç»„**ä¹‹åï¼Œæ‰èƒ½å¼€å§‹å‘ä¸‹ä¸€è·³è½¬å‘ã€‚

   - **æ’é˜Ÿä¸ä¸¢åŒ…**ï¼š
     - å¦‚æœåˆ°è¾¾é€Ÿç‡ > é“¾è·¯çš„å‘é€é€Ÿç‡ï¼šåˆ†ç»„è¿›å…¥é˜Ÿåˆ—ç­‰å¾… â†’ **æ’é˜Ÿå»¶è¿Ÿ**ã€‚
     - è‹¥ç¼“å†²åŒºæ»¡äº†ï¼Œå¤šä½™åˆ†ç»„è¢«ä¸¢å¼ƒ â†’ **ä¸¢åŒ…**ã€‚

   - ç‰¹ç‚¹ï¼š
     - æŒ‰éœ€ä½¿ç”¨èµ„æºï¼Œé€‚åˆçªå‘æ•°æ®ã€‚
     - ä¸éœ€è¦ä¸ºæ¯æ¡è¿æ¥é¢„åˆ†é…èµ„æºï¼Œèµ„æºåˆ©ç”¨ç‡é«˜ã€‚

```mermaid
graph TD
    %% å®šä¹‰æ ·å¼
    classDef packet fill:#4cc9f0,stroke:#3a0ca3,color:white,rx:5,ry:5;
    classDef fullQueue fill:#ffd166,stroke:#ef476f,stroke-width:2px,stroke-dasharray: 5 5;
    classDef dropped fill:#ef476f,stroke:#590d22,color:white,stroke-width:2px;
    classDef routerBox fill:#f8f9fa,stroke:#adb5bd,stroke-width:2px;

    subgraph NetworkFlow ["ç½‘ç»œæ•°æ®æµå‘ (çºµå‘è§†å›¾)"]
        direction TB

        %% 1. é¡¶éƒ¨ï¼šæºå¤´
        Source["â˜ï¸ å‘é€ç«¯ / ä¸Šä¸€è·³"]

        %% 2. ä¸­é—´ï¼šè·¯ç”±å™¨é€»è¾‘
        subgraph Router ["ğŸ–§ è·¯ç”±å™¨ Router"]
            direction TB

            InputPort(("â¬‡ï¸ å…¥ç«¯å£"))

            %% å†³ç­–ç‚¹
            Check{"è¿˜æœ‰ç©ºé—´å—?"}

            %% ç¼“å†²åŒº (å†…éƒ¨ä¿æŒæ¨ªå‘æ’åˆ—ï¼Œåƒä¸€ä¸ªå‚¨ç‰©æ¶)
            subgraph Buffer ["ç¼“å†²åŒº / é˜Ÿåˆ— (å·²æ»¡!)"]
                direction LR
                P3["æ’é˜ŸåŒ… 3"] --- P2["æ’é˜ŸåŒ… 2"] --- P1["æ’é˜ŸåŒ… 1"]
            end

            Processor(("â¬‡ï¸ è½¬å‘å¤„ç†"))
        end

        %% 3. ä¾§è¾¹ï¼šä¸¢å¼ƒ
        Trash["ğŸ—‘ï¸ ä¸¢åŒ… (Drop)"]

        %% 4. åº•éƒ¨ï¼šä¸‹ä¸€è·³
        NextHop["ğŸ’» ä¸‹ä¸€è·³ / æ¥æ”¶ç«¯"]

        %% è¿æ¥ä¸æµå‘
        Source -- "é«˜é€Ÿè¾“å…¥ (1000 Mbps)" --> InputPort
        InputPort --> Check

        %% æ ¸å¿ƒé€»è¾‘ï¼šæº¢å‡ºåˆ™ä¸¢å¼ƒ
        Check -- "æ²¡æœ‰ (æº¢å‡º!)" --> Trash
        Check -- "æœ‰ (å…¥é˜Ÿ)" --> Buffer

        Buffer -- "ä»é˜Ÿé¦–å–å‡º" --> Processor
        Processor -- "ä½é€Ÿè¾“å‡º (10 Mbps)" --> NextHop
    end

    %% åº”ç”¨æ ·å¼
    class P1,P2,P3,Source,NextHop packet;
    class Buffer fullQueue;
    class Trash dropped;
    class Router routerBox;
```

1. **ç”µè·¯äº¤æ¢ (Circuit Switching)**
   - ä¼ ç»Ÿç”µè¯ç½‘ç»œæ–¹å¼ï¼Œä¸ºæ¯æ¬¡ä¼šè¯é¢„ç•™ä¸€æ¡**ç«¯åˆ°ç«¯ä¸“ç”¨ç”µè·¯**ã€‚
   - ç‰¹ç‚¹ï¼š
     - æ€§èƒ½æœ‰ä¿éšœï¼ˆå¸¦å®½å›ºå®šï¼‰ã€‚
     - ç©ºé—²æ—¶æµªè´¹èµ„æºï¼Œä¾‹å¦‚é€šè¯åŒæ–¹æ²‰é»˜æ—¶é€šè·¯ä»å ç”¨å¸¦å®½ã€‚

#### 3.2 è½¬å‘ä¸è·¯ç”±

- **è½¬å‘ (Forwarding)**ï¼š
  - è·¯ç”±å™¨çš„**å±€éƒ¨åŠ¨ä½œ**ã€‚
  - æ ¹æ®è·¯ç”±è¡¨/è½¬å‘è¡¨ï¼Œå°†**è¾“å…¥ç«¯å£**æ¥çš„åˆ†ç»„è½¬åˆ°æ­£ç¡®çš„**è¾“å‡ºç«¯å£**ã€‚

- **è·¯ç”± (Routing)**ï¼š
  - **å…¨å±€åŠ¨ä½œ**ã€‚
  - é€šè¿‡è·¯ç”±ç®—æ³•è®¡ç®—ä»æºåˆ°ç›®çš„çš„è·¯å¾„ã€‚
  - ç»“æœç”¨äºæ„é€ è·¯ç”±å™¨çš„è½¬å‘è¡¨ã€‚

#### 3.3 äº’è”ç½‘ç»“æ„ï¼šNetwork of Networks

- äº’è”ç½‘ç”±å„çº§ ISP æ„æˆçš„åˆ†å±‚ç»“æ„ï¼š
  - **Tier-1 ISP**ï¼šè¦†ç›–å…¨çƒæˆ–å›½å®¶çº§çš„å¤§å‹éª¨å¹²ç½‘è¿è¥å•†ï¼Œå®ƒä»¬å½¼æ­¤äº’è”ã€‚
  - **IXPï¼ˆInternet Exchange Pointï¼‰**ï¼šäº’è”ç½‘äº¤æ¢ä¸­å¿ƒï¼Œä½¿ä¸åŒ ISP äº’è”ã€‚
  - **Regional ISP**ï¼šåŒºåŸŸçº§ ISPï¼Œè¿æ¥æ¥å…¥ ISP ä¸ Tier-1ã€‚
  - **Access ISP**ï¼šç›´æ¥ç»™æ™®é€šç”¨æˆ·å’Œä¼ä¸šæ¥å…¥æœåŠ¡çš„ ISPã€‚

- **å†…å®¹æä¾›å•†ç½‘ç»œ (Content Provider Networks)**ï¼š
  - å¤§å‹å†…å®¹æä¾›å•†ï¼ˆå¦‚æœç´¢å¼•æ“ã€ç¤¾äº¤ç½‘ç»œå…¬å¸ç­‰ï¼‰è‡ªå»ºç§æœ‰éª¨å¹²ç½‘è¿æ¥å„åœ°æ•°æ®ä¸­å¿ƒï¼Œå¹¶åœ¨é è¿‘ç”¨æˆ·å¤„ä¸ ISP å¯¹æ¥ï¼Œä»¥æé«˜æœåŠ¡è´¨é‡ã€‚

```mermaid
graph TD
    %% æ ·å¼å®šä¹‰
    classDef pc fill:#e0fbfc,stroke:#3d5a80,stroke-width:2px;
    classDef router fill:#f8f9fa,stroke:#adb5bd,stroke-width:2px,stroke-dasharray: 5 5;
    classDef process fill:#98c1d9,stroke:#3d5a80,color:black;
    classDef decision fill:#ffd166,stroke:#ee6c4d,color:black,rx:5,ry:5;
    classDef queue fill:#e0e1dd,stroke:#3d5a80,stroke-width:2px;
    classDef drop fill:#ef476f,stroke:#7209b7,color:white,stroke-width:4px;
    classDef success fill:#06d6a0,stroke:#073b4c,color:white;

    %% --- 1. å‘é€ç«¯ ---
    subgraph HostA ["ğŸ’» å‘é€ä¸»æœº (Host A)"]
        direction TB
        App("åº”ç”¨ç¨‹åº<br>(ç”Ÿæˆæ•°æ®)") --> OS("æ“ä½œç³»ç»Ÿ/TCPæ ˆ<br>(æ‰“åŒ…/åˆ‡åˆ†)")
        OS --> NIC("ç½‘å¡<br>(å‘é€ä¿¡å·)")
    end

    %% --- 2. ä¼ è¾“é“¾è·¯ ---
    NIC == "å…‰çº¤/ç½‘çº¿ä¼ è¾“" ==> R_Input

    %% --- 3. è·¯ç”±å™¨å†…éƒ¨ (æ ¸å¿ƒæœºåˆ¶) ---
    subgraph Router ["ğŸ–§ è·¯ç”±å™¨ (ä¸­è½¬ç«™)"]
        direction TB

        R_Input(("å…¥ç«¯å£<br>(æ¥æ”¶)")) --> R_Lookup{"æŸ¥è·¯ç”±è¡¨<br>(å»å“ª?)"}

        %% æŸ¥è¡¨åï¼Œå†³å®šå»å“ªä¸ªå‡ºå£
        R_Lookup -- "å»å¾€å‡ºå£A" --> R_BufferCheck{"æ£€æŸ¥ç¼“å†²åŒº<br>(æ»¡äº†å—?)"}

        %% ç¼“å†²åŒºæ£€æŸ¥é€»è¾‘
        subgraph Memory ["è·¯ç”±å™¨å†…å­˜ (Queue)"]
            direction LR
            Q_Head[é˜Ÿé¦–] --- Q_Body[...] --- Q_Tail[é˜Ÿå°¾]
        end

        R_BufferCheck -- "æœªæ»¡ (No)" --> Enqueue("å…¥é˜Ÿç­‰å¾…")
        Enqueue --> Memory

        %% ä¸¢åŒ…åˆ†æ”¯
        R_BufferCheck -- "å·²æ»¡ (Yes)" --> DropNode("ğŸ’¥ ä¸¢åŒ… (Drop)")

        %% è½¬å‘é€»è¾‘
        Memory --> Dequeue("å‡ºé˜Ÿ")
        Dequeue --> R_Output(("å‡ºç«¯å£<br>(å‘é€)"))
    end

    %% --- 4. æ¥æ”¶ç«¯ ---
    subgraph HostB ["ğŸ–¥ï¸ æ¥æ”¶ä¸»æœº (Host B)"]
        direction TB
        NIC_B("ç½‘å¡<br>(æ¥æ”¶)") --> OS_B("æ“ä½œç³»ç»Ÿ<br>(é‡ç»„/æ£€æŸ¥)")
        OS_B --> App_B("åº”ç”¨ç¨‹åº<br>(æ˜¾ç¤ºå†…å®¹)")
    end

    %% è¿æ¥è·¯ç”±å™¨ä¸æ¥æ”¶ç«¯
    R_Output == "æˆåŠŸè½¬å‘" ==> NIC_B

    %% åº”ç”¨æ ·å¼
    class HostA,HostB pc;
    class Router router;
    class App,OS,NIC,R_Input,R_Output,NIC_B,OS_B,App_B,Enqueue,Dequeue process;
    class R_Lookup,R_BufferCheck decision;
    class Memory queue;
    class DropNode drop;
    class App_B success;
```

---

### 4. ç½‘ç»œæ€§èƒ½æŒ‡æ ‡

#### 4.1 èŠ‚ç‚¹æ€»å»¶è¿Ÿ (Packet Delay)

ä¸€ä¸ªèŠ‚ç‚¹çš„æ€»å»¶è¿Ÿ ($d_{\text{nodal}}$ ) ç”±å››éƒ¨åˆ†ç»„æˆï¼š

1. **å¤„ç†å»¶è¿Ÿ ($d_{proc}$)**
   - æ£€æŸ¥åˆ†ç»„é¦–éƒ¨æ˜¯å¦æœ‰æ¯”ç‰¹é”™è¯¯ã€ç¡®å®šè¾“å‡ºé“¾è·¯ç­‰ã€‚
   - é€šå¸¸ä¸ºå¾®ç§’çº§ã€‚
2. **æ’é˜Ÿå»¶è¿Ÿ ($d_{queue}$)**
   - åˆ†ç»„åœ¨è¾“å‡ºé˜Ÿåˆ—ä¸­ç­‰å¾…å‘é€çš„æ—¶é—´ã€‚
   - å–å†³äºå½“å‰ç½‘ç»œ**æ‹¥å¡ç¨‹åº¦**ï¼Œæµé‡æ¥è¿‘å¸¦å®½æ—¶æ’é˜Ÿå»¶è¿Ÿæ€¥å‰§å¢åŠ ã€‚
3. **ä¼ è¾“å»¶è¿Ÿ ($d_{trans}$)**
   - æŠŠåˆ†ç»„çš„æ‰€æœ‰æ¯”ç‰¹â€œæ¨ä¸Šâ€é“¾è·¯æ‰€éœ€æ—¶é—´ã€‚
   - å…¬å¼ï¼š$d_{\text{trans}} = \frac{L}{R}$
     - ( L )ï¼šåˆ†ç»„é•¿åº¦ï¼ˆæ¯”ç‰¹æ•°ï¼‰
     - ( R )ï¼šé“¾è·¯å¸¦å®½ï¼ˆæ¯”ç‰¹/ç§’ï¼‰
4. **ä¼ æ’­å»¶è¿Ÿ (d_prop)**
   - æ¯”ç‰¹åœ¨ä»‹è´¨ä¸­ä¼ æ’­æ‰€éœ€æ—¶é—´ã€‚
   - å…¬å¼ï¼š$d_{\text{prop}} = \frac{d}{s}$
     - ( d )ï¼šç‰©ç†è·ç¦»
     - ( s )ï¼šä¿¡å·ä¼ æ’­é€Ÿåº¦ï¼ˆæ¥è¿‘å…‰é€Ÿï¼‰

#### 4.2 åˆ†ç»„ä¸¢å¤± (Packet Loss)

- è·¯ç”±å™¨ç¼“å†²åŒºå®¹é‡æœ‰é™ï¼Œå½“é˜Ÿåˆ—å·²æ»¡æ—¶åˆ°è¾¾çš„åˆ†ç»„ä¼šè¢«ä¸¢å¼ƒã€‚
- ä¸¢å¤±çš„åˆ†ç»„å¯ä»¥ç”±å‰ä¸€è·³æˆ–æºä¸»æœºé‡ä¼ ï¼Œä¹Ÿå¯èƒ½ä¸ä¼šé‡ä¼ ã€‚

#### 4.3 ååé‡ (Throughput)

- å®šä¹‰ï¼šä»å‘é€ç«¯åˆ°æ¥æ”¶ç«¯å®é™…æˆåŠŸä¼ è¾“æ•°æ®çš„é€Ÿç‡ï¼ˆbits/secï¼‰ã€‚
- **ç“¶é¢ˆé“¾è·¯ (Bottleneck link)**ï¼š
  - ä¸€æ¡ç«¯åˆ°ç«¯è·¯å¾„ä¸­å¸¦å®½æœ€å°çš„é“¾è·¯ã€‚
  - å®ƒå†³å®šæ•´ä¸ªè·¯å¾„çš„æœ€å¤§ååé‡ã€‚

---

### 5. åè®®åˆ†å±‚ä¸å°è£…

#### 5.1 äº”å±‚äº’è”ç½‘åè®®æ ˆ

1. **åº”ç”¨å±‚ (Application)**
   - æ”¯æŒç½‘ç»œåº”ç”¨ã€‚
   - å¸¸è§åè®®ï¼š**HTTP, IMAP, SMTP, DNS** ç­‰ã€‚
   - æ•°æ®å•å…ƒï¼š**æŠ¥æ–‡ (Message)**ã€‚

2. **ä¼ è¾“å±‚ (Transport)**
   - åœ¨**è¿›ç¨‹ä¸è¿›ç¨‹**ä¹‹é—´ä¼ è¾“æ•°æ®ã€‚
   - åè®®ï¼š
     - **TCP**ï¼šå¯é ã€æœ‰åºã€å…¨åŒå·¥çš„å­—èŠ‚æµã€‚
     - **UDP**ï¼šä¸å¯é ã€æ— è¿æ¥çš„æ•°æ®æŠ¥ä¼ è¾“ã€‚

   - æ•°æ®å•å…ƒï¼š**æŠ¥æ–‡æ®µ (Segment)**ã€‚

3. **ç½‘ç»œå±‚ (Network)**
   - è´Ÿè´£ä¸»æœºåˆ°ä¸»æœºçš„æ•°æ®åŒ…è·¯ç”±ã€‚
   - åè®®ï¼š
     - **IPï¼ˆInternet Protocolï¼‰**ï¼šåŒ…æ‹¬ IPv4ã€IPv6ã€‚
     - å„ç§**è·¯ç”±åè®®**ã€‚

   - æ•°æ®å•å…ƒï¼š**æ•°æ®æŠ¥ (Datagram)**ã€‚

4. **é“¾è·¯å±‚ (Link)**
   - è´Ÿè´£**ç›¸é‚»èŠ‚ç‚¹**ä¹‹é—´çš„æ•°æ®ä¼ è¾“ã€‚
   - åè®®ï¼š**ä»¥å¤ªç½‘ (Ethernet)ã€WiFi (802.11)ã€PPP** ç­‰ã€‚
   - æ•°æ®å•å…ƒï¼š**å¸§ (Frame)**ã€‚

5. **ç‰©ç†å±‚ (Physical)**
   - åœ¨ç‰©ç†ä»‹è´¨ä¸Šä¼ è¾“**æ¯”ç‰¹æµ (Bits)**ï¼Œå¤„ç†ç”µ/å…‰ä¿¡å·ã€‚

#### 5.2 å°è£…ä¸è§£å°è£… (Encapsulation)

- æ•°æ®è‡ªä¸Šè€Œä¸‹æ¯ç»è¿‡ä¸€å±‚ï¼Œéƒ½ä¼šè¢«å°è£…ï¼š
  - åº”ç”¨å±‚æŠ¥æ–‡ â†’ ä¼ è¾“å±‚åŠ é¦–éƒ¨ â†’ æŠ¥æ–‡æ®µ
  - æŠ¥æ–‡æ®µ â†’ ç½‘ç»œå±‚åŠ  IP é¦–éƒ¨ â†’ æ•°æ®æŠ¥
  - æ•°æ®æŠ¥ â†’ é“¾è·¯å±‚åŠ å¸§é¦–éƒ¨ï¼ˆåŠå¯èƒ½çš„å¸§å°¾éƒ¨ï¼‰â†’ å¸§

- ç±»ä¼¼ä¿„ç½—æ–¯å¥—å¨ƒï¼šå¸§ä¸­åŒ…å«æ•°æ®æŠ¥ï¼Œæ•°æ®æŠ¥ä¸­åŒ…å«æŠ¥æ–‡æ®µï¼ŒæŠ¥æ–‡æ®µä¸­åŒ…å«åº”ç”¨æŠ¥æ–‡ã€‚
- ä¸­é—´è®¾å¤‡æ ¹æ®è‡ªèº«æ‰€åœ¨å±‚çº§è§£å°è£…å¹¶å¤„ç†å¯¹åº”çš„é¦–éƒ¨ä¿¡æ¯ï¼š
  - è·¯ç”±å™¨ï¼šä¸»è¦çœ‹ç½‘ç»œå±‚é¦–éƒ¨ï¼ˆIPï¼‰ã€‚
  - äº¤æ¢æœºï¼šä¸»è¦çœ‹é“¾è·¯å±‚é¦–éƒ¨ï¼ˆMAC åœ°å€ï¼‰ã€‚

```mermaid
flowchart TD
  %% ===== å‘é€ç«¯ =====
  subgraph L["å‘é€ç«¯ Host A"]
    direction TB
    L5["åº”ç”¨å±‚<br>Message"]
    L4["ä¼ è¾“å±‚<br>Segment<br>åŠ  TCP æˆ– UDP é¦–éƒ¨"]
    L3["ç½‘ç»œå±‚<br>Datagram<br>åŠ  IP é¦–éƒ¨"]
    L2["é“¾è·¯å±‚<br>Frame<br>åŠ  å¸§é¦–éƒ¨ å’Œ å¸§å°¾"]
    L1["ç‰©ç†å±‚<br>Bits"]
  end

  %% ===== æ¥æ”¶ç«¯ =====
  subgraph R["æ¥æ”¶ç«¯ Host B"]
    direction TB
    R1["ç‰©ç†å±‚<br>Bits"]
    R2["é“¾è·¯å±‚<br>Frame<br>å» å¸§é¦–éƒ¨ å’Œ å¸§å°¾"]
    R3["ç½‘ç»œå±‚<br>Datagram<br>å» IP é¦–éƒ¨"]
    R4["ä¼ è¾“å±‚<br>Segment<br>å» TCP æˆ– UDP é¦–éƒ¨"]
    R5["åº”ç”¨å±‚<br>Message"]
  end

  %% ===== å°è£…è·¯å¾„ =====
  L5 --> L4 --> L3 --> L2 --> L1

  %% ===== ç‰©ç†ä¼ è¾“ =====
  L1 --> R1

  %% ===== è§£å°è£…è·¯å¾„ =====
  R1 --> R2 --> R3 --> R4 --> R5

```

---

### 6. ç½‘ç»œå®‰å…¨æ¦‚è§ˆ

#### 6.1 å¸¸è§å¨èƒ

1. **æ¶æ„è½¯ä»¶ (Malware)**
   - ç±»å‹ï¼šç—…æ¯’ (Virus)ã€è •è™« (Worm)ã€æœ¨é©¬ (Trojan) ç­‰ã€‚
   - å¯ä»¥æ„ŸæŸ“å¤§é‡ä¸»æœºï¼Œå½¢æˆ**åƒµå°¸ç½‘ç»œ (Botnet)**ï¼Œç”¨äºå‘åŠ¨å¤§è§„æ¨¡æ”»å‡»ã€‚
2. **åŒ…å—…æ¢ (Packet Sniffing)**
   - åœ¨å…±äº«ä»‹è´¨ï¼ˆæ— çº¿ç½‘ç»œã€é›†çº¿å™¨ï¼‰ä¸Šï¼ŒæŠŠç½‘å¡è®¾ä¸º**æ··æ‚æ¨¡å¼ (Promiscuous mode)**ã€‚
   - å¯ä»¥æ•è·æ‰€æœ‰ç»è¿‡çš„åˆ†ç»„ï¼ˆç¤ºä¾‹å·¥å…·ï¼šWiresharkï¼‰ã€‚

3. **IP æ¬ºéª— (IP Spoofing)**
   - åœ¨å‘é€æ•°æ®æŠ¥æ—¶ä¼ªé€ æº IP åœ°å€ï¼Œå‡å†’å…¶å®ƒä¸»æœºèº«ä»½ã€‚

4. **æ‹’ç»æœåŠ¡æ”»å‡» (DoS / DDoS)**
   - åˆ©ç”¨å¤§é‡åƒåœ¾æµé‡å‹å®æœåŠ¡å™¨æˆ–å æ»¡é“¾è·¯ï¼Œä½¿åˆæ³•ç”¨æˆ·æ— æ³•è®¿é—®æœåŠ¡ã€‚
   - åˆ†å¸ƒå¼ç‰ˆæœ¬ç§° DDoSï¼ˆDistributed DoSï¼‰ã€‚

#### 6.2 é˜²å¾¡æªæ–½

- **è®¤è¯ (Authentication)**ï¼šè¯æ˜é€šä¿¡åŒæ–¹èº«ä»½ã€‚
- **æœºå¯†æ€§ (Confidentiality)**ï¼šé€šè¿‡**åŠ å¯† (Encryption)** ä¿è¯å†…å®¹ä¸è¢«çªƒå¬ã€‚
- **å®Œæ•´æ€§ (Integrity)**ï¼šä½¿ç”¨**æ•°å­—ç­¾å**ç­‰æ‰‹æ®µé˜²æ­¢å†…å®¹è¢«ç¯¡æ”¹ã€‚
- **è®¿é—®æ§åˆ¶**ï¼šå¦‚ **VPN**ã€é˜²ç«å¢™ (Firewalls)ã€‚
- **æ“ä½œå®‰å…¨**ï¼šå¦‚å…¥ä¾µæ£€æµ‹ç³»ç»Ÿ (IDS)ã€‚

---

### 7. æ— çº¿ä¸ç§»åŠ¨ç½‘ç»œ

#### 7.1 æ— çº¿ç½‘ç»œåŸºæœ¬è¦ç´ 

- **æ— çº¿ä¸»æœº**ï¼šç¬”è®°æœ¬ç”µè„‘ã€æ‰‹æœºã€IoT è®¾å¤‡ç­‰ã€‚
- **åŸºç«™ (Base Station)**ï¼š
- è¿æ¥æœ‰çº¿éª¨å¹²ç½‘ä¸æ— çº¿ä¸»æœºï¼Œå¦‚èœ‚çªåŸºç«™ã€WiFi APã€‚
- **æ— çº¿é“¾è·¯**ï¼š
  - ä¸»æœºä¸åŸºç«™ä¹‹é—´çš„é“¾è·¯ï¼Œå…·æœ‰ç‰¹å®šçš„**å¤šå€æ¥å…¥åè®®**ã€é€Ÿç‡å’Œè¦†ç›–è·ç¦»ã€‚

- **åç«¯æœ‰çº¿ç½‘ç»œ**ï¼šåŸºç«™é€šè¿‡æœ‰çº¿ç½‘ç»œè¿æ¥åˆ°äº’è”ç½‘ã€‚

#### 7.2 ç»„ç½‘æ¨¡å¼

1. **åŸºç¡€è®¾æ–½æ¨¡å¼ (Infrastructure mode)**
   - ä¸»æœºé€šè¿‡åŸºç«™æ¥å…¥æœ‰çº¿ç½‘ç»œã€‚
   - æ”¯æŒ**åˆ‡æ¢ (Handoff)**ï¼šç§»åŠ¨è®¾å¤‡ä»ä¸€ä¸ªåŸºç«™åˆ‡æ¢åˆ°å¦ä¸€ä¸ªåŸºç«™æ—¶ï¼Œç½‘ç»œè¦ä¿æŒè¿æ¥ã€‚
2. **è‡ªç»„ç»‡æ¨¡å¼ (Ad hoc mode)**
   - æ— éœ€åŸºç«™ï¼ŒèŠ‚ç‚¹ä¹‹é—´å¯ä»¥ç›´æ¥é€šä¿¡å¹¶ç›¸äº’è½¬å‘ï¼Œå½¢æˆå¤šè·³ç½‘ç»œã€‚
   - ç¤ºä¾‹ï¼šMesh ç½‘ç»œã€MANETï¼ˆç§»åŠ¨è‡ªç»„ç½‘ï¼‰ã€VANETï¼ˆè½¦è”ç½‘ï¼‰ç­‰ã€‚

#### 7.3 ç§»åŠ¨æ€§ (Mobility) çš„æŒ‘æˆ˜

- å½“è®¾å¤‡è·¨è¶Šä¸åŒç½‘ç»œï¼ˆæ›´æ¢ IP å­ç½‘ï¼‰æ—¶ï¼Œå¦‚ä½•ä¿æŒæ­£åœ¨è¿›è¡Œçš„è¿æ¥ï¼ˆä¾‹å¦‚ TCP è¿æ¥ï¼‰ä¸æ–­æ‰æ˜¯ä¸€ä¸ªéš¾ç‚¹ã€‚
- æ— çº¿é“¾è·¯è¯¯ç ç‡é«˜ã€ä¸¢åŒ…å¤šï¼ŒTCP å¯èƒ½ä¼šæŠŠæ— çº¿ä¸¢åŒ…è¯¯è®¤ä¸ºæ˜¯**ç½‘ç»œæ‹¥å¡**ï¼Œä»è€Œé”™è¯¯è§¦å‘æ‹¥å¡æ§åˆ¶ï¼Œé™ä½å‘é€é€Ÿç‡ã€‚

---

### 8. äº’è”ç½‘ç®€å²

- **1961â€“1972**
  - åˆ†ç»„äº¤æ¢ç†è®ºå»ºç«‹ã€‚
  - 1969 å¹´ ARPAnet å»ºæˆï¼Œè¯ç”Ÿç¬¬ä¸€å° Emailã€‚
- **1972â€“1980**
  - TCP/IP åè®®è®¾è®¡å®Œæˆã€‚
  - ä»¥å¤ªç½‘å‡ºç°ã€‚
  - Cerf å’Œ Kahn æå‡ºäº’è”ç½‘äº’è”åŸåˆ™ï¼šæ ¸å¿ƒç®€å•ã€å°½åŠ›è€Œä¸ºã€æ— çŠ¶æ€è·¯ç”±ã€‚

- **1980â€“1990**
  - DNSã€SMTPã€FTP ç­‰åº”ç”¨å±‚åè®®å‡ºç°ã€‚
  - TCP æ‹¥å¡æ§åˆ¶æœºåˆ¶ç¡®ç«‹ã€‚

- **1990â€“2000s**
  - ä¸‡ç»´ç½‘ (Web) å…´èµ·ï¼šHTTPã€HTMLã€‚
  - äº’è”ç½‘å•†ä¸šåŒ–ï¼Œå‡ºç°å„ç§ P2P åº”ç”¨ã€‚

- **2005â€“è‡³ä»Š**
  - å®½å¸¦æ™®åŠã€æ™ºèƒ½æ‰‹æœºä¸ç§»åŠ¨äº’è”ç½‘ã€‚
  - äº‘æœåŠ¡å…´èµ·ã€‚
  - SDNï¼ˆè½¯ä»¶å®šä¹‰ç½‘ç»œï¼‰ç­‰æ–°æŠ€æœ¯å‡ºç°ã€‚

---

## äºŒã€Unix è§†è§’ä¸‹çš„ç½‘ç»œä¸åº•å±‚ I/O

### 1. å®¢æˆ·ç«¯â€“æœåŠ¡å™¨æ¨¡å‹ (Clientâ€“Server Model)

- **æœåŠ¡å™¨ (Server)**ï¼š
  - ç®¡ç†æŸç§èµ„æºï¼Œé€šè¿‡æ“ä½œè¯¥èµ„æºä¸ºå®¢æˆ·ç«¯æä¾›æœåŠ¡ã€‚
  - é€šå¸¸æ˜¯**è¢«åŠ¨**çš„ï¼Œè°ƒç”¨ accept ç­‰å‡½æ•°**ç­‰å¾…**è¯·æ±‚ã€‚

- **å®¢æˆ·ç«¯ (Client)**ï¼š
  - ä¸»åŠ¨å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ä»¥è·å–æœåŠ¡ã€‚

- **å…³é”®è®¤çŸ¥**ï¼š
  - å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨æ˜¯**è¿›ç¨‹ (Process)**ï¼Œè€Œä¸æ˜¯ç‰©ç†æœºå™¨ï¼›
    ä¸€å°ä¸»æœºå¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªå®¢æˆ·ç«¯è¿›ç¨‹å’ŒæœåŠ¡å™¨è¿›ç¨‹ã€‚
  - äº‹åŠ¡ (Transaction) æ­¥éª¤ï¼š
    1. å®¢æˆ·ç«¯å‘é€è¯·æ±‚ (Request)
    2. æœåŠ¡å™¨å¤„ç†è¯·æ±‚
    3. æœåŠ¡å™¨å‘é€å“åº” (Response)
    4. å®¢æˆ·ç«¯å¤„ç†å“åº”

---

### 2. ä¸»æœºè§†è§’ï¼šç½‘ç»œå°±æ˜¯ä¸€ç§ I/O è®¾å¤‡

#### 2.1 ç¡¬ä»¶è§†è§’

- **ç½‘ç»œé€‚é…å™¨ / ç½‘å¡ (Adapter / NIC)**ï¼š
  - è¿æ¥åˆ°ä¸»æœºçš„ I/O æ€»çº¿ï¼Œè´Ÿè´£é“¾è·¯ä¸Šçš„**ç‰©ç†ä¿¡å·**å¤„ç†ã€‚
  - é€šè¿‡ **DMAï¼ˆç›´æ¥å†…å­˜è®¿é—®ï¼‰** ä¸ä¸»å­˜äº¤æ¢æ•°æ®ï¼š
    - æ•°æ®å¯åœ¨é€‚é…å™¨å’Œä¸»å­˜ä¹‹é—´ç›´æ¥ä¼ è¾“ï¼Œä¸å¿…ä¸€ç›´å ç”¨ CPUï¼Œå¤§å¹…æé«˜æ•ˆç‡ã€‚

  - ç½‘å¡é€šè¿‡**ä¸­æ–­**ä¸å†…æ ¸é€šä¿¡ï¼ˆé€šçŸ¥æ–°æ•°æ®åˆ°è¾¾ç­‰ï¼‰ã€‚

#### 2.2 å±€åŸŸç½‘ä¸äº’è”ç½‘ç»œ

- **å±€åŸŸç½‘ (LAN) è®¾å¤‡ï¼š**
  - **é›†çº¿å™¨ (Hub)**ï¼š
    - ç‰©ç†å±‚è®¾å¤‡ï¼Œå·¥ä½œæ–¹å¼æ˜¯ç®€å•**å¹¿æ’­**ã€‚
    - å°†ä»ä¸€ä¸ªç«¯å£æ”¶åˆ°çš„æ¯”ç‰¹å¤åˆ¶åˆ°æ‰€æœ‰å…¶ä»–ç«¯å£ï¼Œå› æ­¤æ‰€æœ‰ä¸»æœºéƒ½èƒ½çœ‹åˆ°æ‰€æœ‰æ•°æ®ã€‚
    - å®¹æ˜“äº§ç”Ÿå†²çªï¼Œä¸éš”ç¦»å†²çªåŸŸã€‚

  - **ç½‘æ¡¥ (Bridge)**ï¼š
    - é“¾è·¯å±‚è®¾å¤‡ï¼Œæ¯” Hub æ›´â€œæ™ºèƒ½â€ã€‚
    - é€šè¿‡å­¦ä¹ ç®—æ³•è‡ªåŠ¨å­¦ä¹ å„ä¸»æœºæ‰€è¿æ¥çš„ç«¯å£ï¼Œä»…åœ¨å¿…è¦æ—¶å°†å¸§è½¬å‘åˆ°ç‰¹å®šç«¯å£ã€‚
    - å¯ä»¥å‡å°‘ä¸å¿…è¦çš„å¹¿æ’­ã€**éš”ç¦»å†²çªåŸŸ**ï¼ŒèŠ‚çœå¸¦å®½ã€‚

- **è·¯ç”±å™¨ (Router)**ï¼š
  - ç”¨äºè¿æ¥ä¸åŒçš„ LAN å’Œ WANï¼ˆå¹¿åŸŸç½‘ï¼‰ï¼Œå¯ä»¥äº’è”**ä¸å…¼å®¹**çš„å±€åŸŸç½‘ã€‚
  - è·¯ç”±å™¨å¤„ç†**ç½‘ç»œå±‚ï¼ˆIPï¼‰**ï¼Œæ ¹æ®è·¯ç”±è¡¨ä¸ºæ•°æ®æŠ¥é€‰æ‹©è·¯å¾„ã€‚

- **åè®®è½¯ä»¶ (Protocol Software)**ï¼š
  - è¿è¡Œåœ¨**æ¯ä¸€å°ä¸»æœºå’Œæ¯ä¸€ä¸ªè·¯ç”±å™¨**ä¸Šã€‚
  - ç›®æ ‡æ˜¯**å±è”½åº•å±‚ç‰©ç†ç½‘ç»œå·®å¼‚**ï¼Œæä¾›ç»Ÿä¸€çš„æŠ½è±¡ã€‚
  - æ ¸å¿ƒèƒ½åŠ›ï¼š
    - **å‘½åæœºåˆ¶**ï¼šç»Ÿä¸€çš„ä¸»æœºåœ°å€æ ¼å¼ï¼ˆIP åœ°å€ï¼‰ã€‚
    - **ä¼ é€æœºåˆ¶**ï¼šç»Ÿä¸€çš„æ•°æ®åŒ…æ ¼å¼ï¼ˆIP æ•°æ®æŠ¥ / packetï¼‰ã€‚

---

### 3. å°è£…ä¸è·¨ç½‘ä¼ è¾“ç¤ºä¾‹

#### 3.1 A ä¸»æœºåˆ° B ä¸»æœºçš„æ•°æ®æµ

å½“ä¸»æœº A å‘å¦ä¸€ç½‘ç»œä¸­çš„ä¸»æœº B å‘é€æ•°æ®ï¼ˆç»ç”±è·¯ç”±å™¨ï¼‰æ—¶ï¼Œæ•°æ®ç»å†ä»¥ä¸‹é˜¶æ®µï¼š

1. **ç”¨æˆ·æ•°æ®**
   - å®¢æˆ·ç«¯è¿›ç¨‹é€šè¿‡ç³»ç»Ÿè°ƒç”¨ï¼ˆå¦‚ writeã€sendï¼‰å°†æ•°æ®ä»è‡ªå·±çš„**è™šæ‹Ÿåœ°å€ç©ºé—´**å¤åˆ¶åˆ°**å†…æ ¸ç¼“å†²åŒº**ã€‚

2. **IP åŒ… (Packet / Datagram)**
   - åè®®æ ˆåœ¨æ•°æ®å‰æ·»åŠ **IP åŒ…å¤´**ï¼Œå½¢æˆä¸€ä¸ª IP æ•°æ®æŠ¥ï¼š
     - åŒ…å«æº IP åœ°å€ã€ç›®çš„ IP åœ°å€ï¼ˆä¸»æœº B çš„ IPï¼‰ã€‚

3. **é“¾è·¯å±‚å¸§ (Frame)**
   - ä¸ºäº†åœ¨å½“å‰å±€åŸŸç½‘ï¼ˆå‡è®¾ä¸º LAN1ï¼‰ä¸Šä¼ è¾“ï¼Œå°† IP æ•°æ®æŠ¥å°è£…è¿›é“¾è·¯å±‚å¸§ä¸­ï¼š
     - æ·»åŠ  **LAN1 çš„å¸§å¤´**ã€‚
     - å¸§å¤´ä¸­çš„**ç›®çš„ MAC åœ°å€**æ˜¯**è·¯ç”±å™¨åœ¨ LAN1 ä¸Šçš„æ¥å£ MAC**ã€‚
     - æ³¨æ„æ­¤æ—¶ï¼š
       - **å¸§å¤´ä¸­çš„ç›®çš„åœ°å€æ˜¯â€œè·¯ç”±å™¨æ¥å£çš„ MACâ€**ã€‚
       - **åŒ…å¤´ä¸­çš„ç›®çš„åœ°å€ä»ç„¶æ˜¯â€œä¸»æœº B çš„ IPâ€**ã€‚

4. **è·¯ç”±å™¨è½¬å‘**
   - è·¯ç”±å™¨ä» LAN1 æ”¶åˆ°è¯¥å¸§ï¼š
     - å‰¥ç¦» LAN1 å¸§å¤´ â†’ å¾—åˆ° IP æ•°æ®æŠ¥ã€‚
     - æ£€æŸ¥ IP é¦–éƒ¨ä¸­çš„**ç›®çš„ IP åœ°å€**ã€‚
     - æŸ¥æ‰¾è·¯ç”±è¡¨ï¼Œå†³å®šä¸‹ä¸€è·³ã€‚

   - å‘ä¸‹ä¸€ç½‘ç»œï¼ˆLAN2ï¼‰è½¬å‘æ—¶ï¼š
     - å†ç»™åŒä¸€ä¸ª IP æ•°æ®æŠ¥æ·»åŠ **LAN2 çš„å¸§å¤´**ã€‚
     - å¸§å¤´ä¸­çš„ç›®çš„ MAC åœ°å€å¯èƒ½æ˜¯ä¸‹ä¸€è·³è·¯ç”±å™¨æˆ–æœ€ç»ˆä¸»æœº B çš„ MACã€‚

   - å¦‚æ­¤åå¤ï¼Œç›´åˆ°æ•°æ®åˆ°è¾¾ä¸»æœº Bã€‚

---

## ä¸‰ã€åè®®æ—ä¸åœ°å€

### 1. TCP/IP åè®®æ—

- **IPï¼ˆInternet Protocolï¼‰**
  - æä¾›**ä¸å¯é **çš„ä¸»æœºåˆ°ä¸»æœºæ•°æ®æŠ¥ä¼ è¾“ã€‚
  - å®šä¹‰äº†ç»Ÿä¸€çš„**å‘½åæ–¹å¼**ï¼ˆIP åœ°å€ï¼‰åŠ**æ•°æ®æŠ¥æ ¼å¼**ã€‚

- **UDPï¼ˆUser Datagram Protocolï¼‰**
  - åœ¨ IP ä¹‹ä¸Šæä¾›**ä¸å¯é çš„è¿›ç¨‹åˆ°è¿›ç¨‹æ•°æ®æŠ¥ä¼ è¾“**ã€‚

- **TCPï¼ˆTransmission Control Protocolï¼‰**
- åœ¨ IP ä¹‹ä¸Šæä¾›**å¯é çš„ã€æŒ‰åºçš„ã€å…¨åŒå·¥çš„å­—èŠ‚æµä¼ è¾“**ï¼Œé¢å‘è¿æ¥ã€‚

### 2. IP åœ°å€ä¸ç½‘ç»œå­—èŠ‚åº

#### 2.1 IPv4 / IPv6

- **IPv4**ï¼š32ä½åœ°å€ï¼Œé€šå¸¸ç”¨ç‚¹åˆ†åè¿›åˆ¶è¡¨ç¤ºï¼ˆå¦‚ `128.2.217.3`ï¼‰ã€‚æ€»æ˜¯ä»¥ç½‘ç»œå­—èŠ‚åºï¼ˆå¤§ç«¯åºï¼‰å­˜å‚¨ã€‚
- **IPv6**ï¼š128ä½åœ°å€ï¼Œæ—¨åœ¨è§£å†³IPv4åœ°å€è€—å°½é—®é¢˜ã€‚
- **å­ç½‘ (Subnets)**ï¼šIPåœ°å€åˆ†ä¸ºç½‘ç»œå·ï¼ˆNet IDï¼‰å’Œä¸»æœºå·ï¼ˆHost IDï¼‰ã€‚å­ç½‘æ©ç ï¼ˆå¦‚ `/24`ï¼‰å®šä¹‰äº†ç½‘ç»œéƒ¨åˆ†ã€‚

> [!important]
>
> > 2025 Lab Test ç½‘ç»œéƒ¨åˆ†è€ƒåˆ°äº†ï¼Œå¦‚æœä½ ä¼šç”¨åˆ°tailscaleï¼Œä½ å¯èƒ½ä¹Ÿä¼šæ¥è§¦åˆ°è¿™ä¸ªæ¦‚å¿µã€‚
>
> ### å­ç½‘ (Subnets)
>
> 1. ä»€ä¹ˆæ˜¯å­ç½‘ï¼Ÿ (What is a subnet?)
>
> ä»ç‰©ç†è¿æ¥çš„è§’åº¦æ¥çœ‹ï¼Œå­ç½‘æ˜¯ç”±ä¸€ç»„è®¾å¤‡çš„æ¥å£ï¼ˆInterfacesï¼‰ç»„æˆçš„ç½‘ç»œé›†åˆã€‚
>
> - **ç‰©ç†å¯è¾¾æ€§**ï¼šåœ¨åŒä¸€ä¸ªå­ç½‘å†…ï¼Œè®¾å¤‡ä¹‹é—´å‘é€æ•°æ®åŒ…å¯ä»¥**ç‰©ç†ä¸Šç›´æ¥åˆ°è¾¾**ï¼Œè€Œä¸éœ€è¦ç»è¿‡ä¸­é—´çš„è·¯ç”±å™¨ï¼ˆIntervening routerï¼‰ã€‚
> - **æ„æˆ**ï¼šä¸€ä¸ªå…¸å‹çš„å­ç½‘é€šå¸¸åŒ…å«å¤šä¸ªä¸»æœºçš„æ¥å£å’Œä¸€ä¸ªè·¯ç”±å™¨çš„æ¥å£ã€‚è¿™äº›æ¥å£é€šè¿‡ç‰©ç†é“¾è·¯ï¼ˆå¦‚ä»¥å¤ªç½‘äº¤æ¢æœºæˆ–æ— çº¿æ¥å…¥ç‚¹ï¼‰è¿æ¥åœ¨ä¸€èµ·ã€‚
> - IPåœ°å€çš„ç»“æ„ (IP Address Structure)
>
> ä¸ºäº†å®ç°å­ç½‘åˆ’åˆ†ï¼Œ32ä½çš„IPåœ°å€ï¼ˆIPv4ï¼‰è¢«é€»è¾‘ä¸Šåˆ’åˆ†ä¸ºä¸¤éƒ¨åˆ†ã€‚è¿™ç§ç»“æ„å…è®¸ç½‘ç»œç®¡ç†å‘˜å°†ä¸€ä¸ªå¤§çš„ç½‘ç»œé€šè¿‡è·¯ç”±æœºåˆ¶åˆ†å‰²æˆè‹¥å¹²ä¸ªè¾ƒå°çš„ç½‘ç»œã€‚
>
> - **å­ç½‘éƒ¨åˆ† (Subnet part)**ï¼š
>   - ä½äºIPåœ°å€çš„**é«˜ä½**ï¼ˆHigh order bitsï¼‰ã€‚
>   - **è§„åˆ™**ï¼šåœ¨åŒä¸€ä¸ªå­ç½‘ä¸­çš„æ‰€æœ‰è®¾å¤‡ï¼Œå…¶IPåœ°å€çš„è¿™ä¸€éƒ¨åˆ†**å¿…é¡»å®Œå…¨ç›¸åŒ**ã€‚è¿™éƒ¨åˆ†åœ°å€æ ‡è¯†äº†è®¾å¤‡æ‰€åœ¨çš„å…·ä½“ç½‘ç»œã€‚
> - **ä¸»æœºéƒ¨åˆ† (Host part)**ï¼š
>   - ä½äºIPåœ°å€çš„**ä½ä½**ï¼ˆLow order bitsï¼‰ã€‚
>   - **è§„åˆ™**ï¼šç”¨äºåŒºåˆ†åŒä¸€å­ç½‘å†…çš„ä¸åŒè®¾å¤‡ã€‚åœ¨åŒä¸€ä¸ªå­ç½‘ä¸­ï¼Œæ¯ä¸ªè®¾å¤‡çš„â€œä¸»æœºéƒ¨åˆ†â€å¿…é¡»æ˜¯å”¯ä¸€çš„ã€‚
> - å­ç½‘æ©ç ä¸CIDRè¡¨ç¤ºæ³• (Subnet Mask & CIDR)
>
> å­ç½‘æ©ç çš„ä½œç”¨å°±æ˜¯æ˜ç¡®åœ°å‘Šè¯‰è®¾å¤‡ï¼Œä¸€ä¸ªIPåœ°å€ä¸­ï¼Œå“ªä¸€éƒ¨åˆ†æ˜¯â€œå­ç½‘éƒ¨åˆ†â€ï¼Œå“ªä¸€éƒ¨åˆ†æ˜¯â€œä¸»æœºéƒ¨åˆ†â€ã€‚
>
> - **CIDR (æ— ç±»åˆ«åŸŸé—´è·¯ç”±) è¡¨ç¤ºæ³•**ï¼š
>   - é€šå¸¸ä½¿ç”¨ `/n` çš„å½¢å¼æ¥è¡¨ç¤ºã€‚
>   - **å«ä¹‰**ï¼š`/n` è¡¨ç¤ºIPåœ°å€çš„å‰ `n` ä½æ˜¯å­ç½‘éƒ¨åˆ†ã€‚
>   - **ç¤ºä¾‹**ï¼š
>     - åœ°å€ï¼š`223.1.1.0/24`
>     - **å­ç½‘æ©ç **ï¼š`/24`
>     - **è§£é‡Š**ï¼šè¿™ä¸ªIPåœ°å€çš„å‰24ä½ï¼ˆå³ `223.1.1`ï¼‰æ˜¯å­ç½‘IDï¼Œå‰©ä¸‹çš„8ä½æ˜¯ä¸»æœºIDã€‚
>     - è¿™æ„å‘³ç€è¯¥å­ç½‘å†…æ‰€æœ‰è®¾å¤‡çš„IPåœ°å€éƒ½å¿…é¡»ä»¥ `223.1.1` å¼€å¤´ï¼ˆä¾‹å¦‚ `223.1.1.1`, `223.1.1.2` ç­‰ï¼‰ã€‚
> - IPåœ°å€åˆ†ç±»ä¸ç‰¹æ®Šåœ°å€ (Classes & Private IPs)
>   - è™½ç„¶ç°ä»£ç½‘ç»œä¸»è¦ä½¿ç”¨CIDRï¼Œä½†äº†è§£ä¼ ç»Ÿçš„åˆ†ç±»å’Œç§æœ‰åœ°å€æœ‰åŠ©äºç†è§£å­ç½‘çš„èƒŒæ™¯ï¼š
>   - **ä¼ ç»Ÿåˆ†ç±» (Old-fashioned classes)**ï¼š
>     - **Aç±»**ï¼šå‰8ä½ä¸ºç½‘ç»œIDï¼ˆ0.0.0.0 - 127.255.255.255ï¼‰ã€‚
>     - **Bç±»**ï¼šå‰16ä½ä¸ºç½‘ç»œIDï¼ˆ128.0.0.0 - 191.255.255.255ï¼‰ã€‚ ==åŒ—å¤§çš„ç½‘æ˜¯è¿™ä¸€ç±»==
>     - **Cç±»**ï¼šå‰24ä½ä¸ºç½‘ç»œIDï¼ˆ192.0.0.0 - 223.255.255.255ï¼‰ã€‚
>   - ç§æœ‰/ä¸“ç”¨IPåœ°å€ (Private IP addresses)ï¼š
>     - è¿™äº›åœ°å€è¢«ä¿ç•™ç”¨äºå±€åŸŸç½‘å†…éƒ¨ï¼Œä¸ä¼šåœ¨å…¬å…±äº’è”ç½‘ä¸Šè¿›è¡Œè·¯ç”±ï¼ˆè·¯ç”±å™¨ä¼šä¸¢å¼ƒç›®æ ‡ä¸ºè¿™äº›åœ°å€çš„åŒ…ï¼‰ï¼š
>       - `10.0.0.0/8`
>         - `172.16.0.0/12`
>         - `192.168.0.0/16`
>
> - æ€»ç»“
>   - å­ç½‘é€šè¿‡å­ç½‘æ©ç ï¼ˆå¦‚ /24ï¼‰å°†32ä½IPåœ°å€ä»é€»è¾‘ä¸Šâ€œåˆ‡å‰²â€ä¸ºç½‘ç»œå·å’Œä¸»æœºå·ã€‚è¿™ç§æœºåˆ¶ä¸ä»…è§£å†³äº†IPåœ°å€çš„ç®¡ç†é—®é¢˜ï¼Œè¿˜é€šè¿‡è·¯ç”±å™¨å°†ä¸åŒçš„å­ç½‘è¿æ¥èµ·æ¥ï¼Œæ„æˆäº†åºå¤§çš„äº’è”ç½‘ç»“æ„ã€‚

- **ä¸“ç”¨åœ°å€ (Private Addresses)**ï¼šå¦‚ `10.0.0.0/8`, `192.168.0.0/16`ï¼Œä¸å¯åœ¨å…¬å…±äº’è”ç½‘è·¯ç”±ã€‚

#### 2.2 ä»£ç ä¸­çš„è¡¨ç¤º

```c
struct in_addr {
    uint32_t s_addr; /* ç½‘ç»œå­—èŠ‚é¡ºåºï¼ˆå¤§ç«¯ï¼‰ */
};
```

- IP åœ°å€åœ¨ C ä»£ç ä¸­é€šå¸¸è¢«å°è£…åœ¨ `struct in_addr` ä¸­ã€‚

#### 2.3 å­—èŠ‚åºä¸è½¬æ¢

- ç½‘ç»œåè®®è§„å®šï¼š**ç½‘ç»œå­—èŠ‚åº**ç»Ÿä¸€é‡‡ç”¨**å¤§ç«¯æ¨¡å¼ (Big-Endian)**ã€‚
- è®¸å¤šä¸»æœºï¼ˆå¦‚ x86ï¼‰é‡‡ç”¨**å°ç«¯æ¨¡å¼ (Little-Endian)**ã€‚
- åœ¨å‘ç½‘ç»œæŠ¥æ–‡é¦–éƒ¨å¡«å…¥å¤šå­—èŠ‚æ•´æ•°ï¼ˆå¦‚ IP åœ°å€ã€ç«¯å£å·ï¼‰æ—¶ï¼Œå¿…é¡»è¿›è¡Œå­—èŠ‚åºè½¬æ¢ï¼š
  - `htonl` / `htons`ï¼šHost to Network (long / short)
  - `ntohl` / `ntohs`ï¼šNetwork to Host (long / short)

---

### 3. åŸŸåç³»ç»Ÿ (DNS)

- DNS æ˜¯ä¸€ä¸ªå·¨å¤§çš„**åˆ†å¸ƒå¼æ•°æ®åº“**ï¼Œç»´æŠ¤ä»**åŸŸååˆ° IP åœ°å€**çš„æ˜ å°„ã€‚
- åŸŸåç»“æ„æ˜¯**åˆ†å±‚çš„**ï¼Œå¦‚ `www.cmu.edu`ï¼š
  - æ ¹ â†’ é¡¶çº§åŸŸå `.edu` â†’ äºŒçº§åŸŸå `cmu` â†’ ä¸»æœºå `www`ã€‚

- æ˜ å°„å…³ç³»å¯èƒ½æ˜¯ï¼š
  - **å¤šå¯¹ä¸€**ï¼šå¤šä¸ªåŸŸåæŒ‡å‘åŒä¸€ IPï¼ˆé€šå¸¸ç”¨äºè™šæ‹Ÿä¸»æœºï¼‰ã€‚
  - **ä¸€å¯¹å¤š**ï¼šä¸€ä¸ªåŸŸåæ˜ å°„åˆ°å¤šä¸ª IPï¼ˆé€šå¸¸ç”¨äºè´Ÿè½½å‡è¡¡ï¼‰ã€‚

- å·¥å…· **nslookup** å¯ç”¨äºæŸ¥è¯¢ DNS è®°å½•ã€‚
- ç‰¹æ®Šæ˜ å°„ï¼š`localhost` æ€»æ˜¯æ˜ å°„åˆ°**å›ç¯åœ°å€** `127.0.0.1`ã€‚

---

### 4. è¿æ¥ã€ç«¯å£ä¸å¥—æ¥å­—å¯¹ (Socket Pair)

#### 4.1 TCP è¿æ¥çš„ç‰¹æ€§

- ä¸€ä¸ª TCP è¿æ¥æ˜¯**ç‚¹å¯¹ç‚¹ (point-to-point)** çš„ï¼š
  - åªæœ‰ä¸¤ä¸ªç«¯ç‚¹è¿›ç¨‹å‚ä¸ã€‚

- æä¾›ï¼š
  - å…¨åŒå·¥ï¼ˆåŒæ–¹å¯åŒæ—¶å‘é€/æ¥æ”¶ï¼‰ã€‚
  - å¯é ã€æœ‰åºçš„å­—èŠ‚æµæœåŠ¡ã€‚

#### 4.2 å¥—æ¥å­—åœ°å€ä¸ç«¯å£

- **å¥—æ¥å­—åœ°å€**ï¼š`IP åœ°å€ : ç«¯å£å·`ã€‚
  - ==è¿™æ˜¯socketçš„åœ°å€==
  - `IP:Port` æ˜¯ socket ç»‘å®šæˆ–ä½¿ç”¨çš„åœ°å€æ ‡è¯†ï¼Œä½† socket æœ¬èº«æ˜¯å†…æ ¸ä¸­çš„é€šä¿¡ç«¯ç‚¹å¯¹è±¡ï¼Œä¸ç­‰åŒäº `IP:Port`ã€‚
- **ç«¯å£ (Port)**ï¼š
  - 16 ä½æ•´æ•°ï¼Œç”¨äºåŒºåˆ†åŒä¸€ä¸»æœºä¸Šçš„ä¸åŒè¿›ç¨‹/æœåŠ¡ã€‚

- **ç«¯å£ç±»å‹**ï¼š
  - **ä¸´æ—¶ç«¯å£ (Ephemeral Port)**ï¼š
  - å®¢æˆ·ç«¯å‘èµ·è¿æ¥æ—¶ç”±å†…æ ¸è‡ªåŠ¨åˆ†é…çš„çŸ­æš‚ç«¯å£ï¼ˆå¦‚ 51213ï¼‰ã€‚
  - **çŸ¥åç«¯å£ (Well-known Port, 0â€“1023)**ï¼š
    - æ°¸ä¹…åˆ†é…ç»™ç‰¹å®šæœåŠ¡ï¼Œä»¥ä¾¿å®¢æˆ·ç«¯æ‰¾åˆ°æœåŠ¡å™¨ã€‚
    - å…¸å‹ç¤ºä¾‹ï¼š
      - HTTPï¼š80
      - HTTPSï¼š443
      - SMTPï¼š25
      - SSHï¼š22
      - Echoï¼š7

#### 4.3 å¥—æ¥å­—å¯¹ (Socket Pair)

- ä¸€ä¸ªè¿æ¥å¯ä»¥å”¯ä¸€åœ°ç”±ä¸€ä¸ª**å¥—æ¥å­—å¯¹**æ ‡è¯†ï¼š
  - $(\text{cliaddr} : \text{cliport},\ \text{servaddr} : \text{servport})$

- ç¤ºä¾‹ï¼š
  - å®¢æˆ·ç«¯ IPï¼š`128.2.194.242`ï¼Œå®¢æˆ·ç«¯ç«¯å£ï¼š`51213`ï¼ˆä¸´æ—¶ç«¯å£ï¼‰
  - æœåŠ¡å™¨ IPï¼š`208.216.181.15`ï¼ŒæœåŠ¡å™¨ç«¯å£ï¼š`80`ï¼ˆHTTPï¼‰
  - å¥—æ¥å­—å¯¹ï¼š
    - `(128.2.194.242:51213, 208.216.181.15:80)`

---

## å››ã€å¥—æ¥å­—æ¥å£ä¸åœ°å€ç»“æ„

### 1. Socket æ¥å£çš„æŠ½è±¡

- å¥—æ¥å­—æ¥å£æ˜¯**ç”¨æˆ·è¿›ç¨‹**ä¸**å†…æ ¸ä¸­ TCP/IP åè®®æ ˆ**ä¹‹é—´çš„æ¡¥æ¢ã€‚
- ä»ç¼–ç¨‹è§’åº¦çœ‹ï¼Œç½‘ç»œè¿æ¥è¢«æŠ½è±¡æˆä¸€ç§â€œç‰¹æ®Šçš„æ–‡ä»¶æè¿°ç¬¦â€ï¼Œå¯ä»¥ä½¿ç”¨ä¸ Unix I/O ç±»ä¼¼çš„ read/write æ“ä½œã€‚

### 2. åœ°å€ç»“æ„

#### 2.1 é€šç”¨åœ°å€ç»“æ„ï¼š`struct sockaddr`

```c
struct sockaddr {
    uint16_t sa_family;  // åè®®æ—
    char     sa_data[14];// åœ°å€æ•°æ®
};
```

- è®¸å¤š Socket API å‡½æ•°çš„å‚æ•°ç±»å‹è¢«å£°æ˜ä¸º `struct sockaddr *`ï¼Œä»¥å®ç°**åè®®æ— å…³æ€§**ã€‚

#### 2.2 IPv4 ä¸“ç”¨ç»“æ„ï¼š`struct sockaddr_in`

```c
struct sockaddr_in {
    uint16_t        sin_family;   /* åè®®æ—ï¼Œå¿…é¡»ä¸º AF_INET */
    uint16_t        sin_port;     /* ç«¯å£å· (ç½‘ç»œå­—èŠ‚åº) */
    struct in_addr  sin_addr;     /* IP åœ°å€ (ç½‘ç»œå­—èŠ‚åº) */
    unsigned char   sin_zero[8];  /* å¡«å……å­—èŠ‚ */
};
```

- å®é™…ä½¿ç”¨ä¸­ä¸€èˆ¬å¡«å…… `sockaddr_in`ï¼Œåœ¨è°ƒç”¨ `connect/bind/accept` ç­‰å‡½æ•°æ—¶å¼ºåˆ¶è½¬æ¢ä¸º `(struct sockaddr *)`ã€‚

---

### 3. æ ¸å¿ƒç³»ç»Ÿè°ƒç”¨

#### 3.1 `socket`

```c
int socket(int domain, int type, int protocol);
```

- åˆ›å»ºä¸€ä¸ªæ–°çš„å¥—æ¥å­—æè¿°ç¬¦ã€‚
- å‚æ•°ï¼š
  - `domain`ï¼šåè®®åŸŸï¼Œå¦‚ `AF_INET` è¡¨ç¤º IPv4ã€‚
  - `type`ï¼šå¥—æ¥å­—ç±»å‹ï¼Œå¦‚ `SOCK_STREAM` è¡¨ç¤º TCP æµå¼å¥—æ¥å­—ã€‚
  - `protocol`ï¼šé€šå¸¸ä¸º 0ï¼Œç”±å†…æ ¸è‡ªåŠ¨é€‰æ‹©ã€‚

- è¿”å›ï¼š
  - æˆåŠŸï¼šè¿”å›ä¸€ä¸ª**éè´Ÿ**æ–‡ä»¶æè¿°ç¬¦ï¼Œä½†å®ƒè¿˜åªæ˜¯â€œ**éƒ¨åˆ†æ‰“å¼€**â€çš„ï¼Œä¸èƒ½ç›´æ¥è¯»å†™ã€‚
  - å¤±è´¥ï¼šè¿”å› -1ã€‚

#### 3.2 `bind`ï¼ˆæœåŠ¡å™¨ï¼‰

```c
int bind(int sockfd, const struct sockaddr *addr, socklen_t addrlen);
```

- å°†ä¸€ä¸ª**å¥—æ¥å­—åœ°å€ï¼ˆIP + ç«¯å£ï¼‰**ä¸å¥—æ¥å­—æè¿°ç¬¦å…³è”ã€‚
- å¸¸ç”¨äºæœåŠ¡å™¨ç«¯ï¼ŒæŒ‡å®šç›‘å¬çš„ IP å’Œç«¯å£ã€‚

#### 3.3 `listen`ï¼ˆæœåŠ¡å™¨ï¼‰

```c
int listen(int sockfd, int backlog);
```

- å°†ä¸€ä¸ªä¸»åŠ¨å¥—æ¥å­—è½¬æ¢æˆ**ç›‘å¬å¥—æ¥å­— (listening socket)**ã€‚
- `sockfd`ï¼šä¹‹å‰ç”± `socket()` åˆ›å»ºå¹¶ç»‘å®šäº†åœ°å€ã€‚
- `backlog`ï¼šå†…æ ¸å…è®¸çš„**æ’é˜Ÿè¿æ¥è¯·æ±‚æ•°é‡ä¸Šé™**ï¼ˆæœªå®Œæˆè¿æ¥é˜Ÿåˆ—é•¿åº¦çš„æç¤ºï¼‰ï¼Œé€šå¸¸è®¾ç½®è¾ƒå¤§ï¼Œå¦‚ 1024ã€‚

#### 3.4 `accept`ï¼ˆæœåŠ¡å™¨ï¼‰

```c
int accept(int sockfd, struct sockaddr *addr, socklen_t *addrlen);
```

- é˜»å¡ç­‰å¾…æ¥è‡ªå®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ã€‚
- å‚æ•°ï¼š
  - `listenfd`ï¼šç›‘å¬å¥—æ¥å­—æè¿°ç¬¦ï¼Œå­˜åœ¨äºæ•´ä¸ªæœåŠ¡å™¨ç”Ÿå‘½å‘¨æœŸä¸­ã€‚
  - `addr`ï¼šè¾“å‡ºå‚æ•°ï¼Œå†…æ ¸åœ¨æ­¤å¡«å…¥**å®¢æˆ·ç«¯çš„å¥—æ¥å­—åœ°å€**ã€‚
  - `addrlen`ï¼šåœ°å€é•¿åº¦ã€‚

- è¿”å›å€¼ï¼š
  - æˆåŠŸï¼šè¿”å›ä¸€ä¸ªæ–°çš„**å·²è¿æ¥æè¿°ç¬¦ (connected descriptor)**ï¼Œç”¨äºä¸è¯¥å®¢æˆ·ç«¯è¿›è¡Œè¯»å†™ã€‚
  - å¤±è´¥ï¼šè¿”å› -1ã€‚

- å…³é”®åŒºåˆ«ï¼š
  - **ç›‘å¬æè¿°ç¬¦ (listenfd)**ï¼šåªè´Ÿè´£æ¥æ”¶æ–°è¿æ¥ï¼Œä¸€èˆ¬åªåˆ›å»ºä¸€æ¬¡ï¼Œå¾ªç¯ä½¿ç”¨ã€‚
  - **å·²è¿æ¥æè¿°ç¬¦ (connfd)**ï¼šæ¯æ¥å—ä¸€ä¸ªæ–°è¿æ¥å°±æ–°ç”Ÿæˆä¸€ä¸ªï¼Œç”¨äºä¸è¯¥å®¢æˆ·ç«¯é€šä¿¡ï¼Œç”¨å®Œå°±å…³é—­ã€‚
  - è¿™ç§åŒºåˆ†ä½¿å¾—æœåŠ¡å™¨å¯ä»¥é€šè¿‡å¤šè¿›ç¨‹/å¤šçº¿ç¨‹/äº‹ä»¶é©±åŠ¨ç­‰æ–¹å¼å®ç°å¹¶å‘å¤„ç†ã€‚

> [!important]
>
> > **`listenfd` å’Œ `connfd` æ˜¯å®Œå…¨ä¸åŒçš„ socket å¯¹è±¡**
>
> - `listenfd`ï¼š
>   - çŠ¶æ€ï¼š`LISTEN`
>   - ä¸èƒ½ `read/write`
> - `connfd`ï¼š
>   - çŠ¶æ€ï¼š`ESTABLISHED`
>   - ä¸“é—¨ç”¨äºé€šä¿¡
>
> **åŒä¸€ä¸ªç«¯å£ï¼ˆæ¯”å¦‚ 80ï¼‰å¯ä»¥åŒæ—¶å­˜åœ¨ï¼š**
>
> - 1 ä¸ª `listenfd`
> - N ä¸ª `connfd`ï¼ˆæ¯ä¸ªå®¢æˆ·ç«¯ä¸€ä¸ªï¼‰
>
> è¿™æ­£æ˜¯å¹¶å‘æœåŠ¡å™¨çš„åŸºç¡€ã€‚

#### 3.5 `connect`ï¼ˆå®¢æˆ·ç«¯ï¼‰

```c
int connect(int clientfd, const struct sockaddr *addr, socklen_t addrlen);
```

- å®¢æˆ·ç«¯è°ƒç”¨ï¼Œå‘æœåŠ¡å™¨å‘èµ·è¿æ¥è¯·æ±‚ã€‚
- æˆåŠŸè¿”å› 0ï¼Œæ­¤æ—¶è¿æ¥å»ºç«‹ï¼›å¤±è´¥è¿”å› -1ã€‚

> [!note]
>
> ä¸ºä»€ä¹ˆaddrlençš„ç±»å‹ä¸ä¸€æ ·ï¼Ÿ
>
> | **å‡½æ•°**      | **connect**               | **accept**                                  |
> | ------------- | ------------------------- | ------------------------------------------- |
> | **æ•°æ®æµå‘**  | **å•å‘** (App -> Kernel)  | **åŒå‘** (App <-> Kernel)                   |
> | **ä½ çš„è§’è‰²**  | **ä¸‹å‘½ä»¤çš„äºº**            | **æ¥æ”¶æŠ¥å‘Šçš„äºº**                            |
> | **å‚æ•°å«ä¹‰**  | â€œæˆ‘å†™çš„åœ°å€æœ‰è¿™ä¹ˆé•¿â€      | è¿›ï¼šâ€œæˆ‘åªèƒ½è£…è¿™ä¹ˆå¤§â€ å‡ºï¼šâ€œå…¶å®åªè£…äº†è¿™ä¹ˆå¤§â€ |
> | **Cè¯­è¨€æœºåˆ¶** | **ä¼ å€¼** (Pass by Value)  | **ä¼ å€** (Pass by Reference / Pointer)      |
> | **æœ¯è¯­**      | è¾“å…¥å‚æ•° (Input Argument) | **å€¼-ç»“æœå‚æ•° (Value-Result Argument)**     |

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯ (Customer)
    participant OS_Client as å®¢æˆ·ç«¯å†…æ ¸
    participant Network as äº’è”ç½‘
    participant OS_Server as æœåŠ¡å™¨å†…æ ¸
    participant Server as æœåŠ¡å™¨ (Pizza Shop)

    Note over Server, OS_Server: ã€é˜¶æ®µä¸€ï¼šå‡†å¤‡è¢«åŠ¨ Socketã€‘<br/>å°±åƒå®‰è£…æ€»æœºç”µè¯
    Server->>OS_Server: socket()
    OS_Server-->>Server: è¿”å› fd=3 (åˆå§‹ Socket)
    Server->>OS_Server: bind(fd=3, IP:80)
    Server->>OS_Server: listen(fd=3)<br/>å˜èº«ä¸º"è¢«åŠ¨ Socket"
    Note right of OS_Server: fd=3 è¿›å…¥ LISTEN çŠ¶æ€<br/>(åªæ¥ç”µè¯ï¼Œä¸èŠå¤©)

    Note over Client, OS_Client: ã€é˜¶æ®µäºŒï¼šå‘èµ·ä¸»åŠ¨è¿æ¥ã€‘<br/>é¡¾å®¢æ‹¨æ‰“ç”µè¯
    Client->>OS_Client: socket()
    OS_Client-->>Client: è¿”å› fd=5 (ä¸»åŠ¨ Socket)
    Client->>OS_Client: connect(fd=5, ServerIP:80)
    OS_Client->>Network: å‘é€ TCP SYN åŒ…
    Network->>OS_Server: ä¼ é€’è¿æ¥è¯·æ±‚

    Note over OS_Server, Server: ã€é˜¶æ®µä¸‰ï¼šæ¡æ‰‹ä¸ç”Ÿäº§æ–° Socketã€‘
    OS_Server->>OS_Server: å®Œæˆä¸‰æ¬¡æ¡æ‰‹
    OS_Server->>Server: æœ‰æ–°è¿æ¥å°±ç»ª (Readable)
    Server->>OS_Server: accept(fd=3)
    OS_Server-->>Server: è¿”å› fd=4 (æ–° Socket!)<br/>è¿™æ˜¯ä¸€ä¸ª"å·²è¿æ¥ Socket"
    Note right of OS_Server: fd=3 ç»§ç»­ç›‘å¬åˆ«äºº<br/>fd=4 ä¸“é—¨æœåŠ¡è¿™ä¸ªå®¢æˆ·

    Note over Client, Server: ã€é˜¶æ®µå››ï¼šæ•°æ®ä¼ è¾“ã€‘<br/>ä½¿ç”¨ fd=5 å’Œ fd=4 å¯¹è¯
    Client->>OS_Client: write(fd=5, "Hello")
    OS_Client->>Network: æ•°æ®åŒ…
    Network->>OS_Server: æ•°æ®åŒ…
    OS_Server-->>Server: read(fd=4) è¯»å–åˆ° "Hello"

    Server->>OS_Server: write(fd=4, "Pizza Ready")
    OS_Server->>Network: æ•°æ®åŒ…
    Network->>OS_Client: æ•°æ®åŒ…
    OS_Client-->>Client: read(fd=5) è¯»å–åˆ° "Pizza Ready"

    Note over Client, Server: ã€é˜¶æ®µäº”ï¼šæ–­å¼€è¿æ¥ã€‘
    Client->>OS_Client: close(fd=5)
    OS_Client->>Network: å‘é€ FIN åŒ…
    Network->>OS_Server: ä¼ é€’æ–­å¼€è¯·æ±‚
    OS_Server-->>Server: read(fd=4) è¿”å› 0 (EOF)
    Server->>OS_Server: close(fd=4)
```

---

### 4. ç°ä»£åœ°å€è§£æï¼š`getaddrinfo`

- `getaddrinfo` æ˜¯ä¸€ç§**åè®®æ— å…³ã€å¯é‡å…¥ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰**çš„åœ°å€è§£æå‡½æ•°ï¼Œç”¨äºå–ä»£è€æ—§çš„ `gethostbyname`ã€‚

```c
int getaddrinfo(
    const char *node,
    const char *service,
    const struct addrinfo *hints,
    struct addrinfo **res
);
```

#### 4.1 ä¸»è¦ç‰¹ç‚¹

- å¯ä»¥åŒæ—¶æ”¯æŒ **IPv4 å’Œ IPv6**ã€‚
- è¿”å›ä¸€ä¸ª `addrinfo` ç»“æ„çš„**é“¾è¡¨**ï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ éƒ½å¯ä»¥ç›´æ¥ç”¨äº `socket`, `bind`, `connect` ç­‰å‡½æ•°ã€‚

```c
struct addrinfo {
    int              ai_flags;
    int              ai_family;     // AF_INET / AF_INET6
    int              ai_socktype;   // SOCK_STREAM / SOCK_DGRAM
    int              ai_protocol;   // IPPROTO_TCP / IPPROTO_UDP
    socklen_t        ai_addrlen;
    struct sockaddr *ai_addr;       // â˜… çœŸæ­£å¯ç”¨çš„åœ°å€
    char            *ai_canonname;
    struct addrinfo *ai_next;       // â˜… é“¾è¡¨
};

```

```yaml
res
 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ addrinfo #1                 â”‚
â”‚ ai_family    = AF_INET6     â”‚
â”‚ ai_socktype  = SOCK_STREAM  â”‚
â”‚ ai_protocol  = IPPROTO_TCP  â”‚
â”‚ ai_addr â†’ sockaddr_in6      â”‚
â”‚           ip = 2606:2800:...â”‚
â”‚           port = 80         â”‚
â”‚ ai_next â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ addrinfo #2                 â”‚
â”‚ ai_family    = AF_INET      â”‚
â”‚ ai_socktype  = SOCK_STREAM  â”‚
â”‚ ai_protocol  = IPPROTO_TCP  â”‚
â”‚ ai_addr â†’ sockaddr_in       â”‚
â”‚           ip = 93.184.216.34â”‚
â”‚           port = 80         â”‚
â”‚ ai_next = NULL              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.2 `hints` æ ‡å¿—ä½

- `AI_PASSIVE`ï¼š
  - è¿”å›é€‚åˆç”¨äºæœåŠ¡å™¨ `bind` å’Œ `listen` çš„åœ°å€ï¼ˆé€šé…ç¬¦åœ°å€ï¼‰ï¼Œç›‘å¬æœ¬æœºä¸Šçš„æ‰€æœ‰ IPã€‚
  - â€œæˆ‘ä¸æ˜¯è¦è¿åˆ«äººï¼Œæˆ‘æ˜¯è¦ç­‰åˆ«äººæ¥è¿æˆ‘ã€‚â€

- `AI_ADDRCONFIG`ï¼š
  - åªæœ‰å½“æœ¬æœºé…ç½®äº† IPv4 æ—¶æ‰è¿”å› IPv4 åœ°å€ï¼ˆç±»ä¼¼åœ°å¯¹ IPv6ï¼‰ï¼Œé¿å…ç”Ÿæˆæ— æ„ä¹‰åœ°å€ã€‚
    - åªè¿”å›**æœ¬æœºçœŸçš„èƒ½ç”¨**çš„åœ°å€æ—
    - å‡å°‘æ— æ•ˆè¿æ¥å°è¯•
- `AI_NUMERICSERV`ï¼š
  - å°†æœåŠ¡å‚æ•°è§†ä¸º**æ•°å­—ç«¯å£**ï¼ˆä¾‹å¦‚ `"80"`ï¼‰ï¼Œè€Œä¸æ˜¯æœåŠ¡åï¼ˆä¾‹å¦‚ `"http"`ï¼‰ã€‚
  - â€œæˆ‘ç»™ä½ çš„ç«¯å£æ˜¯æ•°å­—ï¼Œä¸æ˜¯æœåŠ¡åï¼Œåˆ«å»æŸ¥æœåŠ¡è¡¨ã€‚â€

#### 4.3 ç›¸å…³è¾…åŠ©å‡½æ•°

- `freeaddrinfo`ï¼šé‡Šæ”¾ç”± `getaddrinfo` è¿”å›çš„é“¾è¡¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ã€‚
- `gai_strerror`ï¼šå°† `getaddrinfo` çš„é”™è¯¯ç è½¬æ¢ä¸ºå¯è¯»å­—ç¬¦ä¸²ã€‚
- `getnameinfo`ï¼š`getaddrinfo` çš„é€†æ“ä½œï¼Œå°†å¥—æ¥å­—åœ°å€è½¬æ¢ä¸ºä¸»æœºåã€æœåŠ¡åå­—ç¬¦ä¸²ã€‚

---

### 5. é«˜å±‚å°è£…è¾…åŠ©å‡½æ•°

å¸¸è§äº CSAPP/è¯¾ç¨‹ä»£ç åº“ï¼Œç”¨äºç®€åŒ–å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯çš„ Socket åˆ›å»ºæµç¨‹ï¼š

#### 5.1 `open_clientfd(hostname, port)`

- ç”¨äº**å®¢æˆ·ç«¯**å»ºç«‹åˆ°æœåŠ¡å™¨çš„è¿æ¥ã€‚
- å¤§è‡´æ­¥éª¤ï¼š
  1. è°ƒç”¨ `getaddrinfo` è·å–æœåŠ¡å™¨çš„åœ°å€åˆ—è¡¨ï¼Œä¸€èˆ¬è®¾ç½® `AI_ADDRCONFIG`ã€‚
  2. éå†åˆ—è¡¨ï¼Œå¯¹æ¯ä¸ªå€™é€‰åœ°å€ï¼š
     - è°ƒç”¨ `socket()` åˆ›å»ºå¥—æ¥å­—ã€‚
     - è°ƒç”¨ `connect()` å°è¯•å»ºç«‹è¿æ¥ã€‚
     - ä¸€æ—¦æˆåŠŸå°±åœæ­¢å°è¯•å¹¶è¿”å›è¯¥æè¿°ç¬¦ã€‚

  3. å…¨éƒ¨å¤±è´¥åˆ™è¿”å›é”™è¯¯ã€‚

#### 5.2 `open_listenfd(port)`

- ç”¨äº**æœåŠ¡å™¨ç«¯**åˆ›å»ºå¹¶é…ç½®ç›‘å¬å¥—æ¥å­—ã€‚
- å¤§è‡´æ­¥éª¤ï¼š
  1. è°ƒç”¨ `getaddrinfo`ï¼Œè®¾ç½® `AI_PASSIVE`ï¼Œè·å–é€‚åˆç»‘å®šçš„æœ¬åœ°åœ°å€ï¼ˆé€šå¸¸ä¸ºé€šé…ç¬¦åœ°å€ï¼‰ã€‚
  2. è°ƒç”¨ `socket()` åˆ›å»ºå¥—æ¥å­—ã€‚
  3. è°ƒç”¨ `setsockopt()` è®¾ç½® `SO_REUSEADDR`ï¼š
     - å…è®¸æœåŠ¡å™¨é‡å¯åç«‹å³é‡ç”¨åŒä¸€ç«¯å£ï¼Œé¿å…â€œAddress already in useâ€é”™è¯¯ã€‚

  4. è°ƒç”¨ `bind()` ç»‘å®šç«¯å£ã€‚
  5. è°ƒç”¨ `listen()` å¼€å¯ç›‘å¬ã€‚

![image-20251211143102820](part3.assets/image-20251211143102820.png)

---

## äº”ã€å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨å…¸å‹æµç¨‹

### 1. å®¢æˆ·ç«¯å…¸å‹æµç¨‹

1. ä½¿ç”¨ `getaddrinfo` å°†æœåŠ¡å™¨ä¸»æœºåå’Œç«¯å£å­—ç¬¦ä¸²è½¬æ¢ä¸ºå€™é€‰åœ°å€åˆ—è¡¨ã€‚
2. è°ƒç”¨ `socket` åˆ›å»ºå¥—æ¥å­—ã€‚
3. è°ƒç”¨ `connect` å»ºç«‹è¿æ¥ã€‚
4. ä½¿ç”¨ **Robust I/Oï¼ˆå¦‚ Rio_read / Rio_writenï¼‰** æˆ–æ ‡å‡† `read/write` è¿›è¡Œæ•°æ®æ”¶å‘ã€‚
5. æ”¶å‘å®Œæ¯•åè°ƒç”¨ `close` å…³é—­è¿æ¥ã€‚

### 2. æœåŠ¡å™¨å…¸å‹æµç¨‹

1. ä½¿ç”¨ `getaddrinfo`ï¼ˆå¸¦ `AI_PASSIVE` æ ‡å¿—ï¼‰æ„é€ æœ¬åœ°ç›‘å¬åœ°å€ã€‚
2. è°ƒç”¨ `socket` åˆ›å»ºå¥—æ¥å­—ã€‚
3. å¯é€‰ï¼š`setsockopt` è®¾ç½® `SO_REUSEADDR`ã€‚
4. è°ƒç”¨ `bind` ç»‘å®šç«¯å£ã€‚
5. è°ƒç”¨ `listen` åˆ›å»ºç›‘å¬é˜Ÿåˆ—ã€‚
6. è¿›å…¥å¾ªç¯ï¼š
   - è°ƒç”¨ `accept` è·å–æ–°çš„å·²è¿æ¥æè¿°ç¬¦ `connfd`ã€‚
   - ä½¿ç”¨ `Rio_read / Rio_writen` æˆ– `read/write` ä¸è¯¥å®¢æˆ·ç«¯é€šä¿¡ã€‚
   - å®Œæˆå `close(connfd)`ã€‚

7. `listenfd` ä¸€èˆ¬åœ¨æœåŠ¡å™¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…ä¸€ç›´å­˜åœ¨ã€‚

![image-20251208145348201](part3.assets/image-20251208145348201.png)

---

## å…­ã€Web ä¸ HTTP åŸºç¡€

### 1. HTTP åè®®ä¸å†…å®¹

- HTTP è¿è¡Œåœ¨ **TCP** ä¹‹ä¸Šã€‚
- **å†…å®¹ (Content)**ï¼š
  - ä¸€ä¸²å­—èŠ‚ + å¯¹åº”çš„ **MIME ç±»å‹**ï¼ˆå¦‚ `text/html`, `image/jpeg` ç­‰ï¼‰ã€‚

### 2. URL ç»“æ„

- é€šç”¨å½¢å¼ï¼š`http://host:port/path`
  - å‰ç¼€åŒ…å«åè®®ã€æœåŠ¡å™¨åœ°å€ä¸ç«¯å£ï¼ˆå¦‚ `http://www.cmu.edu:80`ï¼‰ã€‚
  - åç¼€ `path` ç”±æœåŠ¡å™¨è§£æï¼Œå†³å®šè®¿é—®çš„èµ„æºï¼ˆå¦‚ `/index.html` æˆ– `/cgi-bin/adder` ç­‰ï¼‰ã€‚

### 3. HTTP æŠ¥æ–‡ç»“æ„

- **è¯·æ±‚ (Request)**ï¼š
  - è¯·æ±‚è¡Œï¼š`GET /index.html HTTP/1.1`
  - è¯·æ±‚å¤´éƒ¨ï¼šå¦‚ `Host: www.cmu.edu` ç­‰ã€‚

- **å“åº” (Response)**ï¼š
  - çŠ¶æ€è¡Œï¼š`HTTP/1.1 200 OK`
  - å“åº”å¤´éƒ¨ï¼šå¦‚ `Content-Type`, `Content-Length` ç­‰ã€‚
  - ç©ºè¡Œåæ˜¯**å“åº”ä½“**ï¼ˆé¡µé¢ HTMLã€å›¾ç‰‡å­—èŠ‚ç­‰ï¼‰ã€‚

### 4. é™æ€å†…å®¹ä¸åŠ¨æ€å†…å®¹

- **é™æ€å†…å®¹ (Static Content)**ï¼š
  - ç”±ç£ç›˜ä¸Šçš„æ–‡ä»¶ç›´æ¥æä¾›ã€‚
  - æœåŠ¡å™¨åªéœ€è¯»å–æ–‡ä»¶å†…å®¹å¹¶å‘é€ç»™å®¢æˆ·ç«¯ã€‚

- **åŠ¨æ€å†…å®¹ (Dynamic Content)**ï¼š
  - ä¸å­˜å‚¨ä¸ºå›ºå®šæ–‡ä»¶ï¼Œè€Œæ˜¯æœåŠ¡å™¨è¿è¡ŒæŸä¸ª**å¯æ‰§è¡Œç¨‹åº**å®æ—¶ç”Ÿæˆã€‚
  - é€šå¸¸é€šè¿‡ **CGIï¼ˆCommon Gateway Interfaceï¼‰** ç­‰æœºåˆ¶å®ç°ã€‚
  - è¯·æ±‚ä¸­çš„å‚æ•°ç»ç”± URL æˆ–å…¶ä»–æ–¹å¼ä¼ å…¥ç¨‹åºã€‚

---

## ä¸ƒã€TINY Web æœåŠ¡å™¨ä¸ CGI

TINY æ˜¯ä¸€ä¸ªæ•™å­¦ç”¨çš„æç®€ HTTP/1.0 Web æœåŠ¡å™¨ï¼Œä½†å…¶ç»“æ„å·²ç»æ¶µç›–äº†çœŸå® Web æœåŠ¡å™¨çš„æ ¸å¿ƒã€‚

### 1. å¤„ç†é™æ€å†…å®¹

- å¯¹è¯·æ±‚çš„ URI è§£æå‡ºæ–‡ä»¶è·¯å¾„ï¼Œåœ¨ç£ç›˜ä¸Šæ‰“å¼€è¯¥æ–‡ä»¶ã€‚
- ä¸ºæé«˜æ•ˆç‡ï¼ŒTINY ä¸é‡‡ç”¨ä¼ ç»Ÿï¼š
  - `read`(ç£ç›˜â†’ç”¨æˆ·ç¼“å†²åŒº)
  - å† `write`(ç”¨æˆ·ç¼“å†²åŒºâ†’å†…æ ¸ socket ç¼“å†²åŒº)

- è€Œæ˜¯é€šè¿‡ **`mmap` æ–‡ä»¶æ˜ å°„**ï¼š
  - å°†ç£ç›˜æ–‡ä»¶ç›´æ¥æ˜ å°„åˆ°è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ã€‚
  - éšåè°ƒç”¨ `rio_writen` ç›´æ¥å°†è¯¥æ˜ å°„åŒºåŸŸçš„å†…å®¹å†™åˆ° socketã€‚
  - è¿™æ ·å‡å°‘äº†ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´çš„æ•°æ®æ‹·è´æ¬¡æ•°ã€‚

- ä½¿ç”¨å®Œæ¯•åå¿…é¡»è°ƒç”¨ `munmap` è§£é™¤æ˜ å°„ï¼Œå¦åˆ™ä¼šé€ æˆä¸¥é‡å†…å­˜æ³„æ¼ã€‚

### 2. å¤„ç†åŠ¨æ€å†…å®¹ï¼ˆCGIï¼‰

#### 2.1 å‚æ•°ä¼ é€’

- URI ç¤ºä¾‹ï¼š`/cgi-bin/adder?15000&213`
  - æœåŠ¡å™¨å°† `?` åé¢çš„éƒ¨åˆ†å½“ä½œå‚æ•°å­—ç¬¦ä¸²ã€‚

- æœåŠ¡å™¨è§£æ URIï¼Œæå–å‚æ•°ä¸²ï¼Œå°†å…¶å†™å…¥ç¯å¢ƒå˜é‡ `QUERY_STRING`ï¼š
  - `setenv("QUERY_STRING", param, 1);`

#### 2.2 å­è¿›ç¨‹æ‰§è¡Œæµç¨‹

1. **Fork**
   - æœåŠ¡å™¨é€šè¿‡ `fork()` åˆ›å»ºå­è¿›ç¨‹ã€‚

2. **è¾“å‡ºé‡å®šå‘**
   - å­è¿›ç¨‹è°ƒç”¨ï¼š

     ```c
     dup2(connfd, STDOUT_FILENO);
     ```

   - è¿™æ ·ï¼Œå­è¿›ç¨‹å¯¹ `stdout` çš„æ‰€æœ‰è¾“å‡ºï¼ˆåŒ…æ‹¬ `printf`ï¼‰éƒ½ä¼šç›´æ¥å†™å…¥å®¢æˆ·ç«¯çš„ socketã€‚

3. **Execve**
   - å­è¿›ç¨‹è°ƒç”¨ `execve` æ‰§è¡Œ CGI ç¨‹åºï¼ˆä¾‹å¦‚ `adder`ï¼‰ã€‚
   - CGI ç¨‹åºæœ¬èº«**ä¸éœ€è¦**äº†è§£ Socketã€TCPã€HTTP ç­‰ç»†èŠ‚ï¼š
     - å®ƒè¯»å–ç¯å¢ƒå˜é‡ï¼ˆå¦‚ `QUERY_STRING`ï¼‰ã€‚
     - å°†è¾“å‡ºå†™åˆ°æ ‡å‡†è¾“å‡º `stdout`ã€‚

   - è¾“å‡ºä¸­åº”åŒ…å«å¿…è¦çš„ HTTP å“åº”å¤´ï¼ˆå¦‚ `Content-type`ã€`Content-length` ç­‰ï¼‰ä»¥åŠä¸»ä½“å†…å®¹ã€‚

4. **çˆ¶è¿›ç¨‹å›æ”¶å­è¿›ç¨‹**
   - çˆ¶è¿›ç¨‹åœ¨ `wait` ä¸Šé˜»å¡ï¼Œç­‰å¾…å­è¿›ç¨‹ç»“æŸå¹¶å›æ”¶å…¶èµ„æºã€‚
   - é˜²æ­¢äº§ç”Ÿ**åƒµå°¸è¿›ç¨‹ (Zombie Process)**ã€‚

### 3. é”™è¯¯å¤„ç†ä¸å¥å£®æ€§ï¼šEPIPE ä¸ SIGPIPE

- å½“å®¢æˆ·ç«¯è¿‡æ—©å…³é—­è¿æ¥ï¼ˆä¾‹å¦‚ç”¨æˆ·ç‚¹å‡»æµè§ˆå™¨çš„â€œåœæ­¢â€ï¼‰ï¼Œè€ŒæœåŠ¡å™¨ä»å°è¯•å¯¹è¯¥ socket å†™æ•°æ®ï¼š
  - å†…æ ¸ä¼šå‘æœåŠ¡å™¨è¿›ç¨‹å‘é€ **SIGPIPE ä¿¡å·**ã€‚
  - é»˜è®¤è¡Œä¸ºï¼šç›´æ¥ç»ˆæ­¢è¿›ç¨‹ï¼Œä¼šå¯¼è‡´æ•´ä¸ªæœåŠ¡å™¨å´©æºƒã€‚

- åŒæ—¶ï¼Œå¯¹è¯¥ socket çš„å†™æ“ä½œå¯èƒ½è¿”å›é”™è¯¯ç  **EPIPE**ã€‚
- ç”Ÿäº§çº§æœåŠ¡å™¨å¿…é¡»ï¼š
  - æ˜¾å¼**æ•è·æˆ–å¿½ç•¥ SIGPIPE**ï¼Œé¿å…æ•´ä¸ªè¿›ç¨‹é€€å‡ºã€‚
  - æ£€æŸ¥ `write`ã€`rio_writen` ç­‰çš„è¿”å›å€¼ï¼Œä¸€æ—¦å‘ç° EPIPEï¼Œä¼˜é›…åœ°ç»“æŸå½“å‰è¿æ¥ï¼Œè€Œä¸æ˜¯è®©æœåŠ¡å™¨å´©æºƒã€‚

---

## å…«ã€å¤‡è€ƒä¸å¤ä¹ é‡ç‚¹å°ç»“

1. **å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨çš„ Socket è°ƒç”¨é¡ºåº**
   - å®¢æˆ·ç«¯ï¼š`getaddrinfo â†’ socket â†’ connect â†’ read/write â†’ close`
   - æœåŠ¡å™¨ï¼š`getaddrinfo(AI_PASSIVE) â†’ socket â†’ setsockopt(SO_REUSEADDR) â†’ bind â†’ listen â†’ å¾ªç¯{ accept â†’ read/write â†’ close(connfd) }`

2. **ç›‘å¬æè¿°ç¬¦ vs å·²è¿æ¥æè¿°ç¬¦**
   - `listenfd`ï¼šåªç”¨æ¥æ¥æ”¶æ–°è¿æ¥ï¼Œè¯·æ±‚ä¸€ç”Ÿä¸­é€šå¸¸åªåˆ›å»ºä¸€æ¬¡ã€‚
     - å‰å°
   - `connfd`ï¼šæ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥ä¸€ä¸ªï¼Œç”¨äºä¸è¯¥å®¢æˆ·ç«¯é€šä¿¡ï¼Œç”¨å®Œå°±å…³ã€‚
     - å®é™…æœåŠ¡äººå‘˜
3. **getaddrinfo çš„ä¼˜åŠ¿**
   - åè®®æ— å…³ï¼ˆæ”¯æŒ IPv4/IPv6ï¼‰ï¼Œå¯é‡å…¥ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰ã€‚
   - ä¸ `addrinfo` é“¾è¡¨é…åˆï¼Œèƒ½ç›´æ¥ç»™ `socket / bind / connect` ä½¿ç”¨ã€‚

4. **CGI æ ¸å¿ƒæœºåˆ¶**
   - URI å‚æ•° â†’ `QUERY_STRING` ç¯å¢ƒå˜é‡ã€‚
   - `fork` æ´¾ç”Ÿå­è¿›ç¨‹ â†’ åœ¨å­è¿›ç¨‹ä¸­ `dup2(connfd, STDOUT_FILENO)` â†’ `execve` CGI ç¨‹åºã€‚
   - CGI ç¨‹åºåªå…³å¿ƒâ€œæ ‡å‡†è¾“å…¥/æ ‡å‡†è¾“å‡º + ç¯å¢ƒå˜é‡â€ï¼Œä¸å…³å¿ƒ Socket ç»†èŠ‚ã€‚
5. **ç½‘ç»œå­—èŠ‚åºä¸ç»“æ„ä½“å­—æ®µ**
   - IP åœ°å€å’Œç«¯å£å·å¿…é¡»ç”¨**ç½‘ç»œå­—èŠ‚åº**å­˜å‚¨åœ¨ `struct in_addr`ã€`sockaddr_in` ä¸­ã€‚
   - é€šè¿‡ `htonl/htons` ä¸ `ntohl/ntohs` åšè½¬æ¢ï¼Œé¿å…å¤§å°ç«¯é™·é˜±ã€‚

6. **ç½‘ç»œåŸºç¡€çŸ¥è¯†**
   - äº”å±‚åè®®æ ˆåŠæ¯å±‚å…¸å‹åè®®ã€æ•°æ®å•å…ƒåç§°ã€‚
   - åˆ†ç»„äº¤æ¢ vs ç”µè·¯äº¤æ¢çš„å·®å¼‚ã€‚
   - å››ç§å»¶è¿Ÿï¼ˆå¤„ç†ã€æ’é˜Ÿã€ä¼ è¾“ã€ä¼ æ’­ï¼‰å’Œååé‡ã€ç“¶é¢ˆé“¾è·¯æ¦‚å¿µã€‚
   - æ— çº¿ç½‘ç»œç‰¹æ€§ã€ç§»åŠ¨æ€§å¯¹ TCP çš„å½±å“ã€‚
   - å¸¸è§å®‰å…¨å¨èƒï¼ˆMalwareã€Sniffingã€IP Spoofingã€DoS/DDoSï¼‰ä¸é˜²å¾¡æ‰‹æ®µï¼ˆè®¤è¯ã€åŠ å¯†ã€å®Œæ•´æ€§ã€é˜²ç«å¢™ã€VPNã€IDSï¼‰ã€‚
